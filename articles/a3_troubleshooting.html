<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en-GB">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Troubleshooting models that fail • tidysdm</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Troubleshooting models that fail">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">tidysdm</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="Released version">1.0.0</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles">
<li><a class="dropdown-item" href="../articles/a0_tidysdm_overview.html">tidysdm overview</a></li>
    <li><a class="dropdown-item" href="../articles/a1_palaeodata_application.html">Application with palaeodata</a></li>
    <li><a class="dropdown-item" href="../articles/a2_tidymodels_additions.html">Examples of additional tidymodels features</a></li>
    <li><a class="dropdown-item" href="../articles/a3_troubleshooting.html">Troubleshooting models that fail</a></li>
  </ul>
</li>
<li class="nav-item"><a class="nav-link" href="../news/index.html">Changelog</a></li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/EvolEcolGroup/tidysdm/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="../logo.png" class="logo" alt=""><h1>Troubleshooting models that fail</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/EvolEcolGroup/tidysdm/blob/main/vignettes/a3_troubleshooting.Rmd" class="external-link"><code>vignettes/a3_troubleshooting.Rmd</code></a></small>
      <div class="d-none name"><code>a3_troubleshooting.Rmd</code></div>
    </div>

    
    
<p>In this vignette, we illustrate how to troubleshoot tuning errors.
This is not a comprehensive list (yet), but rather an attempt to
illustrate how an error can be approached.</p>
<div class="section level2">
<h2 id="nas-in-the-data">NAs in the data<a class="anchor" aria-label="anchor" href="#nas-in-the-data"></a>
</h2>
<p>Several algorithms do not allow NAs. We can generate a problematic
dataset by loading the <em>Lacerta</em> dataset, and manually add an
NA:</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/EvolEcolGroup/tidysdm" class="external-link">tidysdm</a></span><span class="op">)</span></span>
<span><span class="co">#&gt; Loading required package: tidymodels</span></span>
<span><span class="co">#&gt; ── <span style="font-weight: bold;">Attaching packages</span> ────────────────────────────────────── tidymodels 1.3.0 ──</span></span>
<span><span class="co">#&gt; <span style="color: #00BB00;">✔</span> <span style="color: #0000BB;">broom       </span> 1.0.8     <span style="color: #00BB00;">✔</span> <span style="color: #0000BB;">recipes     </span> 1.3.0</span></span>
<span><span class="co">#&gt; <span style="color: #00BB00;">✔</span> <span style="color: #0000BB;">dials       </span> 1.4.0     <span style="color: #00BB00;">✔</span> <span style="color: #0000BB;">rsample     </span> 1.3.0</span></span>
<span><span class="co">#&gt; <span style="color: #00BB00;">✔</span> <span style="color: #0000BB;">dplyr       </span> 1.1.4     <span style="color: #00BB00;">✔</span> <span style="color: #0000BB;">tibble      </span> 3.2.1</span></span>
<span><span class="co">#&gt; <span style="color: #00BB00;">✔</span> <span style="color: #0000BB;">ggplot2     </span> 3.5.2     <span style="color: #00BB00;">✔</span> <span style="color: #0000BB;">tidyr       </span> 1.3.1</span></span>
<span><span class="co">#&gt; <span style="color: #00BB00;">✔</span> <span style="color: #0000BB;">infer       </span> 1.0.8     <span style="color: #00BB00;">✔</span> <span style="color: #0000BB;">tune        </span> 1.3.0</span></span>
<span><span class="co">#&gt; <span style="color: #00BB00;">✔</span> <span style="color: #0000BB;">modeldata   </span> 1.4.0     <span style="color: #00BB00;">✔</span> <span style="color: #0000BB;">workflows   </span> 1.2.0</span></span>
<span><span class="co">#&gt; <span style="color: #00BB00;">✔</span> <span style="color: #0000BB;">parsnip     </span> 1.3.1     <span style="color: #00BB00;">✔</span> <span style="color: #0000BB;">workflowsets</span> 1.1.0</span></span>
<span><span class="co">#&gt; <span style="color: #00BB00;">✔</span> <span style="color: #0000BB;">purrr       </span> 1.0.4     <span style="color: #00BB00;">✔</span> <span style="color: #0000BB;">yardstick   </span> 1.3.2</span></span>
<span><span class="co">#&gt; ── <span style="font-weight: bold;">Conflicts</span> ───────────────────────────────────────── tidymodels_conflicts() ──</span></span>
<span><span class="co">#&gt; <span style="color: #BB0000;">✖</span> <span style="color: #0000BB;">purrr</span>::<span style="color: #00BB00;">discard()</span> masks <span style="color: #0000BB;">scales</span>::discard()</span></span>
<span><span class="co">#&gt; <span style="color: #BB0000;">✖</span> <span style="color: #0000BB;">dplyr</span>::<span style="color: #00BB00;">filter()</span>  masks <span style="color: #0000BB;">stats</span>::filter()</span></span>
<span><span class="co">#&gt; <span style="color: #BB0000;">✖</span> <span style="color: #0000BB;">dplyr</span>::<span style="color: #00BB00;">lag()</span>     masks <span style="color: #0000BB;">stats</span>::lag()</span></span>
<span><span class="co">#&gt; <span style="color: #BB0000;">✖</span> <span style="color: #0000BB;">recipes</span>::<span style="color: #00BB00;">step()</span>  masks <span style="color: #0000BB;">stats</span>::step()</span></span>
<span><span class="co">#&gt; Loading required package: spatialsample</span></span>
<span><span class="va">lacerta_thin</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rspatial.github.io/terra/reference/serialize.html" class="external-link">readRDS</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/system.file.html" class="external-link">system.file</a></span><span class="op">(</span><span class="st">"extdata/lacerta_thin_all_vars.rds"</span>,</span>
<span>  package <span class="op">=</span> <span class="st">"tidysdm"</span></span>
<span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">lacerta_thin</span><span class="op">$</span><span class="va">bio05</span><span class="op">[</span><span class="fl">37</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="cn">NA</span></span></code></pre></div>
<p>Let us set up a recipe and fit workflow_set</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">lacerta_rec</span> <span class="op">&lt;-</span> <span class="fu">recipe</span><span class="op">(</span><span class="va">lacerta_thin</span>, formula <span class="op">=</span> <span class="va">class</span> <span class="op">~</span> <span class="va">.</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu">step_rm</span><span class="op">(</span><span class="fu"><a href="https://tidyselect.r-lib.org/reference/all_of.html" class="external-link">all_of</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span></span>
<span>    <span class="st">"bio01"</span>, <span class="st">"bio02"</span>, <span class="st">"bio03"</span>, <span class="st">"bio04"</span>, <span class="st">"bio07"</span>, <span class="st">"bio08"</span>,</span>
<span>    <span class="st">"bio09"</span>, <span class="st">"bio10"</span>, <span class="st">"bio11"</span>, <span class="st">"bio12"</span>, <span class="st">"bio14"</span>, <span class="st">"bio16"</span>,</span>
<span>    <span class="st">"bio17"</span>, <span class="st">"bio18"</span>, <span class="st">"bio19"</span>, <span class="st">"altitude"</span></span>
<span>  <span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">lacerta_models</span> <span class="op">&lt;-</span></span>
<span>  <span class="co"># create the workflow_set</span></span>
<span>  <span class="fu">workflow_set</span><span class="op">(</span></span>
<span>    preproc <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>default <span class="op">=</span> <span class="va">lacerta_rec</span><span class="op">)</span>,</span>
<span>    models <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>      <span class="co"># the standard glm specs</span></span>
<span>      glm <span class="op">=</span> <span class="fu"><a href="../reference/sdm_spec_glm.html">sdm_spec_glm</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>      <span class="co"># maxent specs with tuning</span></span>
<span>      maxent <span class="op">=</span> <span class="fu"><a href="../reference/sdm_spec_maxent.html">sdm_spec_maxent</a></span><span class="op">(</span><span class="op">)</span></span>
<span>    <span class="op">)</span>,</span>
<span>    <span class="co"># make all combinations of preproc and models,</span></span>
<span>    cross <span class="op">=</span> <span class="cn">TRUE</span></span>
<span>  <span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="co"># tweak controls to store information needed later to create the ensemble</span></span>
<span>  <span class="fu">option_add</span><span class="op">(</span>control <span class="op">=</span> <span class="fu"><a href="../reference/control_ensemble.html">control_ensemble_grid</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">100</span><span class="op">)</span></span>
<span><span class="va">lacerta_cv</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://spatialsample.tidymodels.org/reference/spatial_block_cv.html" class="external-link">spatial_block_cv</a></span><span class="op">(</span><span class="va">lacerta_thin</span>, v <span class="op">=</span> <span class="fl">5</span><span class="op">)</span></span>
<span><span class="va">lacerta_models</span> <span class="op">&lt;-</span></span>
<span>  <span class="va">lacerta_models</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu">workflow_map</span><span class="op">(</span><span class="st">"tune_grid"</span>,</span>
<span>    resamples <span class="op">=</span> <span class="va">lacerta_cv</span>, grid <span class="op">=</span> <span class="fl">3</span>,</span>
<span>    metrics <span class="op">=</span> <span class="fu"><a href="../reference/sdm_metric_set.html">sdm_metric_set</a></span><span class="op">(</span><span class="op">)</span>, verbose <span class="op">=</span> <span class="cn">TRUE</span></span>
<span>  <span class="op">)</span></span>
<span><span class="co">#&gt; Warning: Using `all_of()` outside of a selecting function was deprecated in tidyselect</span></span>
<span><span class="co">#&gt; 1.2.0.</span></span>
<span><span class="co">#&gt; <span style="color: #00BBBB;">ℹ</span> See details at</span></span>
<span><span class="co">#&gt;   &lt;https://tidyselect.r-lib.org/reference/faq-selection-context.html&gt;</span></span>
<span><span class="co">#&gt; <span style="color: #555555;">This warning is displayed once every 8 hours.</span></span></span>
<span><span class="co">#&gt; <span style="color: #555555;">Call `lifecycle::last_lifecycle_warnings()` to see where this warning was</span></span></span>
<span><span class="co">#&gt; <span style="color: #555555;">generated.</span></span></span>
<span><span class="co">#&gt; <span style="color: #0000BB;">i</span>  <span style="color: #000000;">No tuning parameters. `fit_resamples()` will be attempted</span></span></span>
<span><span class="co">#&gt; <span style="color: #0000BB;">i</span> <span style="color: #000000;">1 of 2 resampling: default_glm</span></span></span>
<span><span class="co">#&gt; <span style="color: #00BB00;">✔</span> <span style="color: #000000;">1 of 2 resampling: default_glm (357ms)</span></span></span>
<span><span class="co">#&gt; <span style="color: #0000BB;">i</span> <span style="color: #000000;">2 of 2 tuning:     default_maxent</span></span></span>
<span><span class="co">#&gt; → <span style="color: #BB0000; font-weight: bold;">A</span> | <span style="color: #BB0000;">error</span>:   NA values in data table. Please remove them and rerun.</span></span>
<span><span class="co">#&gt; There were issues with some computations   <span style="color: #BB0000; font-weight: bold;">A</span>: x1</span></span>
<span><span class="co">#&gt; → <span style="color: #BB0000; font-weight: bold;">B</span> | <span style="color: #BB0000;">error</span>:   Assigned data `orig_rows` must be compatible with existing data.</span></span>
<span><span class="co">#&gt;                <span style="color: #BB0000;">✖</span> Existing data has 87 rows.</span></span>
<span><span class="co">#&gt;                <span style="color: #BB0000;">✖</span> Assigned data has 88 rows.</span></span>
<span><span class="co">#&gt;                <span style="color: #00BBBB;">ℹ</span> Only vectors of size 1 are recycled.</span></span>
<span><span class="co">#&gt;                <span style="font-weight: bold;">Caused by error in `vectbl_recycle_rhs_rows()`:</span></span></span>
<span><span class="co">#&gt;                <span style="color: #BBBB00;">!</span> Can't recycle input of size 88 to size 87.</span></span>
<span><span class="co">#&gt; There were issues with some computations   <span style="color: #BB0000; font-weight: bold;">A</span>: x1There were issues with some computations   <span style="color: #BB0000; font-weight: bold;">A</span>: x12   <span style="color: #BB0000; font-weight: bold;">B</span>: x3</span></span>
<span><span class="co">#&gt; Warning: All models failed. Run `show_notes(.Last.tune.result)` for more</span></span>
<span><span class="co">#&gt; information.</span></span>
<span><span class="co">#&gt; Warning: Unknown or uninitialised column: `.notes`.</span></span>
<span><span class="co">#&gt; <span style="color: #BB0000;">✖</span> <span style="color: #000000;">2 of 2 tuning:     default_maxent failed with </span></span></span></code></pre></div>
<p>We can see that the error for maxent is self-explanatory. Also, note
that the error impacts all data splits (technically, <code>rset</code>
objects): error A is repeated 12 times (4 splits for 3 hyperparameter
values; one split would have the NA in the testing set, which does not
cause an error in this case).</p>
<p>Prepping the recipe (which trains it on the dataset) can help
diagnosing problems:</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">lacerta_prep</span> <span class="op">&lt;-</span> <span class="va">lacerta_rec</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> <span class="fu">prep</span><span class="op">(</span><span class="va">lacerta_thin</span><span class="op">)</span></span>
<span><span class="co">#&gt; Warning: The `strings_as_factors` argument of `prep.recipe()` is deprecated as of</span></span>
<span><span class="co">#&gt; recipes 1.3.0.</span></span>
<span><span class="co">#&gt; <span style="color: #00BBBB;">ℹ</span> Please use the `strings_as_factors` argument of `recipe()` instead.</span></span>
<span><span class="co">#&gt; <span style="color: #555555;">This warning is displayed once every 8 hours.</span></span></span>
<span><span class="co">#&gt; <span style="color: #555555;">Call `lifecycle::last_lifecycle_warnings()` to see where this warning was</span></span></span>
<span><span class="co">#&gt; <span style="color: #555555;">generated.</span></span></span>
<span><span class="va">lacerta_prep</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; <span style="color: #00BBBB;">──</span> <span style="font-weight: bold;">Recipe</span> <span style="color: #00BBBB;">──────────────────────────────────────────────────────────────────────</span></span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; ── Inputs</span></span>
<span><span class="co">#&gt; Number of variables by role</span></span>
<span><span class="co">#&gt; outcome:    1</span></span>
<span><span class="co">#&gt; predictor: 20</span></span>
<span><span class="co">#&gt; coords:     2</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; ── Training information</span></span>
<span><span class="co">#&gt; Training data contained 448 data points and 1 incomplete row.</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; ── Operations</span></span>
<span><span class="co">#&gt; <span style="color: #00BBBB;">•</span> Variables removed: <span style="color: #0000BB;">bio01</span>, <span style="color: #0000BB;">bio02</span>, <span style="color: #0000BB;">bio03</span>, <span style="color: #0000BB;">bio04</span>, <span style="color: #0000BB;">bio07</span>, <span style="color: #0000BB;">bio08</span>, ... | <span style="font-style: italic;">Trained</span></span></span></code></pre></div>
<p>Note that, in the training information, we were warned that 1 row was
incomplete. You could use <code>step_naomit</code> to deal with this
programmatically, or ascertain why you are generating missing data (we
prefer the latter, as a good SDM pipeline should not generate
observations, presences or pseudoabsences, with missing data).</p>
</div>
<div class="section level2">
<h2 id="recipes-and-the-response-variable">Recipes and the response variable<a class="anchor" aria-label="anchor" href="#recipes-and-the-response-variable"></a>
</h2>
<p>The response variable is treated in a special way in
<code>recipes</code>, and this can lead to problems. It is best not to
manipulate (e.g. transform character into factor) the response variable
in a recipe, since that response variable will only be available when we
train and test models, but not when we make projections. If we
hard-coded a step in a recipe that includes the response variable, the
model will fit, but then it will fail when we start making
predictions.</p>
<p>Another potential mistake is to remove the response variable when
selecting variables of interest. This can happen if we use
<code>step_select</code> to choose variables of interest
(<strong>Note</strong> that <code>step_select()</code> is now deprecated
in <code>recipes</code>; so it is best avoided), and the error is less
than clear:</p>
<p>Let’s load the data and create a recipe with
<code>step_select</code>:</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">lacerta_thin</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rspatial.github.io/terra/reference/serialize.html" class="external-link">readRDS</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/system.file.html" class="external-link">system.file</a></span><span class="op">(</span><span class="st">"extdata/lacerta_thin_all_vars.rds"</span>,</span>
<span>  package <span class="op">=</span> <span class="st">"tidysdm"</span></span>
<span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">suggested_vars</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"bio05"</span>, <span class="st">"bio06"</span>, <span class="st">"bio13"</span>, <span class="st">"bio14"</span>, <span class="st">"bio15"</span><span class="op">)</span></span>
<span><span class="va">lacerta_rec_sel</span> <span class="op">&lt;-</span> <span class="fu">recipe</span><span class="op">(</span><span class="va">lacerta_thin</span>, formula <span class="op">=</span> <span class="va">class</span> <span class="op">~</span> <span class="va">.</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu">step_select</span><span class="op">(</span><span class="fu"><a href="https://tidyselect.r-lib.org/reference/all_of.html" class="external-link">all_of</a></span><span class="op">(</span><span class="va">suggested_vars</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; Warning: `step_select()` was deprecated in recipes 1.3.0.</span></span>
<span><span class="co">#&gt; <span style="color: #00BBBB;">ℹ</span> See `?select_select()` for recommended alternatives.</span></span>
<span><span class="co">#&gt; <span style="color: #555555;">This warning is displayed once every 8 hours.</span></span></span>
<span><span class="co">#&gt; <span style="color: #555555;">Call `lifecycle::last_lifecycle_warnings()` to see where this warning was</span></span></span>
<span><span class="co">#&gt; <span style="color: #555555;">generated.</span></span></span></code></pre></div>
<p>Now we create the workflow set and fit it:</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">lacerta_models</span> <span class="op">&lt;-</span></span>
<span>  <span class="co"># create the workflow_set</span></span>
<span>  <span class="fu">workflow_set</span><span class="op">(</span></span>
<span>    preproc <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>default <span class="op">=</span> <span class="va">lacerta_rec_sel</span><span class="op">)</span>,</span>
<span>    models <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>      <span class="co"># the standard glm specs</span></span>
<span>      glm <span class="op">=</span> <span class="fu"><a href="../reference/sdm_spec_glm.html">sdm_spec_glm</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>      <span class="co"># rf specs with tuning</span></span>
<span>      rf <span class="op">=</span> <span class="fu"><a href="../reference/sdm_spec_rand_forest.html">sdm_spec_rf</a></span><span class="op">(</span><span class="op">)</span></span>
<span>    <span class="op">)</span>,</span>
<span>    <span class="co"># make all combinations of preproc and models,</span></span>
<span>    cross <span class="op">=</span> <span class="cn">TRUE</span></span>
<span>  <span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="co"># tweak controls to store information needed later to create the ensemble</span></span>
<span>  <span class="fu">option_add</span><span class="op">(</span>control <span class="op">=</span> <span class="fu"><a href="../reference/control_ensemble.html">control_ensemble_grid</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">100</span><span class="op">)</span></span>
<span><span class="va">lacerta_cv</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://spatialsample.tidymodels.org/reference/spatial_block_cv.html" class="external-link">spatial_block_cv</a></span><span class="op">(</span><span class="va">lacerta_thin</span>, v <span class="op">=</span> <span class="fl">5</span><span class="op">)</span></span>
<span><span class="va">lacerta_models</span> <span class="op">&lt;-</span></span>
<span>  <span class="va">lacerta_models</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu">workflow_map</span><span class="op">(</span><span class="st">"tune_grid"</span>,</span>
<span>    resamples <span class="op">=</span> <span class="va">lacerta_cv</span>, grid <span class="op">=</span> <span class="fl">3</span>,</span>
<span>    metrics <span class="op">=</span> <span class="fu"><a href="../reference/sdm_metric_set.html">sdm_metric_set</a></span><span class="op">(</span><span class="op">)</span>, verbose <span class="op">=</span> <span class="cn">TRUE</span></span>
<span>  <span class="op">)</span></span>
<span><span class="co">#&gt; <span style="color: #0000BB;">i</span>  <span style="color: #000000;">No tuning parameters. `fit_resamples()` will be attempted</span></span></span>
<span><span class="co">#&gt; <span style="color: #0000BB;">i</span> <span style="color: #000000;">1 of 2 resampling: default_glm</span></span></span>
<span><span class="co">#&gt; → <span style="color: #BB0000; font-weight: bold;">A</span> | <span style="color: #BB0000;">error</span>:   <span style="color: #BBBB00;">!</span> `logistic_reg()` was unable to find an outcome.</span></span>
<span><span class="co">#&gt;                <span style="color: #00BBBB;">ℹ</span> Ensure that you have specified an outcome column and that it hasn't been</span></span>
<span><span class="co">#&gt;                  removed in pre-processing.</span></span>
<span><span class="co">#&gt; There were issues with some computations   <span style="color: #BB0000; font-weight: bold;">A</span>: x1</span></span>
<span><span class="co">#&gt; There were issues with some computations   <span style="color: #BB0000; font-weight: bold;">A</span>: x5</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Warning: All models failed. Run `show_notes(.Last.tune.result)` for more</span></span>
<span><span class="co">#&gt; information.</span></span>
<span><span class="co">#&gt; Warning: Unknown or uninitialised column: `.notes`.</span></span>
<span><span class="co">#&gt; <span style="color: #BB0000;">✖</span> <span style="color: #000000;">1 of 2 resampling: default_glm failed with </span></span></span>
<span><span class="co">#&gt; <span style="color: #0000BB;">i</span> <span style="color: #000000;">2 of 2 tuning:     default_rf</span></span></span>
<span><span class="co">#&gt; <span style="color: #0000BB;">i</span> <span style="color: #000000;">Creating pre-processing data to finalize unknown parameter: mtry</span></span></span>
<span><span class="co">#&gt; → <span style="color: #BB0000; font-weight: bold;">A</span> | <span style="color: #BB0000;">error</span>:   <span style="color: #BBBB00;">!</span> `rand_forest()` was unable to find an outcome.</span></span>
<span><span class="co">#&gt;                <span style="color: #00BBBB;">ℹ</span> Ensure that you have specified an outcome column and that it hasn't been</span></span>
<span><span class="co">#&gt;                  removed in pre-processing.</span></span>
<span><span class="co">#&gt; Warning: All models failed. Run `show_notes(.Last.tune.result)` for more information.</span></span>
<span><span class="co">#&gt; Unknown or uninitialised column: `.notes`.</span></span>
<span><span class="co">#&gt; <span style="color: #BB0000;">✖</span> <span style="color: #000000;">2 of 2 tuning:     default_rf failed with </span></span></span></code></pre></div>
<p>The errors are not very intuitive. However, all models have failed
for all algorithms, which suggests that the problem lies with the data
preparation side (either the data themselves, or what we did with the
recipe).</p>
<p>Ideally, you should have already had a look at your data (with
<code>summary</code> or <code>glimpse</code>). So, in this case, we know
that the data are fine. Whilst prepping (and sometimes baking) the
recipe is generally informative for predictor variables, it is hard to
diagnose problems with the outcome variable in a recipe. Prepping will
not show anything obvious:</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">lacerta_prep_sel</span> <span class="op">&lt;-</span> <span class="va">lacerta_rec_sel</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> <span class="fu">prep</span><span class="op">(</span><span class="va">lacerta_thin</span><span class="op">)</span></span>
<span><span class="va">lacerta_prep_sel</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; <span style="color: #00BBBB;">──</span> <span style="font-weight: bold;">Recipe</span> <span style="color: #00BBBB;">──────────────────────────────────────────────────────────────────────</span></span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; ── Inputs</span></span>
<span><span class="co">#&gt; Number of variables by role</span></span>
<span><span class="co">#&gt; outcome:    1</span></span>
<span><span class="co">#&gt; predictor: 20</span></span>
<span><span class="co">#&gt; coords:     2</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; ── Training information</span></span>
<span><span class="co">#&gt; Training data contained 448 data points and no incomplete rows.</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; ── Operations</span></span>
<span><span class="co">#&gt; <span style="color: #00BBBB;">•</span> Variables selected: <span style="color: #0000BB;">bio05</span>, <span style="color: #0000BB;">bio06</span>, <span style="color: #0000BB;">bio13</span>, <span style="color: #0000BB;">bio14</span>, <span style="color: #0000BB;">bio15</span> | <span style="font-style: italic;">Trained</span></span></span></code></pre></div>
<p>In this case, it is a process of exclusion. Everything seems fine,
but the models don’t work. Then ask yourself if the outcome variable
might be problematic. As a general rule, we have found it easier to rely
on <code>step_rm</code> to remove variables (e.g. correlated variables
highlighted by <code><a href="../reference/filter_collinear.html">tidysdm::filter_collinear()</a></code>).</p>
</div>
<div class="section level2">
<h2 id="using-the-desired-formula-with-gam">Using the desired formula with GAM<a class="anchor" aria-label="anchor" href="#using-the-desired-formula-with-gam"></a>
</h2>
<p>General Additive Models have an unusual syntax, as the user has to
define which variables are fitted with splines. <code>tidysdm</code> has
some functions to simplify this process, assuming that the user just
wants to fit a standard smooth to every continuous predictor.</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">lacerta_thin</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rspatial.github.io/terra/reference/serialize.html" class="external-link">readRDS</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/system.file.html" class="external-link">system.file</a></span><span class="op">(</span><span class="st">"extdata/lacerta_thin_all_vars.rds"</span>,</span>
<span>  package <span class="op">=</span> <span class="st">"tidysdm"</span></span>
<span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">lacerta_rec</span> <span class="op">&lt;-</span> <span class="fu">recipe</span><span class="op">(</span><span class="va">lacerta_thin</span>, formula <span class="op">=</span> <span class="va">class</span> <span class="op">~</span> <span class="va">.</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu">step_rm</span><span class="op">(</span><span class="fu"><a href="https://tidyselect.r-lib.org/reference/all_of.html" class="external-link">all_of</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span></span>
<span>    <span class="st">"bio01"</span>, <span class="st">"bio02"</span>, <span class="st">"bio03"</span>, <span class="st">"bio04"</span>, <span class="st">"bio07"</span>, <span class="st">"bio08"</span>,</span>
<span>    <span class="st">"bio09"</span>, <span class="st">"bio10"</span>, <span class="st">"bio11"</span>, <span class="st">"bio12"</span>, <span class="st">"bio14"</span>, <span class="st">"bio16"</span>,</span>
<span>    <span class="st">"bio17"</span>, <span class="st">"bio18"</span>, <span class="st">"bio19"</span>, <span class="st">"altitude"</span></span>
<span>  <span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">lacerta_models</span> <span class="op">&lt;-</span></span>
<span>  <span class="co"># create the workflow_set</span></span>
<span>  <span class="fu">workflow_set</span><span class="op">(</span></span>
<span>    preproc <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>default <span class="op">=</span> <span class="va">lacerta_rec</span><span class="op">)</span>,</span>
<span>    models <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>      <span class="co"># the standard glm specs</span></span>
<span>      glm <span class="op">=</span> <span class="fu"><a href="../reference/sdm_spec_glm.html">sdm_spec_glm</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>      <span class="co"># the standard gam specs</span></span>
<span>      gam <span class="op">=</span> <span class="fu"><a href="../reference/sdm_spec_gam.html">sdm_spec_gam</a></span><span class="op">(</span><span class="op">)</span></span>
<span>    <span class="op">)</span>,</span>
<span>    <span class="co"># make all combinations of preproc and models,</span></span>
<span>    cross <span class="op">=</span> <span class="cn">TRUE</span></span>
<span>  <span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="co"># set formula for gams</span></span>
<span>  <span class="fu">update_workflow_model</span><span class="op">(</span><span class="st">"default_gam"</span>,</span>
<span>    spec <span class="op">=</span> <span class="fu"><a href="../reference/sdm_spec_gam.html">sdm_spec_gam</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>    formula <span class="op">=</span> <span class="fu"><a href="../reference/gam_formula.html">gam_formula</a></span><span class="op">(</span><span class="va">lacerta_rec</span><span class="op">)</span></span>
<span>  <span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="co"># tweak controls to store information needed later to create the ensemble</span></span>
<span>  <span class="fu">option_add</span><span class="op">(</span>control <span class="op">=</span> <span class="fu"><a href="../reference/control_ensemble.html">control_ensemble_grid</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">100</span><span class="op">)</span></span>
<span><span class="va">lacerta_cv</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://spatialsample.tidymodels.org/reference/spatial_block_cv.html" class="external-link">spatial_block_cv</a></span><span class="op">(</span><span class="va">lacerta_thin</span>, v <span class="op">=</span> <span class="fl">5</span><span class="op">)</span></span>
<span><span class="va">lacerta_models</span> <span class="op">&lt;-</span></span>
<span>  <span class="va">lacerta_models</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu">workflow_map</span><span class="op">(</span><span class="st">"tune_grid"</span>,</span>
<span>    resamples <span class="op">=</span> <span class="va">lacerta_cv</span>, grid <span class="op">=</span> <span class="fl">3</span>,</span>
<span>    metrics <span class="op">=</span> <span class="fu"><a href="../reference/sdm_metric_set.html">sdm_metric_set</a></span><span class="op">(</span><span class="op">)</span>, verbose <span class="op">=</span> <span class="cn">TRUE</span></span>
<span>  <span class="op">)</span></span>
<span><span class="co">#&gt; <span style="color: #0000BB;">i</span>  <span style="color: #000000;">No tuning parameters. `fit_resamples()` will be attempted</span></span></span>
<span><span class="co">#&gt; <span style="color: #0000BB;">i</span> <span style="color: #000000;">1 of 2 resampling: default_glm</span></span></span>
<span><span class="co">#&gt; <span style="color: #00BB00;">✔</span> <span style="color: #000000;">1 of 2 resampling: default_glm (302ms)</span></span></span>
<span><span class="co">#&gt; <span style="color: #0000BB;">i</span>  <span style="color: #000000;">No tuning parameters. `fit_resamples()` will be attempted</span></span></span>
<span><span class="co">#&gt; <span style="color: #0000BB;">i</span> <span style="color: #000000;">2 of 2 resampling: default_gam</span></span></span>
<span><span class="co">#&gt; <span style="color: #00BB00;">✔</span> <span style="color: #000000;">2 of 2 resampling: default_gam (716ms)</span></span></span></code></pre></div>
<p>Note that the step of defining a formula is incompatible with using
<code>step_cor</code> in a recipe. <code>step_cor</code> removes
correlated variables in recipes, using a similar algorithm to
<code>filter_collinear</code> using method <code>cor_caret</code>.
However, the algorithm is fitted to each data split when
cross-validating. This means that different variables will eventually be
presented to the model when it is fitted for each split, leading to an
error as there will be a mismatch between the formula and the available
variables. This is a known issue of how GAMs are implemented in
<code>tidymodels</code>.</p>
</div>
<div class="section level2">
<h2 id="when-only-some-splits-fail">When only some splits fail<a class="anchor" aria-label="anchor" href="#when-only-some-splits-fail"></a>
</h2>
<p>In the examples above, all the splits used for cross-validation of a
given algorithms failed. However, it is also possible that failures
occur only on some splits for certain algorithms (technically, a
specific <code>rsplit</code> within certain <code>workflows</code>).
When this type of problem occurs, it is best to extract the problematic
workflow, and potentially investigate fitting it to the specific
<code>rsplit</code>.</p>
<p>We generate a problematic dataset by subsampling the lacerta
dataset:</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">lacerta_thin</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rspatial.github.io/terra/reference/serialize.html" class="external-link">readRDS</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/system.file.html" class="external-link">system.file</a></span><span class="op">(</span><span class="st">"extdata/lacerta_thin_all_vars.rds"</span>,</span>
<span>  package <span class="op">=</span> <span class="st">"tidysdm"</span></span>
<span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">123</span><span class="op">)</span></span>
<span><span class="va">lacerta_thin</span> <span class="op">&lt;-</span> <span class="va">lacerta_thin</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/sample.html" class="external-link">sample</a></span><span class="op">(</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq_len</a></span><span class="op">(</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/dimensions.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">lacerta_thin</span><span class="op">)</span><span class="op">)</span>,</span>
<span>  <span class="fu"><a href="https://rspatial.github.io/terra/reference/dimensions.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">lacerta_thin</span><span class="op">)</span> <span class="op">/</span> <span class="fl">7</span></span>
<span><span class="op">)</span>, <span class="op">]</span></span>
<span></span>
<span><span class="va">lacerta_rec</span> <span class="op">&lt;-</span> <span class="fu">recipe</span><span class="op">(</span><span class="va">lacerta_thin</span>, formula <span class="op">=</span> <span class="va">class</span> <span class="op">~</span> <span class="va">.</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu">step_rm</span><span class="op">(</span><span class="fu"><a href="https://tidyselect.r-lib.org/reference/all_of.html" class="external-link">all_of</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span></span>
<span>    <span class="st">"bio01"</span>, <span class="st">"bio02"</span>, <span class="st">"bio03"</span>, <span class="st">"bio04"</span>, <span class="st">"bio07"</span>, <span class="st">"bio08"</span>,</span>
<span>    <span class="st">"bio09"</span>, <span class="st">"bio10"</span>, <span class="st">"bio11"</span>, <span class="st">"bio12"</span>, <span class="st">"bio14"</span>, <span class="st">"bio16"</span>,</span>
<span>    <span class="st">"bio17"</span>, <span class="st">"bio18"</span>, <span class="st">"bio19"</span>, <span class="st">"altitude"</span></span>
<span>  <span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">lacerta_models</span> <span class="op">&lt;-</span></span>
<span>  <span class="co"># create the workflow_set</span></span>
<span>  <span class="fu">workflow_set</span><span class="op">(</span></span>
<span>    preproc <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>default <span class="op">=</span> <span class="va">lacerta_rec</span><span class="op">)</span>,</span>
<span>    models <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>      <span class="co"># the standard glm specs</span></span>
<span>      glm <span class="op">=</span> <span class="fu"><a href="../reference/sdm_spec_glm.html">sdm_spec_glm</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>      <span class="co"># the standard gam specs</span></span>
<span>      gam <span class="op">=</span> <span class="fu"><a href="../reference/sdm_spec_gam.html">sdm_spec_gam</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>      <span class="co"># rf specs with tuning</span></span>
<span>      rf <span class="op">=</span> <span class="fu"><a href="../reference/sdm_spec_rand_forest.html">sdm_spec_rf</a></span><span class="op">(</span><span class="op">)</span></span>
<span>    <span class="op">)</span>,</span>
<span>    <span class="co"># make all combinations of preproc and models,</span></span>
<span>    cross <span class="op">=</span> <span class="cn">TRUE</span></span>
<span>  <span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="co"># set formula for gams</span></span>
<span>  <span class="fu">update_workflow_model</span><span class="op">(</span><span class="st">"default_gam"</span>,</span>
<span>    spec <span class="op">=</span> <span class="fu"><a href="../reference/sdm_spec_gam.html">sdm_spec_gam</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>    formula <span class="op">=</span> <span class="fu"><a href="../reference/gam_formula.html">gam_formula</a></span><span class="op">(</span><span class="va">lacerta_rec</span><span class="op">)</span></span>
<span>  <span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="co"># tweak controls to store information needed later to create the ensemble</span></span>
<span>  <span class="fu">option_add</span><span class="op">(</span>control <span class="op">=</span> <span class="fu"><a href="../reference/control_ensemble.html">control_ensemble_grid</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>We then create 3 folds and attempt to fit the models:</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">100</span><span class="op">)</span></span>
<span><span class="va">lacerta_cv</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://spatialsample.tidymodels.org/reference/spatial_block_cv.html" class="external-link">spatial_block_cv</a></span><span class="op">(</span><span class="va">lacerta_thin</span>, v <span class="op">=</span> <span class="fl">3</span><span class="op">)</span></span>
<span><span class="va">lacerta_models</span> <span class="op">&lt;-</span></span>
<span>  <span class="va">lacerta_models</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu">workflow_map</span><span class="op">(</span><span class="st">"tune_grid"</span>,</span>
<span>    resamples <span class="op">=</span> <span class="va">lacerta_cv</span>, grid <span class="op">=</span> <span class="fl">3</span>,</span>
<span>    metrics <span class="op">=</span> <span class="fu"><a href="../reference/sdm_metric_set.html">sdm_metric_set</a></span><span class="op">(</span><span class="op">)</span>, verbose <span class="op">=</span> <span class="cn">TRUE</span></span>
<span>  <span class="op">)</span></span>
<span><span class="co">#&gt; <span style="color: #0000BB;">i</span>  <span style="color: #000000;">No tuning parameters. `fit_resamples()` will be attempted</span></span></span>
<span><span class="co">#&gt; <span style="color: #0000BB;">i</span> <span style="color: #000000;">1 of 3 resampling: default_glm</span></span></span>
<span><span class="co">#&gt; <span style="color: #00BB00;">✔</span> <span style="color: #000000;">1 of 3 resampling: default_glm (203ms)</span></span></span>
<span><span class="co">#&gt; <span style="color: #0000BB;">i</span>  <span style="color: #000000;">No tuning parameters. `fit_resamples()` will be attempted</span></span></span>
<span><span class="co">#&gt; <span style="color: #0000BB;">i</span> <span style="color: #000000;">2 of 3 resampling: default_gam</span></span></span>
<span><span class="co">#&gt; → <span style="color: #BBBB00; font-weight: bold;">A</span> | <span style="color: #BBBB00;">warning</span>: Fitting terminated with step failure - check results carefully</span></span>
<span><span class="co">#&gt; There were issues with some computations   <span style="color: #BBBB00; font-weight: bold;">A</span>: x1</span></span>
<span><span class="co">#&gt; There were issues with some computations   <span style="color: #BBBB00; font-weight: bold;">A</span>: x1</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; <span style="color: #00BB00;">✔</span> <span style="color: #000000;">2 of 3 resampling: default_gam (1s)</span></span></span>
<span><span class="co">#&gt; <span style="color: #0000BB;">i</span> <span style="color: #000000;">3 of 3 tuning:     default_rf</span></span></span>
<span><span class="co">#&gt; <span style="color: #0000BB;">i</span> <span style="color: #000000;">Creating pre-processing data to finalize unknown parameter: mtry</span></span></span>
<span><span class="co">#&gt; <span style="color: #00BB00;">✔</span> <span style="color: #000000;">3 of 3 tuning:     default_rf (672ms)</span></span></span></code></pre></div>
<p>We see that one of the folds gives us an error when using GAMs. The
error (“Fitting terminated with step failure - check results carefully”)
comes from the gam function in the package <code>mgcv</code>. A quick
google on StackOverflow[<a href="https://stats.stackexchange.com/questions/576273/gam-model-warning-message-step-failure-in-theta-estimation" class="external-link uri">https://stats.stackexchange.com/questions/576273/gam-model-warning-message-step-failure-in-theta-estimation</a>]
gives us an idea of where this error comes from.</p>
<p>We start by extracting the results of the gam fits:</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">gam_results</span> <span class="op">&lt;-</span> <span class="fu">extract_workflow_set_result</span><span class="op">(</span><span class="va">lacerta_models</span>, id <span class="op">=</span> <span class="st">"default_gam"</span><span class="op">)</span></span>
<span><span class="va">gam_results</span></span>
<span><span class="co">#&gt; # Resampling results</span></span>
<span><span class="co">#&gt; # 3-fold spatial block cross-validation </span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 3 × 5</span></span></span>
<span><span class="co">#&gt;   splits          id    .metrics         .notes           .predictions     </span></span>
<span><span class="co">#&gt;   <span style="color: #949494; font-style: italic;">&lt;list&gt;</span>          <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span> <span style="color: #949494; font-style: italic;">&lt;list&gt;</span>           <span style="color: #949494; font-style: italic;">&lt;list&gt;</span>           <span style="color: #949494; font-style: italic;">&lt;list&gt;</span>           </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">1</span> <span style="color: #949494;">&lt;split [46/18]&gt;</span> Fold1 <span style="color: #949494;">&lt;tibble [3 × 4]&gt;</span> <span style="color: #949494;">&lt;tibble [0 × 3]&gt;</span> <span style="color: #949494;">&lt;tibble [18 × 5]&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">2</span> <span style="color: #949494;">&lt;split [41/23]&gt;</span> Fold2 <span style="color: #949494;">&lt;tibble [3 × 4]&gt;</span> <span style="color: #949494;">&lt;tibble [0 × 3]&gt;</span> <span style="color: #949494;">&lt;tibble [23 × 5]&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">3</span> <span style="color: #949494;">&lt;split [41/23]&gt;</span> Fold3 <span style="color: #949494;">&lt;tibble [3 × 4]&gt;</span> <span style="color: #949494;">&lt;tibble [1 × 3]&gt;</span> <span style="color: #949494;">&lt;tibble [23 × 5]&gt;</span></span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; There were issues with some computations:</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;   - Warning(s) x1: Fitting terminated with step failure - check results carefully</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Run `show_notes(.Last.tune.result)` for more information.</span></span></code></pre></div>
<p>We can</p>
<p>We see that, in the <code>.notes</code> column, the third item is not
empty (it does not have zero rows). We can check that it indeed contains
the error that we wanted:</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">gam_results</span><span class="op">$</span><span class="va">.notes</span></span>
<span><span class="co">#&gt; [[1]]</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 0 × 3</span></span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># ℹ 3 variables: location &lt;chr&gt;, type &lt;chr&gt;, note &lt;chr&gt;</span></span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; [[2]]</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 0 × 3</span></span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># ℹ 3 variables: location &lt;chr&gt;, type &lt;chr&gt;, note &lt;chr&gt;</span></span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; [[3]]</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 1 × 3</span></span></span>
<span><span class="co">#&gt;   location                    type    note                                      </span></span>
<span><span class="co">#&gt;   <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>                       <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>   <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>                                     </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">1</span> preprocessor 1/1, model 1/1 warning Fitting terminated with step failure - ch…</span></span></code></pre></div>
<p>We can now get the problematic data split, and extract the training
data:</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">problem_split</span> <span class="op">&lt;-</span> <span class="va">gam_results</span><span class="op">$</span><span class="va">splits</span><span class="op">[</span><span class="fl">3</span><span class="op">]</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span></span>
<span><span class="fu"><a href="https://rspatial.github.io/terra/reference/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="fu">training</span><span class="op">(</span><span class="va">problem_split</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt;         class             geometry      bio01            bio02       </span></span>
<span><span class="co">#&gt;  presence  :12   POINT        :41   Min.   : 7.757   Min.   : 6.786  </span></span>
<span><span class="co">#&gt;  background:29   epsg:NA      : 0   1st Qu.:13.055   1st Qu.: 8.901  </span></span>
<span><span class="co">#&gt;                  +proj=aea ...: 0   Median :14.198   Median : 9.506  </span></span>
<span><span class="co">#&gt;                                     Mean   :13.902   Mean   : 9.785  </span></span>
<span><span class="co">#&gt;                                     3rd Qu.:15.580   3rd Qu.:10.861  </span></span>
<span><span class="co">#&gt;                                     Max.   :18.111   Max.   :13.009  </span></span>
<span><span class="co">#&gt;      bio03           bio04           bio05           bio06       </span></span>
<span><span class="co">#&gt;  Min.   :36.53   Min.   :328.5   Min.   :21.65   Min.   :-3.143  </span></span>
<span><span class="co">#&gt;  1st Qu.:38.00   1st Qu.:446.1   1st Qu.:24.57   1st Qu.: 2.724  </span></span>
<span><span class="co">#&gt;  Median :39.85   Median :546.6   Median :27.66   Median : 3.597  </span></span>
<span><span class="co">#&gt;  Mean   :40.57   Mean   :522.7   Mean   :27.78   Mean   : 3.488  </span></span>
<span><span class="co">#&gt;  3rd Qu.:42.93   3rd Qu.:579.3   3rd Qu.:30.74   3rd Qu.: 5.085  </span></span>
<span><span class="co">#&gt;  Max.   :46.16   Max.   :721.1   Max.   :34.39   Max.   : 8.134  </span></span>
<span><span class="co">#&gt;      bio07           bio08            bio09           bio10      </span></span>
<span><span class="co">#&gt;  Min.   :16.33   Min.   : 2.534   Min.   :14.81   Min.   :14.95  </span></span>
<span><span class="co">#&gt;  1st Qu.:21.45   1st Qu.: 8.148   1st Qu.:18.43   1st Qu.:19.03  </span></span>
<span><span class="co">#&gt;  Median :24.27   Median : 9.423   Median :19.82   Median :20.94  </span></span>
<span><span class="co">#&gt;  Mean   :24.29   Mean   : 9.631   Mean   :20.38   Mean   :20.70  </span></span>
<span><span class="co">#&gt;  3rd Qu.:27.49   3rd Qu.:11.306   3rd Qu.:22.68   3rd Qu.:22.75  </span></span>
<span><span class="co">#&gt;  Max.   :32.79   Max.   :15.847   Max.   :25.23   Max.   :25.42  </span></span>
<span><span class="co">#&gt;      bio11            bio12            bio13            bio14       </span></span>
<span><span class="co">#&gt;  Min.   : 1.604   Min.   : 450.6   Min.   : 59.80   Min.   : 1.000  </span></span>
<span><span class="co">#&gt;  1st Qu.: 7.109   1st Qu.: 615.5   1st Qu.: 88.01   1st Qu.: 6.005  </span></span>
<span><span class="co">#&gt;  Median : 8.273   Median : 750.2   Median :109.13   Median :14.008  </span></span>
<span><span class="co">#&gt;  Mean   : 7.985   Mean   : 895.4   Mean   :126.04   Mean   :18.392  </span></span>
<span><span class="co">#&gt;  3rd Qu.: 9.433   3rd Qu.:1191.8   3rd Qu.:148.15   3rd Qu.:26.601  </span></span>
<span><span class="co">#&gt;  Max.   :11.852   Max.   :1635.6   Max.   :227.81   Max.   :51.974  </span></span>
<span><span class="co">#&gt;      bio15           bio16           bio17            bio18       </span></span>
<span><span class="co">#&gt;  Min.   :21.49   Min.   :145.1   Min.   : 15.77   Min.   : 22.52  </span></span>
<span><span class="co">#&gt;  1st Qu.:40.18   1st Qu.:254.0   1st Qu.: 38.17   1st Qu.: 42.01  </span></span>
<span><span class="co">#&gt;  Median :52.94   Median :313.2   Median : 75.24   Median : 78.96  </span></span>
<span><span class="co">#&gt;  Mean   :49.48   Mean   :352.9   Mean   : 81.17   Mean   : 90.91  </span></span>
<span><span class="co">#&gt;  3rd Qu.:57.78   3rd Qu.:417.8   3rd Qu.:121.37   3rd Qu.:146.25  </span></span>
<span><span class="co">#&gt;  Max.   :76.74   Max.   :635.7   Max.   :178.73   Max.   :189.18  </span></span>
<span><span class="co">#&gt;      bio19           altitude      </span></span>
<span><span class="co">#&gt;  Min.   : 94.69   Min.   :  30.93  </span></span>
<span><span class="co">#&gt;  1st Qu.:231.06   1st Qu.: 167.04  </span></span>
<span><span class="co">#&gt;  Median :292.31   Median : 392.57  </span></span>
<span><span class="co">#&gt;  Mean   :332.27   Mean   : 480.18  </span></span>
<span><span class="co">#&gt;  3rd Qu.:403.43   3rd Qu.: 582.54  </span></span>
<span><span class="co">#&gt;  Max.   :634.26   Max.   :1686.49</span></span></code></pre></div>
<p>In this case, there is nothing too obvious that leads to the error
(an important check is to make sure that you have enough presences in a
split; too few presences will generally lead to errors; you can use
<code>tidysdm::check_split_balance()</code> to investigate split balance
).</p>
<p>We can now extract the workflow and refit it to the split to confirm
that we have isolated the problem:</p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">gam_workflow</span> <span class="op">&lt;-</span> <span class="fu">extract_workflow</span><span class="op">(</span><span class="va">lacerta_models</span>, id <span class="op">=</span> <span class="st">"default_gam"</span><span class="op">)</span></span>
<span><span class="va">faulty_gam</span> <span class="op">&lt;-</span> <span class="fu">fit</span><span class="op">(</span><span class="va">gam_workflow</span>, <span class="fu">training</span><span class="op">(</span><span class="va">problem_split</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; Warning in newton(lsp = lsp, X = G$X, y = G$y, Eb = G$Eb, UrS = G$UrS, L = G$L,</span></span>
<span><span class="co">#&gt; : Fitting terminated with step failure - check results carefully</span></span></code></pre></div>
<p>The next step would be to dig deeper into the data, trying to
understand whether there are some outliers that are problematic. The
specific steps will depend on the algorithm that is giving problems.
Note that some algorithms, such as GAMs, tend to be fragile with small
datasets.</p>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by Michela Leonardi, Margherita Colucci, Andrea Vittorio Pozzi, Eleanor M.L. Scerri, Andrea Manica.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.2.</p>
</div>

    </footer>
</div>





  </body>
</html>
