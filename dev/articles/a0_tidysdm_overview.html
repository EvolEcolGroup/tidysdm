<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>tidysdm overview • tidysdm</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.4.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.4.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="tidysdm overview">
<meta name="robots" content="noindex">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">tidysdm</a>

    <small class="nav-text text-danger me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="In-development version">0.9.6.9002</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles">
<li><a class="dropdown-item" href="../articles/a0_tidysdm_overview.html">tidysdm overview</a></li>
    <li><a class="dropdown-item" href="../articles/a1_palaeodata_application.html">Application with palaeodata</a></li>
    <li><a class="dropdown-item" href="../articles/a2_tidymodels_additions.html">Examples of additional tidymodels features</a></li>
    <li><a class="dropdown-item" href="../articles/a3_troubleshooting.html">Troubleshooting models that fail</a></li>
  </ul>
</li>
<li class="nav-item"><a class="nav-link" href="../news/index.html">Changelog</a></li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/EvolEcolGroup/tidysdm/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="../logo.png" class="logo" alt=""><h1>tidysdm overview</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/EvolEcolGroup/tidysdm/blob/dev/vignettes/a0_tidysdm_overview.Rmd" class="external-link"><code>vignettes/a0_tidysdm_overview.Rmd</code></a></small>
      <div class="d-none name"><code>a0_tidysdm_overview.Rmd</code></div>
    </div>

    
    
<div class="section level2">
<h2 id="sdms-with-tidymodels">SDMs with <code>tidymodels</code><a class="anchor" aria-label="anchor" href="#sdms-with-tidymodels"></a>
</h2>
<p>Species Distribution Modelling relies on several algorithms, many of
which have a number of hyperparameters that require turning. The
<code>tidymodels</code> universe includes a number of packages
specifically design to fit, tune and validate models. The advantage of
<code>tidymodels</code> is that the models syntax and the results
returned to the users are standardised, thus providing a coherent
interface to modelling. Given the variety of models required for SDM,
<code>tidymodels</code> is an ideal framework. <code>tidysdm</code>
provides a number of wrappers and specialised functions to facilitate
the fitting of SDM with <code>tidymodels</code>.</p>
<p>This article provides an overview of the how <code>tidysdm</code>
facilitates fitting SDMs. Further articles, detailing how to use the
package for palaeodata, fitting more complex models and how to
troubleshoot models can be found on the <a href="https://evolecolgroup.github.io/tidysdm/"><code>tidisdm</code>
website</a>. As <code>tidysdm</code> relies on <code>tidymodels</code>,
users are advised to familiarise themselves with the introductory
tutorials on the <a href="https://www.tidymodels.org/start/" class="external-link"><code>tidymodels</code>
website</a>.</p>
<p>When we load <code>tidysdm</code>, it automatically loads
<code>tidymodels</code> and all associated packages necessary to fit
models:</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/EvolEcolGroup/tidysdm" class="external-link">tidysdm</a></span><span class="op">)</span></span>
<span><span class="co">#&gt; Loading required package: tidymodels</span></span>
<span><span class="co">#&gt; ── <span style="font-weight: bold;">Attaching packages</span> ────────────────────────────────────── tidymodels 1.2.0 ──</span></span>
<span><span class="co">#&gt; <span style="color: #00BB00;">✔</span> <span style="color: #0000BB;">broom       </span> 1.0.7     <span style="color: #00BB00;">✔</span> <span style="color: #0000BB;">recipes     </span> 1.1.0</span></span>
<span><span class="co">#&gt; <span style="color: #00BB00;">✔</span> <span style="color: #0000BB;">dials       </span> 1.3.0     <span style="color: #00BB00;">✔</span> <span style="color: #0000BB;">rsample     </span> 1.2.1</span></span>
<span><span class="co">#&gt; <span style="color: #00BB00;">✔</span> <span style="color: #0000BB;">dplyr       </span> 1.1.4     <span style="color: #00BB00;">✔</span> <span style="color: #0000BB;">tibble      </span> 3.2.1</span></span>
<span><span class="co">#&gt; <span style="color: #00BB00;">✔</span> <span style="color: #0000BB;">ggplot2     </span> 3.5.1     <span style="color: #00BB00;">✔</span> <span style="color: #0000BB;">tidyr       </span> 1.3.1</span></span>
<span><span class="co">#&gt; <span style="color: #00BB00;">✔</span> <span style="color: #0000BB;">infer       </span> 1.0.7     <span style="color: #00BB00;">✔</span> <span style="color: #0000BB;">tune        </span> 1.2.1</span></span>
<span><span class="co">#&gt; <span style="color: #00BB00;">✔</span> <span style="color: #0000BB;">modeldata   </span> 1.4.0     <span style="color: #00BB00;">✔</span> <span style="color: #0000BB;">workflows   </span> 1.1.4</span></span>
<span><span class="co">#&gt; <span style="color: #00BB00;">✔</span> <span style="color: #0000BB;">parsnip     </span> 1.2.1     <span style="color: #00BB00;">✔</span> <span style="color: #0000BB;">workflowsets</span> 1.1.0</span></span>
<span><span class="co">#&gt; <span style="color: #00BB00;">✔</span> <span style="color: #0000BB;">purrr       </span> 1.0.2     <span style="color: #00BB00;">✔</span> <span style="color: #0000BB;">yardstick   </span> 1.3.1</span></span>
<span><span class="co">#&gt; ── <span style="font-weight: bold;">Conflicts</span> ───────────────────────────────────────── tidymodels_conflicts() ──</span></span>
<span><span class="co">#&gt; <span style="color: #BB0000;">✖</span> <span style="color: #0000BB;">purrr</span>::<span style="color: #00BB00;">discard()</span> masks <span style="color: #0000BB;">scales</span>::discard()</span></span>
<span><span class="co">#&gt; <span style="color: #BB0000;">✖</span> <span style="color: #0000BB;">dplyr</span>::<span style="color: #00BB00;">filter()</span>  masks <span style="color: #0000BB;">stats</span>::filter()</span></span>
<span><span class="co">#&gt; <span style="color: #BB0000;">✖</span> <span style="color: #0000BB;">dplyr</span>::<span style="color: #00BB00;">lag()</span>     masks <span style="color: #0000BB;">stats</span>::lag()</span></span>
<span><span class="co">#&gt; <span style="color: #BB0000;">✖</span> <span style="color: #0000BB;">recipes</span>::<span style="color: #00BB00;">step()</span>  masks <span style="color: #0000BB;">stats</span>::step()</span></span>
<span><span class="co">#&gt; <span style="color: #0000BB;">•</span> Use suppressPackageStartupMessages() to eliminate package startup messages</span></span>
<span><span class="co">#&gt; Loading required package: spatialsample</span></span></code></pre></div>
<div class="section level4">
<h4 id="accessing-the-data-for-this-vignette-how-to-use-rgbif">Accessing the data for this vignette: how to use
<code>rgbif</code><a class="anchor" aria-label="anchor" href="#accessing-the-data-for-this-vignette-how-to-use-rgbif"></a>
</h4>
<p>We start by reading in a set of presences for a species of lizard
that inhabits the Iberian peninsula, <em>Lacerta schreiberi</em>. This
data is taken from GBIF Occurrence Download (6 July 2023) <a href="https://doi.org/10.15468/dl.srq3b3" class="external-link uri">https://doi.org/10.15468/dl.srq3b3</a>. The dataset is
already included in the <code>tidysdm</code> package:</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/data.html" class="external-link">data</a></span><span class="op">(</span><span class="va">lacerta</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">lacerta</span><span class="op">)</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 6 × 3</span></span></span>
<span><span class="co">#&gt;          ID latitude longitude</span></span>
<span><span class="co">#&gt;       <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>    <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>     <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">1</span> 858<span style="text-decoration: underline;">029</span>749     42.6     -<span style="color: #BB0000;">7.09</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">2</span> 858<span style="text-decoration: underline;">029</span>738     42.6     -<span style="color: #BB0000;">7.09</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">3</span> 614<span style="text-decoration: underline;">631</span>090     41.4     -<span style="color: #BB0000;">7.90</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">4</span> 614<span style="text-decoration: underline;">631</span>085     41.3     -<span style="color: #BB0000;">7.81</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">5</span> 614<span style="text-decoration: underline;">631</span>083     41.3     -<span style="color: #BB0000;">7.81</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">6</span> 614<span style="text-decoration: underline;">631</span>080     41.4     -<span style="color: #BB0000;">7.83</span></span></span></code></pre></div>
<p>Alternatively, we can easily access and manipulate this dataset using
<code>rbgif</code>. Note that the data from GBIF often requires some
level of cleaning. Here we will use a simple cleaning function from the
<code>CoordinateCleaner</code>; in general, we recommend to inspect the
data that are flagged as problematic, rather than just accepting them as
we do here:</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># download presences</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://docs.ropensci.org/rgbif" class="external-link">rgbif</a></span><span class="op">)</span></span>
<span><span class="fu"><a href="https://docs.ropensci.org/rgbif/reference/occ_download_get.html" class="external-link">occ_download_get</a></span><span class="op">(</span>key <span class="op">=</span> <span class="st">"0068808-230530130749713"</span>, path <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/tempfile.html" class="external-link">tempdir</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co"># read file</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://readr.tidyverse.org" class="external-link">readr</a></span><span class="op">)</span></span>
<span><span class="va">distrib</span> <span class="op">&lt;-</span> <span class="fu">read_delim</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/tempfile.html" class="external-link">tempdir</a></span><span class="op">(</span><span class="op">)</span>, <span class="st">"0068808-230530130749713.zip"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co"># keep the necessary columns and rename them</span></span>
<span><span class="va">lacerta</span> <span class="op">&lt;-</span> <span class="va">distrib</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="va">gbifID</span>, <span class="va">decimalLatitude</span>, <span class="va">decimalLongitude</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/rename.html" class="external-link">rename</a></span><span class="op">(</span>ID <span class="op">=</span> <span class="va">gbifID</span>, latitude <span class="op">=</span> <span class="va">decimalLatitude</span>, longitude <span class="op">=</span> <span class="va">decimalLongitude</span><span class="op">)</span></span>
<span><span class="co"># clean up the data</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://ropensci.github.io/CoordinateCleaner/" class="external-link">CoordinateCleaner</a></span><span class="op">)</span></span>
<span><span class="va">lacerta</span> <span class="op">&lt;-</span> <span class="fu">clean_coordinates</span><span class="op">(</span>x <span class="op">=</span> <span class="va">lacerta</span>,</span>
<span>                           lon <span class="op">=</span> <span class="st">"longitude"</span>,</span>
<span>                           lat <span class="op">=</span> <span class="st">"latitude"</span>,</span>
<span>                           species <span class="op">=</span> <span class="st">"ID"</span>,</span>
<span>                           value <span class="op">=</span> <span class="st">"clean"</span><span class="op">)</span></span></code></pre></div>
</div>
</div>
<div class="section level2">
<h2 id="preparing-your-data">Preparing your data<a class="anchor" aria-label="anchor" href="#preparing-your-data"></a>
</h2>
<p>First, let us visualise our presences by plotting on a map.
<code>tidysdm</code> works with <code>sf</code> objects to represent
locations, so we will cast our coordinates into an <code>sf</code>
object, and set its projections to standard ‘lonlat’ (<code>crs</code> =
4326).</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://r-spatial.github.io/sf/" class="external-link">sf</a></span><span class="op">)</span></span>
<span><span class="co">#&gt; Linking to GEOS 3.10.2, GDAL 3.4.1, PROJ 8.2.1; sf_use_s2() is TRUE</span></span>
<span><span class="va">lacerta</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_as_sf.html" class="external-link">st_as_sf</a></span><span class="op">(</span><span class="va">lacerta</span>, coords <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"longitude"</span>, <span class="st">"latitude"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_crs.html" class="external-link">st_crs</a></span><span class="op">(</span><span class="va">lacerta</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fl">4326</span></span></code></pre></div>
<p>It is usually advisable to plot the locations directly on the raster
that will be used to extract climatic variables, to see how the
locations fall within the discrete space of the raster. For this
vignette, we will use WorldClim as our source of climatic information.
We will access the WorldClim data via the library <code>pastclim</code>;
even though this library, as the name suggests, is mostly designed to
handle palaeoclimatic reconstructions, it also provides convenient
functions to access present day reconstructions and future projections.
<code>pastclim</code> has a handy function to get the land mask for the
available datasets, which we can use as background for our locations. We
will cut the raster to the Iberian peninsula, where our lizard lives.
For this simply illustration, we will not bother to project the raster,
but an equal area projection would be desirable…</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/EvolEcolGroup/pastclim" class="external-link">pastclim</a></span><span class="op">)</span></span>
<span><span class="fu"><a href="https://evolecolgroup.github.io/pastclim/reference/download_dataset.html" class="external-link">download_dataset</a></span><span class="op">(</span>dataset <span class="op">=</span> <span class="st">"WorldClim_2.1_10m"</span><span class="op">)</span></span>
<span><span class="va">land_mask</span> <span class="op">&lt;-</span></span>
<span>  <span class="fu"><a href="https://evolecolgroup.github.io/pastclim/reference/get_land_mask.html" class="external-link">get_land_mask</a></span><span class="op">(</span>time_ce <span class="op">=</span> <span class="fl">1985</span>, dataset <span class="op">=</span> <span class="st">"WorldClim_2.1_10m"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Iberia peninsula extension</span></span>
<span><span class="va">iberia_poly</span> <span class="op">&lt;-</span></span>
<span>  <span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/vect.html" class="external-link">vect</a></span><span class="op">(</span></span>
<span>    <span class="st">"POLYGON((-9.8 43.3,-7.8 44.1,-2.0 43.7,3.6 42.5,3.8 41.5,1.3 40.8,0.3 39.5,</span></span>
<span><span class="st">     0.9 38.6,-0.4 37.5,-1.6 36.7,-2.3 36.3,-4.1 36.4,-4.5 36.4,-5.0 36.1,</span></span>
<span><span class="st">    -5.6 36.0,-6.3 36.0,-7.1 36.9,-9.5 36.6,-9.4 38.0,-10.6 38.9,-9.5 40.8,</span></span>
<span><span class="st">    -9.8 43.3))"</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rspatial.github.io/terra/reference/crs.html" class="external-link">crs</a></span><span class="op">(</span><span class="va">iberia_poly</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="st">"lonlat"</span></span>
<span><span class="co"># crop the extent</span></span>
<span><span class="va">land_mask</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rspatial.github.io/terra/reference/crop.html" class="external-link">crop</a></span><span class="op">(</span><span class="va">land_mask</span>, <span class="va">iberia_poly</span><span class="op">)</span></span>
<span><span class="co"># and mask to the polygon</span></span>
<span><span class="va">land_mask</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rspatial.github.io/terra/reference/mask.html" class="external-link">mask</a></span><span class="op">(</span><span class="va">land_mask</span>, <span class="va">iberia_poly</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">#&gt; Loading required package: terra</span></span>
<span><span class="co">#&gt; terra 1.7.78</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Attaching package: 'terra'</span></span>
<span><span class="co">#&gt; The following object is masked from 'package:tidyr':</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;     extract</span></span>
<span><span class="co">#&gt; The following object is masked from 'package:scales':</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;     rescale</span></span>
<span><span class="co">#&gt; [1] TRUE</span></span></code></pre>
<p>For plotting, we will take advantage of <code>tidyterra</code>, which
makes handling of <code>terra</code> rasters with <code>ggplot</code> a
breeze.</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://dieghernan.github.io/tidyterra/" class="external-link">tidyterra</a></span><span class="op">)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Attaching package: 'tidyterra'</span></span>
<span><span class="co">#&gt; The following object is masked from 'package:stats':</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;     filter</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://ggplot2.tidyverse.org" class="external-link">ggplot2</a></span><span class="op">)</span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://dieghernan.github.io/tidyterra/reference/geom_spatraster.html" class="external-link">geom_spatraster</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">land_mask</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>fill <span class="op">=</span> <span class="va">land_mask_1985</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggsf.html" class="external-link">geom_sf</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">lacerta</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/guides.html" class="external-link">guides</a></span><span class="op">(</span>fill<span class="op">=</span><span class="st">"none"</span><span class="op">)</span></span></code></pre></div>
<p><img src="a0_tidysdm_overview_files/figure-html/unnamed-chunk-3-1.png" width="576"></p>
</div>
<div class="section level2">
<h2 id="thinning-step">Thinning step<a class="anchor" aria-label="anchor" href="#thinning-step"></a>
</h2>
<p>Now, we thin the observations to have one per cell in the raster (it
would be better if we had an equal area projection…):</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">1234567</span><span class="op">)</span></span>
<span><span class="va">lacerta</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/thin_by_cell.html">thin_by_cell</a></span><span class="op">(</span><span class="va">lacerta</span>, raster <span class="op">=</span> <span class="va">land_mask</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rspatial.github.io/terra/reference/dimensions.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">lacerta</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] 226</span></span></code></pre></div>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://dieghernan.github.io/tidyterra/reference/geom_spatraster.html" class="external-link">geom_spatraster</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">land_mask</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>fill <span class="op">=</span> <span class="va">land_mask_1985</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggsf.html" class="external-link">geom_sf</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">lacerta</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/guides.html" class="external-link">guides</a></span><span class="op">(</span>fill<span class="op">=</span><span class="st">"none"</span><span class="op">)</span></span></code></pre></div>
<p><img src="a0_tidysdm_overview_files/figure-html/plot_thin_by_cell-1.png" width="576"></p>
<p>Now, we thin further to remove points that are closer than 20km.
However, note that the standard map units for a ‘lonlat’ projection are
meters. <code>tidysdm</code> provides a convening conversion function,
<code><a href="../reference/km2m.html">km2m()</a></code>, to avoid having to write lots of zeroes):</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">1234567</span><span class="op">)</span></span>
<span><span class="va">lacerta_thin</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/thin_by_dist.html">thin_by_dist</a></span><span class="op">(</span><span class="va">lacerta</span>, dist_min <span class="op">=</span> <span class="fu"><a href="../reference/km2m.html">km2m</a></span><span class="op">(</span><span class="fl">20</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rspatial.github.io/terra/reference/dimensions.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">lacerta_thin</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] 111</span></span></code></pre></div>
<p>Let’s see what we have left of our points:</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://dieghernan.github.io/tidyterra/reference/geom_spatraster.html" class="external-link">geom_spatraster</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">land_mask</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>fill <span class="op">=</span> <span class="va">land_mask_1985</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggsf.html" class="external-link">geom_sf</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">lacerta_thin</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/guides.html" class="external-link">guides</a></span><span class="op">(</span>fill<span class="op">=</span><span class="st">"none"</span><span class="op">)</span></span></code></pre></div>
<p><img src="a0_tidysdm_overview_files/figure-html/plot_thin_by_dist-1.png" width="576"></p>
<p>We now need to select points that represent the potential available
area for the species. There are two approaches, we can either sample the
background with <code><a href="../reference/sample_background.html">sample_background()</a></code>, or we can generate
pseudo-absences with <code><a href="../reference/sample_pseudoabs.html">sample_pseudoabs()</a></code>. In this example,
we will sample the background; more specifically, we will attempt to
account for potential sampling biases by using a target group approach,
where presences from other species within the same taxonomic group are
used to condition the sampling of the background, providing information
on differential sampling of different areas within the region of
interest.</p>
<p>We will start by downloading records from 8 genera of
<em>Lacertidae</em>, covering the same geographic region of the Iberian
peninsula from GBIF <a href="https://doi.org/10.15468/dl.53js5z" class="external-link uri">https://doi.org/10.15468/dl.53js5z</a>:</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://docs.ropensci.org/rgbif" class="external-link">rgbif</a></span><span class="op">)</span></span>
<span><span class="fu"><a href="https://docs.ropensci.org/rgbif/reference/occ_download_get.html" class="external-link">occ_download_get</a></span><span class="op">(</span>key <span class="op">=</span> <span class="st">"0121761-240321170329656"</span>, path <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/tempfile.html" class="external-link">tempdir</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://readr.tidyverse.org" class="external-link">readr</a></span><span class="op">)</span></span>
<span><span class="va">backg_distrib</span> <span class="op">&lt;-</span> <span class="fu">readr</span><span class="fu">::</span><span class="fu">read_delim</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/tempfile.html" class="external-link">tempdir</a></span><span class="op">(</span><span class="op">)</span>, </span>
<span>                                             <span class="st">"0121761-240321170329656.zip"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co"># keep the necessary columns</span></span>
<span><span class="va">lacertidae_background</span> <span class="op">&lt;-</span> <span class="va">backg_distrib</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="va">gbifID</span>, <span class="va">decimalLatitude</span>, <span class="va">decimalLongitude</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/rename.html" class="external-link">rename</a></span><span class="op">(</span>ID <span class="op">=</span> <span class="va">gbifID</span>, latitude <span class="op">=</span> <span class="va">decimalLatitude</span>, longitude <span class="op">=</span> <span class="va">decimalLongitude</span><span class="op">)</span></span>
<span><span class="co"># convert to an sf object</span></span>
<span><span class="va">lacertidae_background</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_as_sf.html" class="external-link">st_as_sf</a></span><span class="op">(</span><span class="va">lacertidae_background</span>, </span>
<span>                                  coords <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"longitude"</span>, <span class="st">"latitude"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_crs.html" class="external-link">st_crs</a></span><span class="op">(</span><span class="va">lacertidae_background</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fl">4326</span></span></code></pre></div>
<p>We need to convert these observations into a raster whose values are
the number of records (which will be later used to determine how likely
each cell is to be used as a background point):</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">lacertidae_background_raster</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rspatial.github.io/terra/reference/rasterize.html" class="external-link">rasterize</a></span><span class="op">(</span><span class="va">lacertidae_background</span>, <span class="va">land_mask</span>, </span>
<span>                                          fun <span class="op">=</span> <span class="st">"count"</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rspatial.github.io/terra/reference/plot.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">lacertidae_background_raster</span><span class="op">)</span></span></code></pre></div>
<p><img src="a0_tidysdm_overview_files/figure-html/background_to_raster-1.png" width="576"></p>
<p>We can see that the sampling is far from random, with certain
locations having very large number of records. We can now sample the
background, using the ‘bias’ method to represent this heterogeneity in
sampling effort:</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">1234567</span><span class="op">)</span></span>
<span><span class="va">lacerta_thin</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/sample_background.html">sample_background</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">lacerta_thin</span>, raster <span class="op">=</span> <span class="va">lacertidae_background_raster</span>,</span>
<span>                  n <span class="op">=</span> <span class="fl">3</span> <span class="op">*</span> <span class="fu"><a href="https://rspatial.github.io/terra/reference/dimensions.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">lacerta_thin</span><span class="op">)</span>,</span>
<span>                  method <span class="op">=</span> <span class="st">"bias"</span>,</span>
<span>                  class_label <span class="op">=</span> <span class="st">"background"</span>,</span>
<span>                  return_pres <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span></code></pre></div>
<p>Let’s see our presences and background:</p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://dieghernan.github.io/tidyterra/reference/geom_spatraster.html" class="external-link">geom_spatraster</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">land_mask</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>fill <span class="op">=</span> <span class="va">land_mask_1985</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggsf.html" class="external-link">geom_sf</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">lacerta_thin</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>col <span class="op">=</span> <span class="va">class</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/guides.html" class="external-link">guides</a></span><span class="op">(</span>fill<span class="op">=</span><span class="st">"none"</span><span class="op">)</span></span></code></pre></div>
<p><img src="a0_tidysdm_overview_files/figure-html/plot_sample_pseudoabs-1.png" width="576"></p>
<p>We can use <code>pastclim</code> to download the WorldClim dataset
(we’ll use the 10 arc-minute resolution) and extract the bioclimatic
variables that are available (but you do not have to use
<code>pastclim</code>, you could use any raster dataset you have access
to, loading it directly with <code>terra</code>).</p>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://evolecolgroup.github.io/pastclim/reference/download_dataset.html" class="external-link">download_dataset</a></span><span class="op">(</span><span class="st">"WorldClim_2.1_10m"</span><span class="op">)</span></span>
<span><span class="va">climate_vars</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://evolecolgroup.github.io/pastclim/reference/get_vars_for_dataset.html" class="external-link">get_vars_for_dataset</a></span><span class="op">(</span><span class="st">"WorldClim_2.1_10m"</span><span class="op">)</span></span>
<span><span class="va">climate_present</span> <span class="op">&lt;-</span> <span class="fu">pastclim</span><span class="fu">::</span><span class="fu"><a href="https://evolecolgroup.github.io/pastclim/reference/region_slice.html" class="external-link">region_slice</a></span><span class="op">(</span></span>
<span>  time_ce <span class="op">=</span> <span class="fl">1985</span>,</span>
<span>  bio_variables <span class="op">=</span> <span class="va">climate_vars</span>,</span>
<span>  data <span class="op">=</span> <span class="st">"WorldClim_2.1_10m"</span>,</span>
<span>  crop <span class="op">=</span> <span class="va">iberia_poly</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>Note that the dataset covers the period 1970-2000, so
<code>pastclim</code> dates it as 1985 (the midpoint). We have also
cropped it directly to the Iberian peninsula.</p>
<p>Note that, in this vignette, we focus on continuous variables; most
machine learning algorithms do not natively cope with multi-level
factors, but it is possible to use <code><a href="https://recipes.tidymodels.org/reference/step_dummy.html" class="external-link">recipes::step_dummy()</a></code> to
generate dummy variables from factors. A worked example can be found in
the <a href="https://evolecolgroup.github.io/tidysdm/articles/a2_tidymodels_additions.html">article
on additional features of tidymodels with tidysdm</a>.</p>
<p>Next, we extract climate for all presences and background points:</p>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">lacerta_thin</span> <span class="op">&lt;-</span> <span class="va">lacerta_thin</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/bind_cols.html" class="external-link">bind_cols</a></span><span class="op">(</span><span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/extract.html" class="external-link">extract</a></span><span class="op">(</span><span class="va">climate_present</span>, <span class="va">lacerta_thin</span>, ID <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>Based on this paper (<a href="https://doi.org/10.1007/s10531-010-9865-2" class="external-link uri">https://doi.org/10.1007/s10531-010-9865-2</a>), we are
interested in these variables: “bio06”, “bio05”, “bio13”, “bio14”,
“bio15”. We can visualise the differences between presences and the
background using violin plots:</p>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">lacerta_thin</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="../reference/plot_pres_vs_bg.html">plot_pres_vs_bg</a></span><span class="op">(</span><span class="va">class</span><span class="op">)</span></span></code></pre></div>
<p><img src="a0_tidysdm_overview_files/figure-html/unnamed-chunk-9-1.png" width="672">
We can see that all the variables of interest do seem to have a
different distribution between presences and the background. We can
formally quantify the mismatch between the two by computing the
overlap:</p>
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">lacerta_thin</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="../reference/dist_pres_vs_bg.html">dist_pres_vs_bg</a></span><span class="op">(</span><span class="va">class</span><span class="op">)</span></span>
<span><span class="co">#&gt;      bio09      bio12      bio16      bio19      bio13      bio05      bio10 </span></span>
<span><span class="co">#&gt; 0.43907819 0.41888524 0.41487381 0.40742724 0.40492411 0.38854703 0.38610145 </span></span>
<span><span class="co">#&gt;      bio02      bio07      bio04      bio08      bio17      bio15      bio18 </span></span>
<span><span class="co">#&gt; 0.35191109 0.35036167 0.32450555 0.31879785 0.28143659 0.27152095 0.25007068 </span></span>
<span><span class="co">#&gt;      bio01      bio14      bio03      bio11   altitude      bio06 </span></span>
<span><span class="co">#&gt; 0.24589097 0.24294699 0.18414624 0.11169528 0.07271380 0.06742951</span></span></code></pre></div>
<p>Again, we can see that the variables of interest seem good candidates
with a clear signal. Let us then focus on those variables:</p>
<div class="sourceCode" id="cb20"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="va">suggested_vars</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"bio06"</span>, <span class="st">"bio05"</span>, <span class="st">"bio13"</span>, <span class="st">"bio14"</span>, <span class="st">"bio15"</span><span class="op">)</span></span></code></pre></div>
<p>Environmental variables are often highly correlated, and collinearity
is an issue for several types of models. We can inspect the correlation
among variables with:</p>
<div class="sourceCode" id="cb21"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rspatial.github.io/terra/reference/pairs.html" class="external-link">pairs</a></span><span class="op">(</span><span class="va">climate_present</span><span class="op">[[</span><span class="va">suggested_vars</span><span class="op">]</span><span class="op">]</span><span class="op">)</span></span></code></pre></div>
<p><img src="a0_tidysdm_overview_files/figure-html/unnamed-chunk-11-1.png" width="672"></p>
<p>We can see that some variables have rather high correlation
(e.g. bio05 vs bio14). We can subset to variables below a certain
threshold correlation (e.g. 0.7) with:</p>
<div class="sourceCode" id="cb22"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">climate_present</span> <span class="op">&lt;-</span> <span class="va">climate_present</span><span class="op">[[</span><span class="va">suggested_vars</span><span class="op">]</span><span class="op">]</span></span>
<span></span>
<span><span class="va">vars_uncor</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/filter_collinear.html">filter_collinear</a></span><span class="op">(</span><span class="va">climate_present</span>, cutoff <span class="op">=</span> <span class="fl">0.7</span>, method <span class="op">=</span> <span class="st">"cor_caret"</span><span class="op">)</span></span>
<span><span class="va">vars_uncor</span></span>
<span><span class="co">#&gt; [1] "bio15" "bio05" "bio13" "bio06"</span></span>
<span><span class="co">#&gt; attr(,"to_remove")</span></span>
<span><span class="co">#&gt; [1] "bio14"</span></span></code></pre></div>
<p>So, removing bio14 leaves us with a set of uncorrelated variables.
Note that <code>filter_collinear</code> has other methods based on
variable inflation that would also be worth exploring. For this example,
we will remove bio14 and work with the remaining variables.</p>
<div class="sourceCode" id="cb23"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">lacerta_thin</span> <span class="op">&lt;-</span> <span class="va">lacerta_thin</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="fu"><a href="https://tidyselect.r-lib.org/reference/all_of.html" class="external-link">all_of</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">vars_uncor</span>, <span class="st">"class"</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">climate_present</span> <span class="op">&lt;-</span> <span class="va">climate_present</span><span class="op">[[</span><span class="va">vars_uncor</span><span class="op">]</span><span class="op">]</span></span>
<span><span class="fu"><a href="https://rspatial.github.io/terra/reference/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">climate_present</span><span class="op">)</span> <span class="co"># added to highlight which variables are retained in the end</span></span>
<span><span class="co">#&gt; [1] "bio15" "bio05" "bio13" "bio06"</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="fit-the-model-by-cross-validation">Fit the model by cross-validation<a class="anchor" aria-label="anchor" href="#fit-the-model-by-cross-validation"></a>
</h2>
<p>Next, we need to set up a <code>recipe</code> to define how to handle
our dataset. We don’t want to do anything to our data in terms of
transformations, so we just need to define the formula (<em>class</em>
is the <code>outcome</code>, all other variables are
<code>predictors</code>; note that, for <code>sf</code> objects,
<code>geometry</code> is automatically replaced by <code>X</code> and
<code>Y</code> columns which are assigned a role of <code>coords</code>,
and thus not used as predictors):</p>
<div class="sourceCode" id="cb24"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">lacerta_rec</span> <span class="op">&lt;-</span> <span class="fu">recipe</span><span class="op">(</span><span class="va">lacerta_thin</span>, formula <span class="op">=</span> <span class="va">class</span> <span class="op">~</span> <span class="va">.</span><span class="op">)</span></span>
<span><span class="va">lacerta_rec</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; <span style="color: #00BBBB;">──</span> <span style="font-weight: bold;">Recipe</span> <span style="color: #00BBBB;">──────────────────────────────────────────────────────────────────────</span></span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; ── Inputs</span></span>
<span><span class="co">#&gt; Number of variables by role</span></span>
<span><span class="co">#&gt; outcome:   1</span></span>
<span><span class="co">#&gt; predictor: 4</span></span>
<span><span class="co">#&gt; coords:    2</span></span></code></pre></div>
<p>In classification models for <code>tidymodels</code>, the assumption
is that the level of interest for the response (in our case, presences)
is the reference level. We can confirm that we have the data correctly
formatted with:</p>
<div class="sourceCode" id="cb25"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">lacerta_thin</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="../reference/check_sdm_presence.html">check_sdm_presence</a></span><span class="op">(</span><span class="va">class</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] TRUE</span></span></code></pre></div>
<p>We now build a <code>workflow_set</code> of different models,
defining which hyperparameters we want to tune. We will use
<em>glm</em>, <em>random forest</em>, <em>boosted_trees</em> and
<em>maxent</em> as our models (for more details on how to use
<code>workflow_set</code>s, see <a href="https://workflowsets.tidymodels.org/articles/tuning-and-comparing-models.html" class="external-link">this
tutorial</a>). The latter three models have tunable hyperparameters. For
the most commonly used models, <code>tidysdm</code> automatically
chooses the most important parameters, but it is possible to fully
customise model specifications (e.g. see the help for
<code>sdm_spec_rf</code>).</p>
<div class="sourceCode" id="cb26"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">lacerta_models</span> <span class="op">&lt;-</span></span>
<span>  <span class="co"># create the workflow_set</span></span>
<span>  <span class="fu">workflow_set</span><span class="op">(</span></span>
<span>    preproc <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>default <span class="op">=</span> <span class="va">lacerta_rec</span><span class="op">)</span>,</span>
<span>    models <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>      <span class="co"># the standard glm specs</span></span>
<span>      glm <span class="op">=</span> <span class="fu"><a href="../reference/sdm_spec_glm.html">sdm_spec_glm</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>      <span class="co"># rf specs with tuning</span></span>
<span>      rf <span class="op">=</span> <span class="fu"><a href="../reference/sdm_spec_rand_forest.html">sdm_spec_rf</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>      <span class="co"># boosted tree model (gbm) specs with tuning</span></span>
<span>      gbm <span class="op">=</span> <span class="fu"><a href="../reference/sdm_spec_boost_tree.html">sdm_spec_boost_tree</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>      <span class="co"># maxent specs with tuning</span></span>
<span>      maxent <span class="op">=</span> <span class="fu"><a href="../reference/sdm_spec_maxent.html">sdm_spec_maxent</a></span><span class="op">(</span><span class="op">)</span></span>
<span>    <span class="op">)</span>,</span>
<span>    <span class="co"># make all combinations of preproc and models,</span></span>
<span>    cross <span class="op">=</span> <span class="cn">TRUE</span></span>
<span>  <span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="co"># tweak controls to store information needed later to create the ensemble</span></span>
<span>  <span class="fu">option_add</span><span class="op">(</span>control <span class="op">=</span> <span class="fu"><a href="../reference/control_ensemble.html">control_ensemble_grid</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>We now want to set up a spatial block cross-validation scheme to tune
and assess our models. We will split the data by creating 3 folds. We
use the <code>spatial_block_cv</code> function from the package
<code>spatialsample</code>. <code>spatialsample</code> offers a number
of sampling approaches for spatial data; it is also possible to convert
objects created with <code>blockCV</code> (which offers further features
for spatial sampling, such as stratified sampling) into an
<code>rsample</code> object suitable to <code>tisysdm</code> with the
function <code>blockcv2rsample</code>.</p>
<div class="sourceCode" id="cb27"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/EvolEcolGroup/tidysdm" class="external-link">tidysdm</a></span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">100</span><span class="op">)</span></span>
<span><span class="co">#lacerta_cv &lt;- spatial_block_cv(lacerta_thin, v = 5)</span></span>
<span></span>
<span><span class="va">lacerta_cv</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://spatialsample.tidymodels.org/reference/spatial_block_cv.html" class="external-link">spatial_block_cv</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">lacerta_thin</span>, v <span class="op">=</span> <span class="fl">3</span>, n <span class="op">=</span> <span class="fl">5</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/autoplot.html" class="external-link">autoplot</a></span><span class="op">(</span><span class="va">lacerta_cv</span><span class="op">)</span></span></code></pre></div>
<p><img src="a0_tidysdm_overview_files/figure-html/training_cv-1.png" width="576"></p>
<p>We can now use the block CV folds to tune and assess the models (to
keep computations fast, we will only explore 3 combination of
hyperparameters per model; this is far too little in real life!):</p>
<div class="sourceCode" id="cb28"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">1234567</span><span class="op">)</span></span>
<span><span class="va">lacerta_models</span> <span class="op">&lt;-</span></span>
<span>  <span class="va">lacerta_models</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu">workflow_map</span><span class="op">(</span><span class="st">"tune_grid"</span>,</span>
<span>    resamples <span class="op">=</span> <span class="va">lacerta_cv</span>, grid <span class="op">=</span> <span class="fl">3</span>,</span>
<span>    metrics <span class="op">=</span> <span class="fu"><a href="../reference/sdm_metric_set.html">sdm_metric_set</a></span><span class="op">(</span><span class="op">)</span>, verbose <span class="op">=</span> <span class="cn">TRUE</span></span>
<span>  <span class="op">)</span></span>
<span><span class="co">#&gt; <span style="color: #0000BB;">i</span>  <span style="color: #000000;">No tuning parameters. `fit_resamples()` will be attempted</span></span></span>
<span><span class="co">#&gt; <span style="color: #0000BB;">i</span> <span style="color: #000000;">1 of 4 resampling: default_glm</span></span></span>
<span><span class="co">#&gt; <span style="color: #00BB00;">✔</span> <span style="color: #000000;">1 of 4 resampling: default_glm (214ms)</span></span></span>
<span><span class="co">#&gt; <span style="color: #0000BB;">i</span> <span style="color: #000000;">2 of 4 tuning:     default_rf</span></span></span>
<span><span class="co">#&gt; <span style="color: #0000BB;">i</span> <span style="color: #000000;">Creating pre-processing data to finalize unknown parameter: mtry</span></span></span>
<span><span class="co">#&gt; <span style="color: #00BB00;">✔</span> <span style="color: #000000;">2 of 4 tuning:     default_rf (878ms)</span></span></span>
<span><span class="co">#&gt; <span style="color: #0000BB;">i</span> <span style="color: #000000;">3 of 4 tuning:     default_gbm</span></span></span>
<span><span class="co">#&gt; <span style="color: #0000BB;">i</span> <span style="color: #000000;">Creating pre-processing data to finalize unknown parameter: mtry</span></span></span>
<span><span class="co">#&gt; <span style="color: #00BB00;">✔</span> <span style="color: #000000;">3 of 4 tuning:     default_gbm (4.1s)</span></span></span>
<span><span class="co">#&gt; <span style="color: #0000BB;">i</span> <span style="color: #000000;">4 of 4 tuning:     default_maxent</span></span></span>
<span><span class="co">#&gt; <span style="color: #00BB00;">✔</span> <span style="color: #000000;">4 of 4 tuning:     default_maxent (1.2s)</span></span></span></code></pre></div>
<p>Note that <code>workflow_set</code> correctly detects that we have no
tuning parameters for <em>glm</em>. We can have a look at the
performance of our models with:</p>
<div class="sourceCode" id="cb29"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/autoplot.html" class="external-link">autoplot</a></span><span class="op">(</span><span class="va">lacerta_models</span><span class="op">)</span></span></code></pre></div>
<p><img src="a0_tidysdm_overview_files/figure-html/autoplot_models-1.png" width="672"></p>
<p>Now let’s create an ensemble, selecting the best set of parameters
for each model (this is really only relevant for the random forest, as
there were not hype-parameters to tune for the <em>glm</em> and
<em>gam</em>). We will use the Boyce continuous index as our metric to
choose the best random forest and boosted tree. When adding members to
an ensemble, they are automatically fitted to the full training dataset,
and so ready to make predictions.</p>
<div class="sourceCode" id="cb30"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">lacerta_ensemble</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/simple_ensemble.html">simple_ensemble</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="../reference/add_member.html">add_member</a></span><span class="op">(</span><span class="va">lacerta_models</span>, metric <span class="op">=</span> <span class="st">"boyce_cont"</span><span class="op">)</span></span>
<span><span class="va">lacerta_ensemble</span></span>
<span><span class="co">#&gt; A simple_ensemble of models</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Members:</span></span>
<span><span class="co">#&gt; <span style="color: #00BBBB;">•</span> default_glm</span></span>
<span><span class="co">#&gt; <span style="color: #00BBBB;">•</span> default_rf</span></span>
<span><span class="co">#&gt; <span style="color: #00BBBB;">•</span> default_gbm</span></span>
<span><span class="co">#&gt; <span style="color: #00BBBB;">•</span> default_maxent</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Available metrics:</span></span>
<span><span class="co">#&gt; <span style="color: #00BBBB;">•</span> boyce_cont</span></span>
<span><span class="co">#&gt; <span style="color: #00BBBB;">•</span> roc_auc</span></span>
<span><span class="co">#&gt; <span style="color: #00BBBB;">•</span> tss_max</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Metric used to tune workflows:</span></span>
<span><span class="co">#&gt; <span style="color: #00BBBB;">•</span> boyce_cont</span></span></code></pre></div>
<p>And visualise it</p>
<div class="sourceCode" id="cb31"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/autoplot.html" class="external-link">autoplot</a></span><span class="op">(</span><span class="va">lacerta_ensemble</span><span class="op">)</span></span></code></pre></div>
<p><img src="a0_tidysdm_overview_files/figure-html/autoplot_ens-1.png" width="672"></p>
<p>A tabular form of the model metrics can be obtained with:</p>
<div class="sourceCode" id="cb32"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">lacerta_ensemble</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> <span class="fu">collect_metrics</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 12 × 5</span></span></span>
<span><span class="co">#&gt;    wflow_id       .metric     mean std_err     n</span></span>
<span><span class="co">#&gt;    <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>          <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>      <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>   <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;int&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 1</span> default_glm    boyce_cont 0.573 0.115       3</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 2</span> default_glm    roc_auc    0.775 0.013<span style="text-decoration: underline;">8</span>      3</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 3</span> default_glm    tss_max    0.486 0.033<span style="text-decoration: underline;">7</span>      3</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 4</span> default_rf     boyce_cont 0.709 0.085<span style="text-decoration: underline;">6</span>      3</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 5</span> default_rf     roc_auc    0.794 0.006<span style="text-decoration: underline;">48</span>     3</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 6</span> default_rf     tss_max    0.537 0.036<span style="text-decoration: underline;">3</span>      3</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 7</span> default_gbm    boyce_cont 0.659 0.047<span style="text-decoration: underline;">2</span>      3</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 8</span> default_gbm    roc_auc    0.789 0.007<span style="text-decoration: underline;">07</span>     3</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 9</span> default_gbm    tss_max    0.524 0.015<span style="text-decoration: underline;">2</span>      3</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">10</span> default_maxent boyce_cont 0.651 0.157       3</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">11</span> default_maxent roc_auc    0.804 0.006<span style="text-decoration: underline;">53</span>     3</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">12</span> default_maxent tss_max    0.572 0.011<span style="text-decoration: underline;">1</span>      3</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="projecting-to-the-present">Projecting to the present<a class="anchor" aria-label="anchor" href="#projecting-to-the-present"></a>
</h2>
<p>We can now make predictions with this ensemble (using the default
option of taking the mean of the predictions from each model).</p>
<div class="sourceCode" id="cb33"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">prediction_present</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/predict_raster.html">predict_raster</a></span><span class="op">(</span><span class="va">lacerta_ensemble</span>, <span class="va">climate_present</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://dieghernan.github.io/tidyterra/reference/geom_spatraster.html" class="external-link">geom_spatraster</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">prediction_present</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>fill <span class="op">=</span> <span class="va">mean</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://dieghernan.github.io/tidyterra/reference/scale_terrain.html" class="external-link">scale_fill_terrain_c</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="co"># plot presences used in the model</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggsf.html" class="external-link">geom_sf</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">lacerta_thin</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">class</span> <span class="op">==</span> <span class="st">"presence"</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p><img src="a0_tidysdm_overview_files/figure-html/plot_present-1.png" width="576"></p>
<p>We can subset the ensemble to only use the best models, based on the
Boyce continuous index, by setting a minimum threshold of 0.7 for that
metric. We will also take the median of the available model predictions
(instead of the mean, which is the default). The plot does not change
much (the models are quite consistent).</p>
<div class="sourceCode" id="cb34"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="va">prediction_present_boyce</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/predict_raster.html">predict_raster</a></span><span class="op">(</span><span class="va">lacerta_ensemble</span>, <span class="va">climate_present</span>,</span>
<span>  metric_thresh <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"boyce_cont"</span>, <span class="fl">0.7</span><span class="op">)</span>,</span>
<span>  fun <span class="op">=</span> <span class="st">"median"</span></span>
<span><span class="op">)</span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://dieghernan.github.io/tidyterra/reference/geom_spatraster.html" class="external-link">geom_spatraster</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">prediction_present_boyce</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>fill <span class="op">=</span> <span class="va">median</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://dieghernan.github.io/tidyterra/reference/scale_terrain.html" class="external-link">scale_fill_terrain_c</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggsf.html" class="external-link">geom_sf</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">lacerta_thin</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">class</span> <span class="op">==</span> <span class="st">"presence"</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p><img src="a0_tidysdm_overview_files/figure-html/plot_present_best-1.png" width="576"></p>
<p>Sometimes, it is desirable to have binary predictions (presence vs
absence), rather than the probability of occurrence. To do so, we first
need to calibrate the threshold used to convert probabilities into
classes (in this case, we optimise the TSS):</p>
<div class="sourceCode" id="cb35"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">lacerta_ensemble</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/calib_class_thresh.html">calib_class_thresh</a></span><span class="op">(</span><span class="va">lacerta_ensemble</span>,</span>
<span>  class_thresh <span class="op">=</span> <span class="st">"tss_max"</span>, </span>
<span>  metric_thresh <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"boyce_cont"</span>, <span class="fl">0.7</span><span class="op">)</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>And now we can predict for the whole continent:</p>
<div class="sourceCode" id="cb36"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">prediction_present_binary</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/predict_raster.html">predict_raster</a></span><span class="op">(</span><span class="va">lacerta_ensemble</span>,</span>
<span>  <span class="va">climate_present</span>,</span>
<span>  type <span class="op">=</span> <span class="st">"class"</span>,</span>
<span>  class_thresh <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"tss_max"</span><span class="op">)</span>, </span>
<span>  metric_thresh <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"boyce_cont"</span>, <span class="fl">0.7</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://dieghernan.github.io/tidyterra/reference/geom_spatraster.html" class="external-link">geom_spatraster</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">prediction_present_binary</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>fill <span class="op">=</span> <span class="va">binary_mean</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggsf.html" class="external-link">geom_sf</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">lacerta_thin</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">class</span> <span class="op">==</span> <span class="st">"presence"</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_colour_discrete.html" class="external-link">scale_fill_discrete</a></span><span class="op">(</span>na.value <span class="op">=</span> <span class="st">"transparent"</span><span class="op">)</span></span></code></pre></div>
<p><img src="a0_tidysdm_overview_files/figure-html/unnamed-chunk-18-1.png" width="576"></p>
</div>
<div class="section level2">
<h2 id="projecting-to-the-future">Projecting to the future<a class="anchor" aria-label="anchor" href="#projecting-to-the-future"></a>
</h2>
<p>WorldClim has a wide selection of projections for the future based on
different models and Shared Socio-economic Pathways (SSP). Type
<code><a href="https://evolecolgroup.github.io/pastclim/reference/WorldClim_2.1.html" class="external-link">help("WorldClim_2.1")</a></code> for a full list. We will use
predictions based on “HadGEM3-GC31-LL” model for SSP 245 (intermediate
green house gas emissions) at the same resolution as the present day
data (10 arc-minutes). We first download the data:</p>
<div class="sourceCode" id="cb37"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://evolecolgroup.github.io/pastclim/reference/download_dataset.html" class="external-link">download_dataset</a></span><span class="op">(</span><span class="st">"WorldClim_2.1_HadGEM3-GC31-LL_ssp245_10m"</span><span class="op">)</span></span></code></pre></div>
<p>Let’s see what times are available:</p>
<div class="sourceCode" id="cb38"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://evolecolgroup.github.io/pastclim/reference/get_time_bp_steps.html" class="external-link">get_time_ce_steps</a></span><span class="op">(</span><span class="st">"WorldClim_2.1_HadGEM3-GC31-LL_ssp245_10m"</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">#&gt; [1] 2030 2050 2070 2090</span></span></code></pre>
<p>We will predict for 2090, the further prediction in the future that
is available.</p>
<p>Let’s now check the available variables:</p>
<div class="sourceCode" id="cb40"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://evolecolgroup.github.io/pastclim/reference/get_vars_for_dataset.html" class="external-link">get_vars_for_dataset</a></span><span class="op">(</span><span class="st">"WorldClim_2.1_HadGEM3-GC31-LL_ssp245_10m"</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">#&gt;  [1] "bio01" "bio02" "bio03" "bio04" "bio05" "bio06" "bio07" "bio08" "bio09"</span></span>
<span><span class="co">#&gt; [10] "bio10" "bio11" "bio12" "bio13" "bio14" "bio15" "bio16" "bio17" "bio18"</span></span>
<span><span class="co">#&gt; [19] "bio19"</span></span></code></pre>
<p>Note that future predictions do not include <em>altitude</em> (as
that does not change with time), so if we needed it, we would have to
copy it over from the present. However, it is not in our set of
uncorrelated variables that we used earlier, so we don’t need to worry
about it.</p>
<div class="sourceCode" id="cb42"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">climate_future</span> <span class="op">&lt;-</span> <span class="fu">pastclim</span><span class="fu">::</span><span class="fu"><a href="https://evolecolgroup.github.io/pastclim/reference/region_slice.html" class="external-link">region_slice</a></span><span class="op">(</span></span>
<span>  time_ce <span class="op">=</span> <span class="fl">2090</span>,</span>
<span>  bio_variables <span class="op">=</span> <span class="va">vars_uncor</span>,</span>
<span>  data <span class="op">=</span> <span class="st">"WorldClim_2.1_HadGEM3-GC31-LL_ssp245_10m"</span>,</span>
<span>  crop <span class="op">=</span> <span class="va">iberia_poly</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>And predict using the ensemble:</p>
<div class="sourceCode" id="cb43"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">prediction_future</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/predict_raster.html">predict_raster</a></span><span class="op">(</span><span class="va">lacerta_ensemble</span>, <span class="va">climate_future</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://dieghernan.github.io/tidyterra/reference/geom_spatraster.html" class="external-link">geom_spatraster</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">prediction_future</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>fill <span class="op">=</span> <span class="va">mean</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://dieghernan.github.io/tidyterra/reference/scale_terrain.html" class="external-link">scale_fill_terrain_c</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<p><img src="a0_tidysdm_overview_files/figure-html/plot_future-1.png" width="576"></p>
</div>
<div class="section level2">
<h2 id="dealing-with-extrapolation">Dealing with extrapolation<a class="anchor" aria-label="anchor" href="#dealing-with-extrapolation"></a>
</h2>
<p>The total area of projection of the model may include environmental
conditions which lie outside the range of conditions covered by the
calibration dataset. This phenomenon can lead to misinterpretation of
the SDM outcomes due to spatial extrapolation.</p>
<p><code>tidysdm</code> offers a couple of approaches to deal with this
problem. The simplest one is that we can clamp the environmental
variables to stay within the limits observed in the calibration set:</p>
<div class="sourceCode" id="cb44"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">climate_future_clamped</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/clamp_predictors.html">clamp_predictors</a></span><span class="op">(</span><span class="va">climate_future</span>, </span>
<span>                                           training <span class="op">=</span> <span class="va">lacerta_thin</span>,</span>
<span>                                           .col<span class="op">=</span> <span class="va">class</span><span class="op">)</span></span>
<span><span class="va">prediction_future_clamped</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/predict_raster.html">predict_raster</a></span><span class="op">(</span><span class="va">lacerta_ensemble</span>, </span>
<span>                                            raster <span class="op">=</span> <span class="va">climate_future_clamped</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://dieghernan.github.io/tidyterra/reference/geom_spatraster.html" class="external-link">geom_spatraster</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">prediction_future_clamped</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>fill <span class="op">=</span> <span class="va">mean</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://dieghernan.github.io/tidyterra/reference/scale_terrain.html" class="external-link">scale_fill_terrain_c</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<p><img src="a0_tidysdm_overview_files/figure-html/unnamed-chunk-27-1.png" width="576"></p>
<p>The predictions seem to have changed very little.</p>
<p>An alternative is to allow values to exceed the ranges of the
calibration set, but compute the Multivariate environmental similarity
surfaces (MESS) (Elith et al. 2010) to highlight areas where
extrapolation occurs and thus visualise the prediction’s
uncertainty.</p>
<p>We estimate the MESS for the same future time slice used above:</p>
<div class="sourceCode" id="cb45"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">lacerta_mess_future</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/extrapol_mess.html">extrapol_mess</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">climate_future</span>, </span>
<span>                                      training <span class="op">=</span> <span class="va">lacerta_thin</span>, </span>
<span>                                      .col <span class="op">=</span> <span class="st">"class"</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://dieghernan.github.io/tidyterra/reference/geom_spatraster.html" class="external-link">geom_spatraster</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">lacerta_mess_future</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_viridis.html" class="external-link">scale_fill_viridis_b</a></span><span class="op">(</span>na.value <span class="op">=</span> <span class="st">"transparent"</span><span class="op">)</span></span></code></pre></div>
<p><img src="a0_tidysdm_overview_files/figure-html/unnamed-chunk-28-1.png" width="576"></p>
<p>Extrapolation occurs in areas where MESS values are negative, with
the magnitude of the negative values indicating how extreme is in the
interpolation. From this plot, we can see that the area of extrapolation
is where the model already predicted a suitability of zero. This
explains why clamping did little to our predictions.</p>
<p>We can now overlay MESS values with current prediction to visualize
areas characterized by spatial extrapolation.</p>
<div class="sourceCode" id="cb46"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># subset mess </span></span>
<span><span class="va">lacerta_mess_future_subset</span> <span class="op">&lt;-</span> <span class="va">lacerta_mess_future</span></span>
<span><span class="va">lacerta_mess_future_subset</span><span class="op">[</span><span class="va">lacerta_mess_future_subset</span> <span class="op">&gt;=</span> <span class="fl">0</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="cn">NA</span></span>
<span><span class="va">lacerta_mess_future_subset</span><span class="op">[</span><span class="va">lacerta_mess_future_subset</span> <span class="op">&lt;</span> <span class="fl">0</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fl">1</span></span>
<span></span>
<span><span class="co"># convert into polygon</span></span>
<span><span class="va">lacerta_mess_future_subset</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rspatial.github.io/terra/reference/as.polygons.html" class="external-link">as.polygons</a></span><span class="op">(</span><span class="va">lacerta_mess_future_subset</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># plot as a mask </span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://dieghernan.github.io/tidyterra/reference/geom_spatraster.html" class="external-link">geom_spatraster</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">prediction_future</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_viridis.html" class="external-link">scale_fill_viridis_b</a></span><span class="op">(</span>na.value <span class="op">=</span> <span class="st">"transparent"</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggsf.html" class="external-link">geom_sf</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">lacerta_mess_future_subset</span>, </span>
<span>          fill<span class="op">=</span> <span class="st">"lightgray"</span>, alpha <span class="op">=</span> <span class="fl">0.5</span>, linewidth <span class="op">=</span> <span class="fl">0.5</span><span class="op">)</span></span></code></pre></div>
<p><img src="a0_tidysdm_overview_files/figure-html/unnamed-chunk-29-1.png" width="576"></p>
<p>Note that clamping and MESS are not only useful when making
predictions into the future, but also into the past and present (in the
latter case, it allows us to make sure that the
background/pseudoabsences do cover the full range of predictor variables
over the area of interest).</p>
<p>The <code>tidymodels</code> universe also includes functions to
estimate the area of applicability in the package <code>waywiser</code>,
which can be used with <code>tidysdm</code>.</p>
</div>
<div class="section level2">
<h2 id="visualising-the-contribution-of-individual-variables">Visualising the contribution of individual variables<a class="anchor" aria-label="anchor" href="#visualising-the-contribution-of-individual-variables"></a>
</h2>
<p>It is sometimes of interest to understand the relative contribution
of individual variables to the prediction. This is a complex task,
especially if there are interactions among variables. For simpler linear
models, it is possible to obtain marginal response curves (which show
the effect of a variable whilst keeping all other variables to their
mean) using <code>step_profile()</code> from the <code>recipes</code>
package. We use <code>step_profile()</code> to define a new recipe which
we can then bake to generate the appropriate dataset to make the
marginal prediction. We can then plot the predictions against the values
of the variable of interest. For example, to investigate the
contribution of <code>bio05</code>, we would:</p>
<div class="sourceCode" id="cb47"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">bio05_prof</span> <span class="op">&lt;-</span> <span class="va">lacerta_rec</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu">step_profile</span><span class="op">(</span><span class="op">-</span><span class="va">bio05</span>, profile <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/vars.html" class="external-link">vars</a></span><span class="op">(</span><span class="va">bio05</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu">prep</span><span class="op">(</span>training <span class="op">=</span> <span class="va">lacerta_thin</span><span class="op">)</span></span>
<span></span>
<span><span class="va">bio05_data</span> <span class="op">&lt;-</span> <span class="fu">bake</span><span class="op">(</span><span class="va">bio05_prof</span>, new_data <span class="op">=</span> <span class="cn">NULL</span><span class="op">)</span></span>
<span></span>
<span><span class="va">bio05_data</span> <span class="op">&lt;-</span> <span class="va">bio05_data</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span></span>
<span>    pred <span class="op">=</span> <span class="fu"><a href="https://rspatial.github.io/terra/reference/predict.html" class="external-link">predict</a></span><span class="op">(</span><span class="va">lacerta_ensemble</span>, <span class="va">bio05_data</span><span class="op">)</span><span class="op">$</span><span class="va">mean</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="va">bio05_data</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">bio05</span>, y <span class="op">=</span> <span class="va">pred</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html" class="external-link">geom_point</a></span><span class="op">(</span>alpha <span class="op">=</span> <span class="fl">.5</span>, cex <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span></code></pre></div>
<p><img src="a0_tidysdm_overview_files/figure-html/unnamed-chunk-30-1.png" width="576"></p>
<p>It is also possible to use <a href="https://modeloriented.github.io/DALEX/" class="external-link">DALEX</a>,to explore
<code>tidysdm</code> models; see more details in the <a href="https://evolecolgroup.github.io/tidysdm/dev/articles/a2_tidymodels_additions.html">tidymodels
additions</a> article.</p>
</div>
<div class="section level2">
<h2 id="repeated-ensembles">Repeated ensembles<a class="anchor" aria-label="anchor" href="#repeated-ensembles"></a>
</h2>
<p>The steps of thinning and sampling pseudo-absences can have a bit
impact on the performance of SDMs. As these steps are stochastic, it is
good practice to explore their effect by repeating them, and then
creating ensembles of models over these repeats. In
<code>tidysdm</code>, it is possible to create
<code>repeat_ensembles</code>. We start by creating a list of
<code>simple_ensembles</code>, by looping through the SDM pipeline. We
will just use two fast models to speed up the process.</p>
<div class="sourceCode" id="cb48"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># empty object to store the simple ensembles that we will create</span></span>
<span><span class="va">ensemble_list</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">123</span><span class="op">)</span> <span class="co"># make sure you set the seed OUTSIDE the loop</span></span>
<span><span class="kw">for</span> <span class="op">(</span><span class="va">i_repeat</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fl">3</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="co"># thin the data</span></span>
<span>  <span class="va">lacerta_thin_rep</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/thin_by_cell.html">thin_by_cell</a></span><span class="op">(</span><span class="va">lacerta</span>, raster <span class="op">=</span> <span class="va">climate_present</span><span class="op">)</span></span>
<span>  <span class="va">lacerta_thin_rep</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/thin_by_dist.html">thin_by_dist</a></span><span class="op">(</span><span class="va">lacerta_thin_rep</span>, dist_min <span class="op">=</span> <span class="fl">20000</span><span class="op">)</span></span>
<span>  <span class="co"># sample pseudo-absences</span></span>
<span>  <span class="va">lacerta_thin_rep</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/sample_pseudoabs.html">sample_pseudoabs</a></span><span class="op">(</span><span class="va">lacerta_thin_rep</span>,</span>
<span>    n <span class="op">=</span> <span class="fl">3</span> <span class="op">*</span> <span class="fu"><a href="https://rspatial.github.io/terra/reference/dimensions.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">lacerta_thin_rep</span><span class="op">)</span>,</span>
<span>    raster <span class="op">=</span> <span class="va">climate_present</span>,</span>
<span>    method <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"dist_min"</span>, <span class="fl">50000</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span>  <span class="co"># get climate</span></span>
<span>  <span class="va">lacerta_thin_rep</span> <span class="op">&lt;-</span> <span class="va">lacerta_thin_rep</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/bind_cols.html" class="external-link">bind_cols</a></span><span class="op">(</span><span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/extract.html" class="external-link">extract</a></span><span class="op">(</span><span class="va">climate_present</span>, <span class="va">lacerta_thin_rep</span>, ID <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="co"># create folds</span></span>
<span>  <span class="va">lacerta_thin_rep_cv</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://spatialsample.tidymodels.org/reference/spatial_block_cv.html" class="external-link">spatial_block_cv</a></span><span class="op">(</span><span class="va">lacerta_thin_rep</span>, v <span class="op">=</span> <span class="fl">5</span><span class="op">)</span></span>
<span>  <span class="co"># create a recipe</span></span>
<span>  <span class="va">lacerta_thin_rep_rec</span> <span class="op">&lt;-</span> <span class="fu">recipe</span><span class="op">(</span><span class="va">lacerta_thin_rep</span>, formula <span class="op">=</span> <span class="va">class</span> <span class="op">~</span> <span class="va">.</span><span class="op">)</span></span>
<span>  <span class="co"># create a workflow_set</span></span>
<span>  <span class="va">lacerta_thin_rep_models</span> <span class="op">&lt;-</span></span>
<span>    <span class="co"># create the workflow_set</span></span>
<span>    <span class="fu">workflow_set</span><span class="op">(</span></span>
<span>      preproc <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>default <span class="op">=</span> <span class="va">lacerta_thin_rep_rec</span><span class="op">)</span>,</span>
<span>      models <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>        <span class="co"># the standard glm specs</span></span>
<span>        glm <span class="op">=</span> <span class="fu"><a href="../reference/sdm_spec_glm.html">sdm_spec_glm</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>        <span class="co"># maxent specs with tuning</span></span>
<span>        maxent <span class="op">=</span> <span class="fu"><a href="../reference/sdm_spec_maxent.html">sdm_spec_maxent</a></span><span class="op">(</span><span class="op">)</span></span>
<span>      <span class="op">)</span>,</span>
<span>      <span class="co"># make all combinations of preproc and models,</span></span>
<span>      cross <span class="op">=</span> <span class="cn">TRUE</span></span>
<span>    <span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>    <span class="co"># tweak controls to store information needed later to create the ensemble</span></span>
<span>    <span class="fu">option_add</span><span class="op">(</span>control <span class="op">=</span> <span class="fu"><a href="../reference/control_ensemble.html">control_ensemble_grid</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span>  <span class="co"># train the model</span></span>
<span>  <span class="va">lacerta_thin_rep_models</span> <span class="op">&lt;-</span></span>
<span>    <span class="va">lacerta_thin_rep_models</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>    <span class="fu">workflow_map</span><span class="op">(</span><span class="st">"tune_grid"</span>,</span>
<span>      resamples <span class="op">=</span> <span class="va">lacerta_thin_rep_cv</span>, grid <span class="op">=</span> <span class="fl">10</span>,</span>
<span>      metrics <span class="op">=</span> <span class="fu"><a href="../reference/sdm_metric_set.html">sdm_metric_set</a></span><span class="op">(</span><span class="op">)</span>, verbose <span class="op">=</span> <span class="cn">TRUE</span></span>
<span>    <span class="op">)</span></span>
<span>  <span class="co"># make an simple ensemble and add it to the list</span></span>
<span>  <span class="va">ensemble_list</span><span class="op">[[</span><span class="va">i_repeat</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/simple_ensemble.html">simple_ensemble</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="../reference/add_member.html">add_member</a></span><span class="op">(</span><span class="va">lacerta_thin_rep_models</span>, metric <span class="op">=</span> <span class="st">"boyce_cont"</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span><span class="co">#&gt; <span style="color: #0000BB;">i</span>  <span style="color: #000000;">No tuning parameters. `fit_resamples()` will be attempted</span></span></span>
<span><span class="co">#&gt; <span style="color: #0000BB;">i</span> <span style="color: #000000;">1 of 2 resampling: default_glm</span></span></span>
<span><span class="co">#&gt; <span style="color: #00BB00;">✔</span> <span style="color: #000000;">1 of 2 resampling: default_glm (238ms)</span></span></span>
<span><span class="co">#&gt; <span style="color: #0000BB;">i</span> <span style="color: #000000;">2 of 2 tuning:     default_maxent</span></span></span>
<span><span class="co">#&gt; <span style="color: #00BB00;">✔</span> <span style="color: #000000;">2 of 2 tuning:     default_maxent (7.3s)</span></span></span>
<span><span class="co">#&gt; <span style="color: #0000BB;">i</span>  <span style="color: #000000;">No tuning parameters. `fit_resamples()` will be attempted</span></span></span>
<span><span class="co">#&gt; <span style="color: #0000BB;">i</span> <span style="color: #000000;">1 of 2 resampling: default_glm</span></span></span>
<span><span class="co">#&gt; <span style="color: #00BB00;">✔</span> <span style="color: #000000;">1 of 2 resampling: default_glm (247ms)</span></span></span>
<span><span class="co">#&gt; <span style="color: #0000BB;">i</span> <span style="color: #000000;">2 of 2 tuning:     default_maxent</span></span></span>
<span><span class="co">#&gt; <span style="color: #00BB00;">✔</span> <span style="color: #000000;">2 of 2 tuning:     default_maxent (7.1s)</span></span></span>
<span><span class="co">#&gt; <span style="color: #0000BB;">i</span>  <span style="color: #000000;">No tuning parameters. `fit_resamples()` will be attempted</span></span></span>
<span><span class="co">#&gt; <span style="color: #0000BB;">i</span> <span style="color: #000000;">1 of 2 resampling: default_glm</span></span></span>
<span><span class="co">#&gt; <span style="color: #00BB00;">✔</span> <span style="color: #000000;">1 of 2 resampling: default_glm (247ms)</span></span></span>
<span><span class="co">#&gt; <span style="color: #0000BB;">i</span> <span style="color: #000000;">2 of 2 tuning:     default_maxent</span></span></span>
<span><span class="co">#&gt; <span style="color: #00BB00;">✔</span> <span style="color: #000000;">2 of 2 tuning:     default_maxent (7.7s)</span></span></span></code></pre></div>
<p>Now we can create a <code>repeat_ensemble</code> from the list:</p>
<div class="sourceCode" id="cb49"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">lacerta_rep_ens</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/repeat_ensemble.html">repeat_ensemble</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="../reference/add_repeat.html">add_repeat</a></span><span class="op">(</span><span class="va">ensemble_list</span><span class="op">)</span></span>
<span><span class="va">lacerta_rep_ens</span></span>
<span><span class="co">#&gt; A repeat_ensemble of models</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Number of repeats:</span></span>
<span><span class="co">#&gt; <span style="color: #00BBBB;">•</span> 3</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Members:</span></span>
<span><span class="co">#&gt; <span style="color: #00BBBB;">•</span> default_glm</span></span>
<span><span class="co">#&gt; <span style="color: #00BBBB;">•</span> default_maxent</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Available metrics:</span></span>
<span><span class="co">#&gt; <span style="color: #00BBBB;">•</span> boyce_cont</span></span>
<span><span class="co">#&gt; <span style="color: #00BBBB;">•</span> roc_auc</span></span>
<span><span class="co">#&gt; <span style="color: #00BBBB;">•</span> tss_max</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Metric used to tune workflows:</span></span>
<span><span class="co">#&gt; <span style="color: #00BBBB;">•</span> boyce_cont</span></span></code></pre></div>
<p>We can summarise the goodness of fit of models for each repeat with
<code>collect_metrics()</code>, but there is no <code><a href="https://ggplot2.tidyverse.org/reference/autoplot.html" class="external-link">autoplot()</a></code>
function for <code>repeated_ensemble</code> objects.</p>
<p>We can then predict in the usual way (we will take the mean and
median of all models):</p>
<div class="sourceCode" id="cb50"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">lacerta_rep_ens</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/predict_raster.html">predict_raster</a></span><span class="op">(</span><span class="va">lacerta_rep_ens</span>, <span class="va">climate_present</span>,</span>
<span>  fun <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"mean"</span>, <span class="st">"median"</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://dieghernan.github.io/tidyterra/reference/geom_spatraster.html" class="external-link">geom_spatraster</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">lacerta_rep_ens</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>fill <span class="op">=</span> <span class="va">median</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://dieghernan.github.io/tidyterra/reference/scale_terrain.html" class="external-link">scale_fill_terrain_c</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<p><img src="a0_tidysdm_overview_files/figure-html/unnamed-chunk-34-1.png" width="576"></p>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by Michela Leonardi, Margherita Colucci, Andrea Vittorio Pozzi, Eleanor M.L. Scerri, Andrea Manica.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.1.</p>
</div>

    </footer>
</div>





  </body>
</html>
