<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="description" content="tidysdm">
<title>Examples of additional tidymodels features • tidysdm</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="16x16" href="../favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="../favicon-32x32.png">
<link rel="apple-touch-icon" type="image/png" sizes="180x180" href="../apple-touch-icon.png">
<link rel="apple-touch-icon" type="image/png" sizes="120x120" href="../apple-touch-icon-120x120.png">
<link rel="apple-touch-icon" type="image/png" sizes="76x76" href="../apple-touch-icon-76x76.png">
<link rel="apple-touch-icon" type="image/png" sizes="60x60" href="../apple-touch-icon-60x60.png">
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- bootstrap-toc --><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@v1.0.1/dist/bootstrap-toc.min.js" integrity="sha256-4veVQbu7//Lk5TSmc7YV48MxtMy98e26cf5MrgZYnwo=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- search --><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Examples of additional tidymodels features">
<meta property="og:description" content="tidysdm">
<meta property="og:image" content="https://evolecolgroup.github.io/tidysdm/logo.png">
<meta name="robots" content="noindex">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>
    

    <nav class="navbar fixed-top navbar-light navbar-expand-lg bg-light"><div class="container">
    
    <a class="navbar-brand me-2" href="../index.html">tidysdm</a>

    <small class="nav-text text-danger me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="In-development version">0.9.3.9002</small>

    
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item">
  <a class="nav-link" href="../reference/index.html">Reference</a>
</li>
<li class="active nav-item dropdown">
  <a href="#" class="nav-link dropdown-toggle" data-bs-toggle="dropdown" role="button" aria-expanded="false" aria-haspopup="true" id="dropdown-articles">Articles</a>
  <div class="dropdown-menu" aria-labelledby="dropdown-articles">
    <a class="dropdown-item" href="../articles/a0_tidysdm_overview.html">tidysdm overview</a>
    <a class="dropdown-item" href="../articles/a1_palaeodata_application.html">Application with palaeodata</a>
    <a class="dropdown-item" href="../articles/a2_tidymodels_additions.html">Examples of additional tidymodels features</a>
    <a class="dropdown-item" href="../articles/a3_troubleshooting.html">Troubleshooting models that fail</a>
  </div>
</li>
<li class="nav-item">
  <a class="nav-link" href="../news/index.html">Changelog</a>
</li>
      </ul>
<form class="form-inline my-2 my-lg-0" role="search">
        <input type="search" class="form-control me-sm-2" aria-label="Toggle navigation" name="search-input" data-search-index="../search.json" id="search-input" placeholder="Search for" autocomplete="off">
</form>

      <ul class="navbar-nav">
<li class="nav-item">
  <a class="external-link nav-link" href="https://github.com/EvolEcolGroup/tidysdm/" aria-label="github">
    <span class="fab fa fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>

    
  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="../logo.png" class="logo" alt=""><h1>Examples of additional tidymodels features</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/EvolEcolGroup/tidysdm/blob/HEAD/vignettes/a2_tidymodels_additions.Rmd" class="external-link"><code>vignettes/a2_tidymodels_additions.Rmd</code></a></small>
      <div class="d-none name"><code>a2_tidymodels_additions.Rmd</code></div>
    </div>

    
    
<div class="section level2">
<h2 id="additional-features-of-tidymodels">Additional features of <code>tidymodels</code><a class="anchor" aria-label="anchor" href="#additional-features-of-tidymodels"></a>
</h2>
<p>In this vignette, we illustrate how a number of features from
<code>tidymodels</code> can be used to enhance a conventional SDM
pipeline. We recommend users first become familiar with
<code>tidymodels</code>; there are a number of excellent tutorials (both
introductory and advanced) on its dedicated <a href="https://www.tidymodels.org/" class="external-link">website</a> We reuse the example on
the Iberian lizard that we used in the <a href="https://evolecolgroup.github.io/tidysdm/articles/a0_tidysdm_overview.html"><code>tidysdm</code>
overview</a> article.</p>
</div>
<div class="section level2">
<h2 id="exploring-models-with-dalex">Exploring models with <code>DALEX</code><a class="anchor" aria-label="anchor" href="#exploring-models-with-dalex"></a>
</h2>
<p>An issue with machine learning algorithms is that it is not easy to
understand the role of different variables in giving the final
prediction. A number of packages have been created to explore and
explain the behaviour of ML algorithms, such as those used in
<code>tidysdm</code>. In the <a href="https://evolecolgroup.github.io/tidysdm/articles/a0_tidysdm_overview.html"><code>tidysdm</code>
overview</a> article, we illustrated how to use <code>recipes</code> to
create profiles.</p>
<p>Here we demonstrate how to use <a href="https://modeloriented.github.io/DALEX/" class="external-link">DALEX</a>, an excellent
package that has methods to deal with <code>tidymodels</code>.
<code>tidysdm</code> contains additional functions that allow use to use
the DALEX functions directly on <code>tidysdm</code> ensembles.</p>
<p>We will use a simple ensemble that we built in the</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/EvolEcolGroup/tidysdm" class="external-link">tidysdm</a></span><span class="op">)</span></span>
<span><span class="co">#&gt; Loading required package: tidymodels</span></span>
<span><span class="co">#&gt; ── <span style="font-weight: bold;">Attaching packages</span> ────────────────────────────────────── tidymodels 1.1.1 ──</span></span>
<span><span class="co">#&gt; <span style="color: #00BB00;">✔</span> <span style="color: #0000BB;">broom       </span> 1.0.5      <span style="color: #00BB00;">✔</span> <span style="color: #0000BB;">recipes     </span> 1.0.10</span></span>
<span><span class="co">#&gt; <span style="color: #00BB00;">✔</span> <span style="color: #0000BB;">dials       </span> 1.2.1      <span style="color: #00BB00;">✔</span> <span style="color: #0000BB;">rsample     </span> 1.2.0 </span></span>
<span><span class="co">#&gt; <span style="color: #00BB00;">✔</span> <span style="color: #0000BB;">dplyr       </span> 1.1.4      <span style="color: #00BB00;">✔</span> <span style="color: #0000BB;">tibble      </span> 3.2.1 </span></span>
<span><span class="co">#&gt; <span style="color: #00BB00;">✔</span> <span style="color: #0000BB;">ggplot2     </span> 3.5.0      <span style="color: #00BB00;">✔</span> <span style="color: #0000BB;">tidyr       </span> 1.3.1 </span></span>
<span><span class="co">#&gt; <span style="color: #00BB00;">✔</span> <span style="color: #0000BB;">infer       </span> 1.0.6      <span style="color: #00BB00;">✔</span> <span style="color: #0000BB;">tune        </span> 1.1.2 </span></span>
<span><span class="co">#&gt; <span style="color: #00BB00;">✔</span> <span style="color: #0000BB;">modeldata   </span> 1.3.0      <span style="color: #00BB00;">✔</span> <span style="color: #0000BB;">workflows   </span> 1.1.4 </span></span>
<span><span class="co">#&gt; <span style="color: #00BB00;">✔</span> <span style="color: #0000BB;">parsnip     </span> 1.2.0      <span style="color: #00BB00;">✔</span> <span style="color: #0000BB;">workflowsets</span> 1.0.1 </span></span>
<span><span class="co">#&gt; <span style="color: #00BB00;">✔</span> <span style="color: #0000BB;">purrr       </span> 1.0.2      <span style="color: #00BB00;">✔</span> <span style="color: #0000BB;">yardstick   </span> 1.3.0</span></span>
<span><span class="co">#&gt; ── <span style="font-weight: bold;">Conflicts</span> ───────────────────────────────────────── tidymodels_conflicts() ──</span></span>
<span><span class="co">#&gt; <span style="color: #BB0000;">✖</span> <span style="color: #0000BB;">purrr</span>::<span style="color: #00BB00;">discard()</span> masks <span style="color: #0000BB;">scales</span>::discard()</span></span>
<span><span class="co">#&gt; <span style="color: #BB0000;">✖</span> <span style="color: #0000BB;">dplyr</span>::<span style="color: #00BB00;">filter()</span>  masks <span style="color: #0000BB;">stats</span>::filter()</span></span>
<span><span class="co">#&gt; <span style="color: #BB0000;">✖</span> <span style="color: #0000BB;">dplyr</span>::<span style="color: #00BB00;">lag()</span>     masks <span style="color: #0000BB;">stats</span>::lag()</span></span>
<span><span class="co">#&gt; <span style="color: #BB0000;">✖</span> <span style="color: #0000BB;">recipes</span>::<span style="color: #00BB00;">step()</span>  masks <span style="color: #0000BB;">stats</span>::step()</span></span>
<span><span class="co">#&gt; <span style="color: #0000BB;">•</span> Learn how to get started at <span style="color: #00BB00;">https://www.tidymodels.org/start/</span></span></span>
<span><span class="co">#&gt; Loading required package: spatialsample</span></span>
<span><span class="va">lacerta_ensemble</span></span>
<span><span class="co">#&gt; A simple_ensemble of models</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Members:</span></span>
<span><span class="co">#&gt; <span style="color: #00BBBB;">•</span> default_glm</span></span>
<span><span class="co">#&gt; <span style="color: #00BBBB;">•</span> default_rf</span></span>
<span><span class="co">#&gt; <span style="color: #00BBBB;">•</span> default_gbm</span></span>
<span><span class="co">#&gt; <span style="color: #00BBBB;">•</span> default_maxent</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Available metrics:</span></span>
<span><span class="co">#&gt; <span style="color: #00BBBB;">•</span> boyce_cont</span></span>
<span><span class="co">#&gt; <span style="color: #00BBBB;">•</span> roc_auc</span></span>
<span><span class="co">#&gt; <span style="color: #00BBBB;">•</span> tss_max</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Metric used to tune workflows:</span></span>
<span><span class="co">#&gt; <span style="color: #00BBBB;">•</span> boyce_cont</span></span></code></pre></div>
<p>The first step in DALEX is to create an explainer object, which can
then be queried by different functions in the package, to turn the
explainer into an explanation (following the DALEX lingo). As a first
step, we use the custom function <code>explain_tidysdm</code> to
generate our explainer:</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">explainer_lacerta_ens</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/explain_tidysdm.html">explain_tidysdm</a></span><span class="op">(</span><span class="va">lacerta_ensemble</span><span class="op">)</span></span>
<span><span class="co">#&gt; Preparation of a new explainer is initiated</span></span>
<span><span class="co">#&gt;   -&gt; model label       :  data.frame  (  default  )</span></span>
<span><span class="co">#&gt;   -&gt; data              :  452  rows  4  cols </span></span>
<span><span class="co">#&gt;   -&gt; data              :  tibble converted into a data.frame </span></span>
<span><span class="co">#&gt;   -&gt; target variable   :  452  values </span></span>
<span><span class="co">#&gt;   -&gt; predict function  :  predict_function </span></span>
<span><span class="co">#&gt;   -&gt; predicted values  :  No value for predict function target column. (  default  )</span></span>
<span><span class="co">#&gt; [18:09:04] WARNING: src/learner.cc:553: </span></span>
<span><span class="co">#&gt;   If you are loading a serialized model (like pickle in Python, RDS in R) generated by</span></span>
<span><span class="co">#&gt;   older XGBoost, please export the model by calling `Booster.save_model` from that version</span></span>
<span><span class="co">#&gt;   first, then load it back in current version. See:</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;     https://xgboost.readthedocs.io/en/latest/tutorials/saving_model.html</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;   for more details about differences between saving model and serializing.</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;   -&gt; model_info        :  package tidysdm , ver. 0.9.3.9002 , task classification (  default  ) </span></span>
<span><span class="co">#&gt;   -&gt; model_info        :  type set to  classification </span></span>
<span><span class="co">#&gt;   -&gt; predicted values  :  numerical, min =  0.0004084954 , mean =  0.238296 , max =  0.9561616  </span></span>
<span><span class="co">#&gt;   -&gt; residual function :  difference between y and yhat (  default  )</span></span>
<span><span class="co">#&gt;   -&gt; residuals         :  numerical, min =  -0.5010351 , mean =  0.01170401 , max =  0.6113744  </span></span>
<span><span class="co">#&gt;   A new explainer has been created!</span></span></code></pre></div>
<p>Now that we have our explainer, we can explore variable importance
for the ensemble:</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://modeloriented.github.io/DALEX/" class="external-link">DALEX</a></span><span class="op">)</span></span>
<span><span class="co">#&gt; Welcome to DALEX (version: 2.4.3).</span></span>
<span><span class="co">#&gt; Find examples and detailed introduction at: http://ema.drwhy.ai/</span></span>
<span><span class="co">#&gt; Additional features will be available after installation of: ggpubr.</span></span>
<span><span class="co">#&gt; Use 'install_dependencies()' to get all suggested dependencies</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Attaching package: 'DALEX'</span></span>
<span><span class="co">#&gt; The following object is masked from 'package:dplyr':</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;     explain</span></span>
<span><span class="va">vip_ensemble</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://modeloriented.github.io/DALEX/reference/model_parts.html" class="external-link">model_parts</a></span><span class="op">(</span>explainer <span class="op">=</span> <span class="va">explainer_lacerta_ens</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rspatial.github.io/terra/reference/plot.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">vip_ensemble</span><span class="op">)</span></span></code></pre></div>
<p><img src="a2_tidymodels_additions_files/figure-html/vip-1.png" width="576"></p>
<p>Or generate partial dependency plots for a given variable
(e.g. bio05):</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">pdp_bio05</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://modeloriented.github.io/DALEX/reference/model_profile.html" class="external-link">model_profile</a></span><span class="op">(</span><span class="va">explainer_lacerta_ens</span>, N <span class="op">=</span> <span class="fl">500</span>, variables <span class="op">=</span> <span class="st">"bio05"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rspatial.github.io/terra/reference/plot.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">pdp_bio05</span><span class="op">)</span></span></code></pre></div>
<p><img src="a2_tidymodels_additions_files/figure-html/pdp-1.png" width="576"></p>
<p>There are many other functions in DALEX that can be applied to the
explainer to further explore the behaviour of the model; see several
tutorial on <a href="https://modeloriented.github.io/DALEX/" class="external-link uri">https://modeloriented.github.io/DALEX/</a></p>
<p>It is also possible to explore the individual models that make up the
ensemble:</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">explainer_list</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/explain_tidysdm.html">explain_tidysdm</a></span><span class="op">(</span><span class="fu">tidysdm</span><span class="fu">::</span><span class="va"><a href="../reference/lacerta_ensemble.html">lacerta_ensemble</a></span>, by_workflow <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="co">#&gt; Preparation of a new explainer is initiated</span></span>
<span><span class="co">#&gt;   -&gt; model label       :  default_glm </span></span>
<span><span class="co">#&gt;   -&gt; data              :  452  rows  4  cols </span></span>
<span><span class="co">#&gt;   -&gt; data              :  tibble converted into a data.frame </span></span>
<span><span class="co">#&gt;   -&gt; target variable   :  452  values </span></span>
<span><span class="co">#&gt;   -&gt; predict function  :  yhat.workflow  will be used (  default  )</span></span>
<span><span class="co">#&gt;   -&gt; predicted values  :  No value for predict function target column. (  default  )</span></span>
<span><span class="co">#&gt;   -&gt; model_info        :  package tidymodels , ver. 1.1.1 , task classification (  default  ) </span></span>
<span><span class="co">#&gt;   -&gt; model_info        :  type set to  classification </span></span>
<span><span class="co">#&gt;   -&gt; predicted values  :  numerical, min =  0.004906125 , mean =  0.75 , max =  0.9990497  </span></span>
<span><span class="co">#&gt;   -&gt; residual function :  difference between y and yhat (  default  )</span></span>
<span><span class="co">#&gt;   -&gt; residuals         :  numerical, min =  -0.9678673 , mean =  -7.873284e-18 , max =  0.953622  </span></span>
<span><span class="co">#&gt;   A new explainer has been created!  </span></span>
<span><span class="co">#&gt; Preparation of a new explainer is initiated</span></span>
<span><span class="co">#&gt;   -&gt; model label       :  default_rf </span></span>
<span><span class="co">#&gt;   -&gt; data              :  452  rows  4  cols </span></span>
<span><span class="co">#&gt;   -&gt; data              :  tibble converted into a data.frame </span></span>
<span><span class="co">#&gt;   -&gt; target variable   :  452  values </span></span>
<span><span class="co">#&gt;   -&gt; predict function  :  yhat.workflow  will be used (  default  )</span></span>
<span><span class="co">#&gt;   -&gt; predicted values  :  No value for predict function target column. (  default  )</span></span>
<span><span class="co">#&gt;   -&gt; model_info        :  package tidymodels , ver. 1.1.1 , task classification (  default  ) </span></span>
<span><span class="co">#&gt;   -&gt; model_info        :  type set to  classification </span></span>
<span><span class="co">#&gt;   -&gt; predicted values  :  numerical, min =  0 , mean =  0.7509861 , max =  1  </span></span>
<span><span class="co">#&gt;   -&gt; residual function :  difference between y and yhat (  default  )</span></span>
<span><span class="co">#&gt;   -&gt; residuals         :  numerical, min =  -0.5503262 , mean =  -0.0009860672 , max =  0.5657683  </span></span>
<span><span class="co">#&gt;   A new explainer has been created!  </span></span>
<span><span class="co">#&gt; Preparation of a new explainer is initiated</span></span>
<span><span class="co">#&gt;   -&gt; model label       :  default_gbm </span></span>
<span><span class="co">#&gt;   -&gt; data              :  452  rows  4  cols </span></span>
<span><span class="co">#&gt;   -&gt; data              :  tibble converted into a data.frame </span></span>
<span><span class="co">#&gt;   -&gt; target variable   :  452  values </span></span>
<span><span class="co">#&gt;   -&gt; predict function  :  yhat.workflow  will be used (  default  )</span></span>
<span><span class="co">#&gt;   -&gt; predicted values  :  No value for predict function target column. (  default  )</span></span>
<span><span class="co">#&gt;   -&gt; model_info        :  package tidymodels , ver. 1.1.1 , task classification (  default  ) </span></span>
<span><span class="co">#&gt;   -&gt; model_info        :  type set to  classification </span></span>
<span><span class="co">#&gt;   -&gt; predicted values  :  numerical, min =  2.861023e-06 , mean =  0.7500019 , max =  0.9999918  </span></span>
<span><span class="co">#&gt;   -&gt; residual function :  difference between y and yhat (  default  )</span></span>
<span><span class="co">#&gt;   -&gt; residuals         :  numerical, min =  -0.1819368 , mean =  -1.920316e-06 , max =  0.08649289  </span></span>
<span><span class="co">#&gt;   A new explainer has been created!  </span></span>
<span><span class="co">#&gt; Preparation of a new explainer is initiated</span></span>
<span><span class="co">#&gt;   -&gt; model label       :  default_maxent </span></span>
<span><span class="co">#&gt;   -&gt; data              :  452  rows  4  cols </span></span>
<span><span class="co">#&gt;   -&gt; data              :  tibble converted into a data.frame </span></span>
<span><span class="co">#&gt;   -&gt; target variable   :  452  values </span></span>
<span><span class="co">#&gt;   -&gt; predict function  :  yhat.workflow  will be used (  default  )</span></span>
<span><span class="co">#&gt;   -&gt; predicted values  :  No value for predict function target column. (  default  )</span></span>
<span><span class="co">#&gt;   -&gt; model_info        :  package tidymodels , ver. 1.1.1 , task classification (  default  ) </span></span>
<span><span class="co">#&gt;   -&gt; model_info        :  type set to  classification </span></span>
<span><span class="co">#&gt;   -&gt; predicted values  :  numerical, min =  0.1350514 , mean =  0.795828 , max =  0.9995933  </span></span>
<span><span class="co">#&gt;   -&gt; residual function :  difference between y and yhat (  default  )</span></span>
<span><span class="co">#&gt;   -&gt; residuals         :  numerical, min =  -0.8946667 , mean =  -0.04582804 , max =  0.561125  </span></span>
<span><span class="co">#&gt;   A new explainer has been created!</span></span></code></pre></div>
<p>The resulting list can be then used to build lists of explanations,
which can then be plotted.</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">profile_list</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="va">explainer_list</span>, <span class="va">model_profile</span>,</span>
<span>  N <span class="op">=</span> <span class="fl">500</span>,</span>
<span>  variables <span class="op">=</span> <span class="st">"bio05"</span></span>
<span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rspatial.github.io/terra/reference/plot.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">profile_list</span><span class="op">)</span></span></code></pre></div>
<p><img src="a2_tidymodels_additions_files/figure-html/profile-1.png" width="576"></p>
</div>
<div class="section level2">
<h2 id="the-initial-split">The initial split<a class="anchor" aria-label="anchor" href="#the-initial-split"></a>
</h2>
<p>The standard approach in <code>tidymodels</code> is to make an
initial split of the data into a test and a training set. We will use
retain 20% of the data (1/5) for the testing set, and use the rest for
training.</p>
<p>We start by loading a set of presences and absences and their
associated climate, analogous to the one that we generated in the <a href="https://evolecolgroup.github.io/tidysdm/articles/a0_tidysdm_overview.html"><code>tidysdm</code>
overview</a> article:</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/EvolEcolGroup/tidysdm" class="external-link">tidysdm</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://r-spatial.github.io/sf/" class="external-link">sf</a></span><span class="op">)</span></span>
<span><span class="co">#&gt; Linking to GEOS 3.10.2, GDAL 3.4.1, PROJ 8.2.1; sf_use_s2() is TRUE</span></span>
<span><span class="va">lacerta_thin</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rspatial.github.io/terra/reference/serialize.html" class="external-link">readRDS</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/system.file.html" class="external-link">system.file</a></span><span class="op">(</span><span class="st">"extdata/lacerta_climate_sf.RDS"</span>,</span>
<span>  package <span class="op">=</span> <span class="st">"tidysdm"</span></span>
<span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>We then use <code>spatial_initial_split</code> to do the split, using
a <code>spatial_block_cv</code> scheme to partition the data:</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">1005</span><span class="op">)</span></span>
<span><span class="va">lacerta_initial</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/spatial_initial_split.html">spatial_initial_split</a></span><span class="op">(</span><span class="va">lacerta_thin</span>,</span>
<span>  prop <span class="op">=</span> <span class="fl">1</span> <span class="op">/</span> <span class="fl">5</span>, <span class="va">spatial_block_cv</span></span>
<span><span class="op">)</span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/autoplot.html" class="external-link">autoplot</a></span><span class="op">(</span><span class="va">lacerta_initial</span><span class="op">)</span></span></code></pre></div>
<p><img src="a2_tidymodels_additions_files/figure-html/initial_split-1.png" width="576"></p>
<p>And check the balance of presences vs pseudoabsences:</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/check_splits_balance.html">check_splits_balance</a></span><span class="op">(</span><span class="va">lacerta_initial</span>, <span class="va">class</span><span class="op">)</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 1 × 4</span></span></span>
<span><span class="co">#&gt;   presence_test pseudoabs_test presence_train pseudoabs_train</span></span>
<span><span class="co">#&gt;           <span style="color: #949494; font-style: italic;">&lt;int&gt;</span>          <span style="color: #949494; font-style: italic;">&lt;int&gt;</span>          <span style="color: #949494; font-style: italic;">&lt;int&gt;</span>           <span style="color: #949494; font-style: italic;">&lt;int&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">1</span>            88            267             25              72</span></span></code></pre></div>
<p>We can now extract the training set from our
<code>lacerta_initial</code> split, and sample folds to set up cross
validation (note that we set the <code>cellsize</code> and
<code>offset</code> based on the full dataset,
<code>lacerta_thin</code>; this allows us to use the same grid we used
for the <code>initial_split</code>).</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">1005</span><span class="op">)</span></span>
<span><span class="va">lacerta_training</span> <span class="op">&lt;-</span> <span class="fu">training</span><span class="op">(</span><span class="va">lacerta_initial</span><span class="op">)</span></span>
<span><span class="va">lacerta_cv</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://spatialsample.tidymodels.org/reference/spatial_block_cv.html" class="external-link">spatial_block_cv</a></span><span class="op">(</span><span class="va">lacerta_training</span>,</span>
<span>  v <span class="op">=</span> <span class="fl">5</span>,</span>
<span>  cellsize <span class="op">=</span> <span class="fu"><a href="../reference/grid_cellsize.html">grid_cellsize</a></span><span class="op">(</span><span class="va">lacerta_thin</span><span class="op">)</span>,</span>
<span>  offset <span class="op">=</span> <span class="fu"><a href="../reference/grid_offset.html">grid_offset</a></span><span class="op">(</span><span class="va">lacerta_thin</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/autoplot.html" class="external-link">autoplot</a></span><span class="op">(</span><span class="va">lacerta_cv</span><span class="op">)</span></span></code></pre></div>
<p><img src="a2_tidymodels_additions_files/figure-html/training_cv-1.png" width="576"></p>
<p>And check the balance in the dataset:</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/check_splits_balance.html">check_splits_balance</a></span><span class="op">(</span><span class="va">lacerta_cv</span>, <span class="va">class</span><span class="op">)</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 5 × 4</span></span></span>
<span><span class="co">#&gt;   presence_assessment pseudoabs_assessment presence_analysis pseudoabs_analysis</span></span>
<span><span class="co">#&gt;                 <span style="color: #949494; font-style: italic;">&lt;int&gt;</span>                <span style="color: #949494; font-style: italic;">&lt;int&gt;</span>             <span style="color: #949494; font-style: italic;">&lt;int&gt;</span>              <span style="color: #949494; font-style: italic;">&lt;int&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">1</span>                  74                  197                14                 70</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">2</span>                  59                  225                29                 42</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">3</span>                  73                  220                15                 47</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">4</span>                  76                  209                12                 58</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">5</span>                  70                  218                18                 49</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="different-recipes-for-certain-models">Different recipes for certain models<a class="anchor" aria-label="anchor" href="#different-recipes-for-certain-models"></a>
</h2>
<p>Only certain type of models (e.g. glm, svm) struggle with correlated
variables; other algorithms, such as random forests, can handle
correlated variables. So, we will create two recipes, one with all
variables, and one only with the variables that are uncorrelated:</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">lacerta_rec_all</span> <span class="op">&lt;-</span> <span class="fu">recipe</span><span class="op">(</span><span class="va">lacerta_thin</span>, formula <span class="op">=</span> <span class="va">class</span> <span class="op">~</span> <span class="va">.</span><span class="op">)</span></span>
<span><span class="va">lacerta_rec_uncor</span> <span class="op">&lt;-</span> <span class="va">lacerta_rec_all</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu">step_rm</span><span class="op">(</span><span class="fu"><a href="https://tidyselect.r-lib.org/reference/all_of.html" class="external-link">all_of</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span></span>
<span>    <span class="st">"bio01"</span>, <span class="st">"bio02"</span>, <span class="st">"bio03"</span>, <span class="st">"bio04"</span>, <span class="st">"bio07"</span>, <span class="st">"bio08"</span>,</span>
<span>    <span class="st">"bio09"</span>, <span class="st">"bio10"</span>, <span class="st">"bio11"</span>, <span class="st">"bio12"</span>, <span class="st">"bio14"</span>, <span class="st">"bio16"</span>,</span>
<span>    <span class="st">"bio17"</span>, <span class="st">"bio18"</span>, <span class="st">"bio19"</span>, <span class="st">"altitude"</span></span>
<span>  <span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">lacerta_rec_uncor</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; <span style="color: #00BBBB;">──</span> <span style="font-weight: bold;">Recipe</span> <span style="color: #00BBBB;">──────────────────────────────────────────────────────────────────────</span></span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; ── Inputs</span></span>
<span><span class="co">#&gt; Number of variables by role</span></span>
<span><span class="co">#&gt; outcome:    1</span></span>
<span><span class="co">#&gt; predictor: 20</span></span>
<span><span class="co">#&gt; coords:     2</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; ── Operations</span></span>
<span><span class="co">#&gt; <span style="color: #00BBBB;">•</span> Variables removed: <span style="color: #0000BB;">all_of(c("bio01", "bio02", "bio03", "bio04", "bio07",</span></span></span>
<span><span class="co">#&gt;   <span style="color: #0000BB;">"bio08", "bio09", "bio10", "bio11", "bio12", "bio14", "bio16", "bio17",</span></span></span>
<span><span class="co">#&gt;   <span style="color: #0000BB;">"bio18", "bio19", "altitude"))</span></span></span></code></pre></div>
<p>And now use these two recipes in a <code>workflowset</code> (we will
keep it small for computational time), selecting the appropriate recipe
for each model. We will include a model (polynomial support vector
machines, or SVM) which does not have a wrapper in <code>tidysdm</code>
for creating a model specification. However, we can use a standard model
spec from <code>yardstick</code>:</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">lacerta_models</span> <span class="op">&lt;-</span></span>
<span>  <span class="co"># create the workflow_set</span></span>
<span>  <span class="fu">workflow_set</span><span class="op">(</span></span>
<span>    preproc <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>      uncor <span class="op">=</span> <span class="va">lacerta_rec_uncor</span>, <span class="co"># recipe for the glm</span></span>
<span>      all <span class="op">=</span> <span class="va">lacerta_rec_all</span>, <span class="co"># recipe for the random forest</span></span>
<span>      all <span class="op">=</span> <span class="va">lacerta_rec_uncor</span> <span class="co"># recipe for svm</span></span>
<span>    <span class="op">)</span>,</span>
<span>    models <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>      <span class="co"># the standard glm specs</span></span>
<span>      glm <span class="op">=</span> <span class="fu"><a href="../reference/sdm_spec_glm.html">sdm_spec_glm</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>      <span class="co"># rf specs with tuning</span></span>
<span>      rf <span class="op">=</span> <span class="fu"><a href="../reference/sdm_spec_rand_forest.html">sdm_spec_rf</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>      <span class="co"># svm specs with tuning</span></span>
<span>      svm <span class="op">=</span> <span class="fu">parsnip</span><span class="fu">::</span><span class="fu"><a href="https://parsnip.tidymodels.org/reference/svm_poly.html" class="external-link">svm_poly</a></span><span class="op">(</span></span>
<span>        cost <span class="op">=</span> <span class="fu">tune</span><span class="op">(</span><span class="op">)</span>,</span>
<span>        degree <span class="op">=</span> <span class="fu">tune</span><span class="op">(</span><span class="op">)</span></span>
<span>      <span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>        <span class="fu">parsnip</span><span class="fu">::</span><span class="fu"><a href="https://parsnip.tidymodels.org/reference/set_engine.html" class="external-link">set_engine</a></span><span class="op">(</span><span class="st">"kernlab"</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>        <span class="fu">parsnip</span><span class="fu">::</span><span class="fu"><a href="https://parsnip.tidymodels.org/reference/set_args.html" class="external-link">set_mode</a></span><span class="op">(</span><span class="st">"classification"</span><span class="op">)</span></span>
<span>    <span class="op">)</span>,</span>
<span>    <span class="co"># make all combinations of preproc and models,</span></span>
<span>    cross <span class="op">=</span> <span class="cn">FALSE</span></span>
<span>  <span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="co"># tweak controls to store information needed later to create the ensemble</span></span>
<span>  <span class="co"># note that we use the bayes version as we will use a Bayes search (see later)</span></span>
<span>  <span class="fu">option_add</span><span class="op">(</span>control <span class="op">=</span> <span class="fu">stacks</span><span class="fu">::</span><span class="fu"><a href="https://stacks.tidymodels.org/reference/control_stack.html" class="external-link">control_stack_bayes</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>We can now use the block CV folds to tune and assess the models. Note
that there are multiple tuning approaches, besides the standard grid
method. Here we will use <code>tune_bayes</code> from the
<code>tune</code> package (see its help page to see how a Gaussian
Process model is used to choose parameter combinations).</p>
<p>This tuning method (as opposed to use a standard grid) does not allow
for hyper-parameters with unknown limits, but <code>mtry</code> for
random forest is undefined as its upper range depends on the number of
variables in the dataset. So, before tuning, we need to finalise
<code>mtry</code> by informing the set dials with the actual data:</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">rf_param</span> <span class="op">&lt;-</span> <span class="va">lacerta_models</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="co"># extract the rf workflow</span></span>
<span>  <span class="fu">extract_workflow</span><span class="op">(</span><span class="st">"all_rf"</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="co"># extract its parameters dials (used to tune)</span></span>
<span>  <span class="fu">extract_parameter_set_dials</span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="co"># give it the predictors to finalize mtry</span></span>
<span>  <span class="fu">finalize</span><span class="op">(</span>x <span class="op">=</span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_geometry.html" class="external-link">st_drop_geometry</a></span><span class="op">(</span><span class="va">lacerta_thin</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="op">-</span><span class="va">class</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># now update the workflowset with the new parameter info</span></span>
<span><span class="va">lacerta_models</span> <span class="op">&lt;-</span> <span class="va">lacerta_models</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu">option_add</span><span class="op">(</span>param_info <span class="op">=</span> <span class="va">rf_param</span>, id <span class="op">=</span> <span class="st">"all_rf"</span><span class="op">)</span></span></code></pre></div>
<p>And now we can tune the models:</p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">1234567</span><span class="op">)</span></span>
<span><span class="va">lacerta_models</span> <span class="op">&lt;-</span></span>
<span>  <span class="va">lacerta_models</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu">workflow_map</span><span class="op">(</span><span class="st">"tune_bayes"</span>,</span>
<span>    resamples <span class="op">=</span> <span class="va">lacerta_cv</span>, initial <span class="op">=</span> <span class="fl">8</span>,</span>
<span>    metrics <span class="op">=</span> <span class="fu"><a href="../reference/sdm_metric_set.html">sdm_metric_set</a></span><span class="op">(</span><span class="op">)</span>, verbose <span class="op">=</span> <span class="cn">TRUE</span></span>
<span>  <span class="op">)</span></span>
<span><span class="co">#&gt; <span style="color: #0000BB;">i</span>  <span style="color: #000000;">No tuning parameters. `fit_resamples()` will be attempted</span></span></span>
<span><span class="co">#&gt; <span style="color: #0000BB;">i</span> <span style="color: #000000;">1 of 3 resampling: uncor_glm</span></span></span>
<span><span class="co">#&gt; <span style="color: #00BB00;">✔</span> <span style="color: #000000;">1 of 3 resampling: uncor_glm (348ms)</span></span></span>
<span><span class="co">#&gt; <span style="color: #0000BB;">i</span> <span style="color: #000000;">2 of 3 tuning:     all_rf</span></span></span>
<span><span class="co">#&gt; <span style="color: #BBBB00;">!</span> No improvement for 10 iterations; returning current results.</span></span>
<span><span class="co">#&gt; <span style="color: #00BB00;">✔</span> <span style="color: #000000;">2 of 3 tuning:     all_rf (17.6s)</span></span></span>
<span><span class="co">#&gt; <span style="color: #0000BB;">i</span> <span style="color: #000000;">3 of 3 tuning:     all_svm</span></span></span>
<span><span class="co">#&gt; <span style="color: #00BB00;">✔</span> <span style="color: #000000;">3 of 3 tuning:     all_svm (25.2s)</span></span></span></code></pre></div>
<p>We can have a look at the performance of our models with:</p>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/autoplot.html" class="external-link">autoplot</a></span><span class="op">(</span><span class="va">lacerta_models</span><span class="op">)</span></span></code></pre></div>
<p><img src="a2_tidymodels_additions_files/figure-html/unnamed-chunk-9-1.png" width="700"></p>
</div>
<div class="section level2">
<h2 id="stack-ensembles">Stack ensembles<a class="anchor" aria-label="anchor" href="#stack-ensembles"></a>
</h2>
<p>Instead of building a simple ensemble with the best version of each
model type, we can build a stack ensemble, as implemented in the package
<code>stacks</code>. Stacking uses a meta-learning algorithm to learn
how to best combine multiple models, including multiple versions of the
same algorithm with different hyper-parameters.</p>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://stacks.tidymodels.org/" class="external-link">stacks</a></span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">1005</span><span class="op">)</span></span>
<span><span class="va">lacerta_stack</span> <span class="op">&lt;-</span></span>
<span>  <span class="co"># initialize the stack</span></span>
<span>  <span class="fu"><a href="https://stacks.tidymodels.org/reference/stacks.html" class="external-link">stacks</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="co"># add candidate members</span></span>
<span>  <span class="fu"><a href="https://stacks.tidymodels.org/reference/add_candidates.html" class="external-link">add_candidates</a></span><span class="op">(</span><span class="va">lacerta_models</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="co"># determine how to combine their predictions</span></span>
<span>  <span class="fu"><a href="https://stacks.tidymodels.org/reference/blend_predictions.html" class="external-link">blend_predictions</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="co"># fit the candidates with non-zero weights (i.e.non-zero stacking coefficients)</span></span>
<span>  <span class="fu"><a href="https://stacks.tidymodels.org/reference/fit_members.html" class="external-link">fit_members</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/autoplot.html" class="external-link">autoplot</a></span><span class="op">(</span><span class="va">lacerta_stack</span>, type <span class="op">=</span> <span class="st">"weights"</span><span class="op">)</span></span></code></pre></div>
<p><img src="a2_tidymodels_additions_files/figure-html/build_stack-1.png" width="576"></p>
<p>We can see that three versions of the SVM and one of the random
forests were selected; the stacking coefficients give an indication of
the weight each model carries within the ensemble. We can now use the
ensemble to make predictions about the testing data:</p>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">lacerta_testing</span> <span class="op">&lt;-</span> <span class="fu">testing</span><span class="op">(</span><span class="va">lacerta_initial</span><span class="op">)</span></span>
<span></span>
<span><span class="va">lacerta_test_pred</span> <span class="op">&lt;-</span></span>
<span>  <span class="va">lacerta_testing</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/bind_cols.html" class="external-link">bind_cols</a></span><span class="op">(</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/predict.html" class="external-link">predict</a></span><span class="op">(</span><span class="va">lacerta_stack</span>, <span class="va">.</span>, type <span class="op">=</span> <span class="st">"prob"</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>And look at the goodness of fit using some commonly used sdm metrics.
Note that <code>sdm_metric_set</code> is first invoked to generate a
function (with empty <code>()</code>) that is then used on the data.</p>
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/sdm_metric_set.html">sdm_metric_set</a></span><span class="op">(</span><span class="op">)</span><span class="op">(</span>data <span class="op">=</span> <span class="va">lacerta_test_pred</span>, truth <span class="op">=</span> <span class="va">class</span>, <span class="va">.pred_presence</span><span class="op">)</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 3 × 3</span></span></span>
<span><span class="co">#&gt;   .metric    .estimator .estimate</span></span>
<span><span class="co">#&gt;   <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>      <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>          <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">1</span> boyce_cont binary         0.803</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">2</span> roc_auc    binary         0.992</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">3</span> tss_max    binary         0.906</span></span></code></pre></div>
<p>We can now make predictions with this stacked ensemble. We start by
extracting the climate for the variables of interest</p>
<div class="sourceCode" id="cb20"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://evolecolgroup.github.io/pastclim/reference/download_dataset.html" class="external-link">download_dataset</a></span><span class="op">(</span><span class="st">"WorldClim_2.1_10m"</span><span class="op">)</span></span>
<span><span class="va">climate_vars</span> <span class="op">&lt;-</span> <span class="va">lacerta_rec_all</span><span class="op">$</span><span class="va">var_info</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">role</span> <span class="op">==</span> <span class="st">"predictor"</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/pull.html" class="external-link">pull</a></span><span class="op">(</span><span class="va">variable</span><span class="op">)</span></span>
<span></span>
<span><span class="va">climate_present</span> <span class="op">&lt;-</span> <span class="fu">pastclim</span><span class="fu">::</span><span class="fu"><a href="https://evolecolgroup.github.io/pastclim/reference/region_slice.html" class="external-link">region_slice</a></span><span class="op">(</span></span>
<span>  time_ce <span class="op">=</span> <span class="fl">1985</span>,</span>
<span>  bio_variables <span class="op">=</span> <span class="va">climate_vars</span>,</span>
<span>  data <span class="op">=</span> <span class="st">"WorldClim_2.1_10m"</span>,</span>
<span>  crop <span class="op">=</span> <span class="va">iberia_poly</span></span>
<span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb21"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">prediction_present</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/predict_raster.html">predict_raster</a></span><span class="op">(</span><span class="va">lacerta_stack</span>, <span class="va">climate_present</span>,</span>
<span>  type <span class="op">=</span> <span class="st">"prob"</span></span>
<span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://dieghernan.github.io/tidyterra/" class="external-link">tidyterra</a></span><span class="op">)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Attaching package: 'tidyterra'</span></span>
<span><span class="co">#&gt; The following object is masked from 'package:stats':</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;     filter</span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://dieghernan.github.io/tidyterra/reference/geom_spatraster.html" class="external-link">geom_spatraster</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">prediction_present</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>fill <span class="op">=</span> <span class="va">.pred_presence</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://dieghernan.github.io/tidyterra/reference/scale_terrain.html" class="external-link">scale_fill_terrain_c</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="co"># plot presences used in the model</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggsf.html" class="external-link">geom_sf</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">lacerta_thin</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">class</span> <span class="op">==</span> <span class="st">"presence"</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p><img src="a2_tidymodels_additions_files/figure-html/plot_present-1.png" width="576"></p>
</div>
  </main><aside class="col-md-3"><nav id="toc"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p></p>
<p>Developed by Michela Leonardi, Margherita Colucci, Andrea Manica.</p>
</div>

<div class="pkgdown-footer-right">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.7.</p>
</div>

    </footer>
</div>

  

  

  </body>
</html>
