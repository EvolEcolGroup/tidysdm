<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Examples of additional tidymodels features • tidysdm</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.4.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.4.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Examples of additional tidymodels features">
<meta name="robots" content="noindex">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">tidysdm</a>

    <small class="nav-text text-danger me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="In-development version">0.9.6.9002</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles">
<li><a class="dropdown-item" href="../articles/a0_tidysdm_overview.html">tidysdm overview</a></li>
    <li><a class="dropdown-item" href="../articles/a1_palaeodata_application.html">Application with palaeodata</a></li>
    <li><a class="dropdown-item" href="../articles/a2_tidymodels_additions.html">Examples of additional tidymodels features</a></li>
    <li><a class="dropdown-item" href="../articles/a3_troubleshooting.html">Troubleshooting models that fail</a></li>
  </ul>
</li>
<li class="nav-item"><a class="nav-link" href="../news/index.html">Changelog</a></li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/EvolEcolGroup/tidysdm/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="../logo.png" class="logo" alt=""><h1>Examples of additional tidymodels features</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/EvolEcolGroup/tidysdm/blob/dev/vignettes/a2_tidymodels_additions.Rmd" class="external-link"><code>vignettes/a2_tidymodels_additions.Rmd</code></a></small>
      <div class="d-none name"><code>a2_tidymodels_additions.Rmd</code></div>
    </div>

    
    
<p>In this vignette, we illustrate how a number of features from
<code>tidymodels</code> can be used to enhance a conventional SDM
pipeline. We recommend users first become familiar with
<code>tidymodels</code>; there are a number of excellent tutorials (both
introductory and advanced) on its dedicated <a href="https://www.tidymodels.org/" class="external-link">website</a> We reuse the example on
the Iberian lizard that we used in the <a href="https://evolecolgroup.github.io/tidysdm/articles/a0_tidysdm_overview.html"><code>tidysdm</code>
overview</a> article.</p>
<div class="section level2">
<h2 id="exploring-models-with-dalex">Exploring models with <code>DALEX</code><a class="anchor" aria-label="anchor" href="#exploring-models-with-dalex"></a>
</h2>
<p>An issue with machine learning algorithms is that it is not easy to
understand the role of different variables in giving the final
prediction. A number of packages have been created to explore and
explain the behaviour of ML algorithms, such as those used in
<code>tidysdm</code>. In the <a href="https://evolecolgroup.github.io/tidysdm/articles/a0_tidysdm_overview.html"><code>tidysdm</code>
overview</a> article, we illustrated how to use <code>recipes</code> to
create profiles.</p>
<p>Here we demonstrate how to use <a href="https://modeloriented.github.io/DALEX/" class="external-link">DALEX</a>, an excellent
package that has methods to deal with <code>tidymodels</code>.
<code>tidysdm</code> contains additional functions that allow use to use
the DALEX functions directly on <code>tidysdm</code> ensembles.</p>
<p>We will use a simple ensemble that we built in the overview
vignette.</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/EvolEcolGroup/tidysdm" class="external-link">tidysdm</a></span><span class="op">)</span></span>
<span><span class="co">#&gt; Loading required package: tidymodels</span></span>
<span><span class="co">#&gt; ── <span style="font-weight: bold;">Attaching packages</span> ────────────────────────────────────── tidymodels 1.2.0 ──</span></span>
<span><span class="co">#&gt; <span style="color: #00BB00;">✔</span> <span style="color: #0000BB;">broom       </span> 1.0.7     <span style="color: #00BB00;">✔</span> <span style="color: #0000BB;">recipes     </span> 1.1.0</span></span>
<span><span class="co">#&gt; <span style="color: #00BB00;">✔</span> <span style="color: #0000BB;">dials       </span> 1.3.0     <span style="color: #00BB00;">✔</span> <span style="color: #0000BB;">rsample     </span> 1.2.1</span></span>
<span><span class="co">#&gt; <span style="color: #00BB00;">✔</span> <span style="color: #0000BB;">dplyr       </span> 1.1.4     <span style="color: #00BB00;">✔</span> <span style="color: #0000BB;">tibble      </span> 3.2.1</span></span>
<span><span class="co">#&gt; <span style="color: #00BB00;">✔</span> <span style="color: #0000BB;">ggplot2     </span> 3.5.1     <span style="color: #00BB00;">✔</span> <span style="color: #0000BB;">tidyr       </span> 1.3.1</span></span>
<span><span class="co">#&gt; <span style="color: #00BB00;">✔</span> <span style="color: #0000BB;">infer       </span> 1.0.7     <span style="color: #00BB00;">✔</span> <span style="color: #0000BB;">tune        </span> 1.2.1</span></span>
<span><span class="co">#&gt; <span style="color: #00BB00;">✔</span> <span style="color: #0000BB;">modeldata   </span> 1.4.0     <span style="color: #00BB00;">✔</span> <span style="color: #0000BB;">workflows   </span> 1.1.4</span></span>
<span><span class="co">#&gt; <span style="color: #00BB00;">✔</span> <span style="color: #0000BB;">parsnip     </span> 1.2.1     <span style="color: #00BB00;">✔</span> <span style="color: #0000BB;">workflowsets</span> 1.1.0</span></span>
<span><span class="co">#&gt; <span style="color: #00BB00;">✔</span> <span style="color: #0000BB;">purrr       </span> 1.0.2     <span style="color: #00BB00;">✔</span> <span style="color: #0000BB;">yardstick   </span> 1.3.1</span></span>
<span><span class="co">#&gt; ── <span style="font-weight: bold;">Conflicts</span> ───────────────────────────────────────── tidymodels_conflicts() ──</span></span>
<span><span class="co">#&gt; <span style="color: #BB0000;">✖</span> <span style="color: #0000BB;">purrr</span>::<span style="color: #00BB00;">discard()</span> masks <span style="color: #0000BB;">scales</span>::discard()</span></span>
<span><span class="co">#&gt; <span style="color: #BB0000;">✖</span> <span style="color: #0000BB;">dplyr</span>::<span style="color: #00BB00;">filter()</span>  masks <span style="color: #0000BB;">stats</span>::filter()</span></span>
<span><span class="co">#&gt; <span style="color: #BB0000;">✖</span> <span style="color: #0000BB;">dplyr</span>::<span style="color: #00BB00;">lag()</span>     masks <span style="color: #0000BB;">stats</span>::lag()</span></span>
<span><span class="co">#&gt; <span style="color: #BB0000;">✖</span> <span style="color: #0000BB;">recipes</span>::<span style="color: #00BB00;">step()</span>  masks <span style="color: #0000BB;">stats</span>::step()</span></span>
<span><span class="co">#&gt; <span style="color: #0000BB;">•</span> Search for functions across packages at <span style="color: #00BB00;">https://www.tidymodels.org/find/</span></span></span>
<span><span class="co">#&gt; Loading required package: spatialsample</span></span>
<span><span class="va">lacerta_ensemble</span></span>
<span><span class="co">#&gt; A simple_ensemble of models</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Members:</span></span>
<span><span class="co">#&gt; <span style="color: #00BBBB;">•</span> default_glm</span></span>
<span><span class="co">#&gt; <span style="color: #00BBBB;">•</span> default_rf</span></span>
<span><span class="co">#&gt; <span style="color: #00BBBB;">•</span> default_gbm</span></span>
<span><span class="co">#&gt; <span style="color: #00BBBB;">•</span> default_maxent</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Available metrics:</span></span>
<span><span class="co">#&gt; <span style="color: #00BBBB;">•</span> boyce_cont</span></span>
<span><span class="co">#&gt; <span style="color: #00BBBB;">•</span> roc_auc</span></span>
<span><span class="co">#&gt; <span style="color: #00BBBB;">•</span> tss_max</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Metric used to tune workflows:</span></span>
<span><span class="co">#&gt; <span style="color: #00BBBB;">•</span> boyce_cont</span></span></code></pre></div>
<p>The first step in DALEX is to create an explainer object, which can
then be queried by different functions in the package, to turn the
explainer into an explanation (following the DALEX lingo). As a first
step, we use the custom function <code>explain_tidysdm</code> to
generate our explainer:</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">explainer_lacerta_ens</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/explain_tidysdm.html">explain_tidysdm</a></span><span class="op">(</span><span class="va">lacerta_ensemble</span><span class="op">)</span></span>
<span><span class="co">#&gt; Preparation of a new explainer is initiated</span></span>
<span><span class="co">#&gt;   -&gt; model label       :  data.frame  (  default  )</span></span>
<span><span class="co">#&gt;   -&gt; data              :  444  rows  4  cols </span></span>
<span><span class="co">#&gt;   -&gt; data              :  tibble converted into a data.frame </span></span>
<span><span class="co">#&gt;   -&gt; target variable   :  444  values </span></span>
<span><span class="co">#&gt;   -&gt; predict function  :  predict_function </span></span>
<span><span class="co">#&gt;   -&gt; predicted values  :  No value for predict function target column. (  default  )</span></span>
<span><span class="co">#&gt;   -&gt; model_info        :  package tidysdm , ver. 0.9.6.9002 , task classification (  default  ) </span></span>
<span><span class="co">#&gt;   -&gt; model_info        :  type set to  classification </span></span>
<span><span class="co">#&gt;   -&gt; predicted values  :  numerical, min =  0.01490969 , mean =  0.2861937 , max =  0.7169324  </span></span>
<span><span class="co">#&gt;   -&gt; residual function :  difference between y and yhat (  default  )</span></span>
<span><span class="co">#&gt;   -&gt; residuals         :  numerical, min =  -0.6465921 , mean =  -0.03619367 , max =  0.7891973  </span></span>
<span><span class="co">#&gt;   A new explainer has been created!</span></span></code></pre></div>
<p>Now that we have our explainer, we can explore variable importance
for the ensemble:</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://modeloriented.github.io/DALEX/" class="external-link">DALEX</a></span><span class="op">)</span></span>
<span><span class="co">#&gt; Welcome to DALEX (version: 2.4.3).</span></span>
<span><span class="co">#&gt; Find examples and detailed introduction at: http://ema.drwhy.ai/</span></span>
<span><span class="co">#&gt; Additional features will be available after installation of: ggpubr.</span></span>
<span><span class="co">#&gt; Use 'install_dependencies()' to get all suggested dependencies</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Attaching package: 'DALEX'</span></span>
<span><span class="co">#&gt; The following object is masked from 'package:dplyr':</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;     explain</span></span>
<span><span class="va">vip_ensemble</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://modeloriented.github.io/DALEX/reference/model_parts.html" class="external-link">model_parts</a></span><span class="op">(</span>explainer <span class="op">=</span> <span class="va">explainer_lacerta_ens</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rspatial.github.io/terra/reference/plot.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">vip_ensemble</span><span class="op">)</span></span></code></pre></div>
<p><img src="a2_tidymodels_additions_files/figure-html/vip-1.png" width="576"></p>
<p>Or generate partial dependency plots for a given variable
(e.g. bio05):</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">pdp_bio05</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://modeloriented.github.io/DALEX/reference/model_profile.html" class="external-link">model_profile</a></span><span class="op">(</span><span class="va">explainer_lacerta_ens</span>, N <span class="op">=</span> <span class="fl">500</span>, variables <span class="op">=</span> <span class="st">"bio05"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rspatial.github.io/terra/reference/plot.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">pdp_bio05</span><span class="op">)</span></span></code></pre></div>
<p><img src="a2_tidymodels_additions_files/figure-html/pdp-1.png" width="576"></p>
<p>There are many other functions in DALEX that can be applied to the
explainer to further explore the behaviour of the model; see several
tutorial on <a href="https://modeloriented.github.io/DALEX/" class="external-link uri">https://modeloriented.github.io/DALEX/</a></p>
<p>It is also possible to explore the individual models that make up the
ensemble:</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">explainer_list</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/explain_tidysdm.html">explain_tidysdm</a></span><span class="op">(</span><span class="fu">tidysdm</span><span class="fu">::</span><span class="va"><a href="../reference/lacerta_ensemble.html">lacerta_ensemble</a></span>, by_workflow <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="co">#&gt; Preparation of a new explainer is initiated</span></span>
<span><span class="co">#&gt;   -&gt; model label       :  default_glm </span></span>
<span><span class="co">#&gt;   -&gt; data              :  444  rows  4  cols </span></span>
<span><span class="co">#&gt;   -&gt; data              :  tibble converted into a data.frame </span></span>
<span><span class="co">#&gt;   -&gt; target variable   :  444  values </span></span>
<span><span class="co">#&gt;   -&gt; predict function  :  yhat.workflow  will be used (  default  )</span></span>
<span><span class="co">#&gt;   -&gt; predicted values  :  No value for predict function target column. (  default  )</span></span>
<span><span class="co">#&gt;   -&gt; model_info        :  package tidymodels , ver. 1.2.0 , task classification (  default  ) </span></span>
<span><span class="co">#&gt;   -&gt; model_info        :  type set to  classification </span></span>
<span><span class="co">#&gt;   -&gt; predicted values  :  numerical, min =  0.2280177 , mean =  0.75 , max =  0.9854359  </span></span>
<span><span class="co">#&gt;   -&gt; residual function :  difference between y and yhat (  default  )</span></span>
<span><span class="co">#&gt;   -&gt; residuals         :  numerical, min =  -0.9096205 , mean =  5.395921e-12 , max =  0.7719823  </span></span>
<span><span class="co">#&gt;   A new explainer has been created!  </span></span>
<span><span class="co">#&gt; Preparation of a new explainer is initiated</span></span>
<span><span class="co">#&gt;   -&gt; model label       :  default_rf </span></span>
<span><span class="co">#&gt;   -&gt; data              :  444  rows  4  cols </span></span>
<span><span class="co">#&gt;   -&gt; data              :  tibble converted into a data.frame </span></span>
<span><span class="co">#&gt;   -&gt; target variable   :  444  values </span></span>
<span><span class="co">#&gt;   -&gt; predict function  :  yhat.workflow  will be used (  default  )</span></span>
<span><span class="co">#&gt;   -&gt; predicted values  :  No value for predict function target column. (  default  )</span></span>
<span><span class="co">#&gt;   -&gt; model_info        :  package tidymodels , ver. 1.2.0 , task classification (  default  ) </span></span>
<span><span class="co">#&gt;   -&gt; model_info        :  type set to  classification </span></span>
<span><span class="co">#&gt;   -&gt; predicted values  :  numerical, min =  0.1315421 , mean =  0.7480648 , max =  1  </span></span>
<span><span class="co">#&gt;   -&gt; residual function :  difference between y and yhat (  default  )</span></span>
<span><span class="co">#&gt;   -&gt; residuals         :  numerical, min =  -0.6878921 , mean =  0.001935171 , max =  0.5870619  </span></span>
<span><span class="co">#&gt;   A new explainer has been created!  </span></span>
<span><span class="co">#&gt; Preparation of a new explainer is initiated</span></span>
<span><span class="co">#&gt;   -&gt; model label       :  default_gbm </span></span>
<span><span class="co">#&gt;   -&gt; data              :  444  rows  4  cols </span></span>
<span><span class="co">#&gt;   -&gt; data              :  tibble converted into a data.frame </span></span>
<span><span class="co">#&gt;   -&gt; target variable   :  444  values </span></span>
<span><span class="co">#&gt;   -&gt; predict function  :  yhat.workflow  will be used (  default  )</span></span>
<span><span class="co">#&gt;   -&gt; predicted values  :  No value for predict function target column. (  default  )</span></span>
<span><span class="co">#&gt;   -&gt; model_info        :  package tidymodels , ver. 1.2.0 , task classification (  default  ) </span></span>
<span><span class="co">#&gt;   -&gt; model_info        :  type set to  classification </span></span>
<span><span class="co">#&gt;   -&gt; predicted values  :  numerical, min =  0.3390188 , mean =  0.7314788 , max =  0.9632964  </span></span>
<span><span class="co">#&gt;   -&gt; residual function :  difference between y and yhat (  default  )</span></span>
<span><span class="co">#&gt;   -&gt; residuals         :  numerical, min =  -0.9268645 , mean =  0.01852121 , max =  0.6280424  </span></span>
<span><span class="co">#&gt;   A new explainer has been created!  </span></span>
<span><span class="co">#&gt; Preparation of a new explainer is initiated</span></span>
<span><span class="co">#&gt;   -&gt; model label       :  default_maxent </span></span>
<span><span class="co">#&gt;   -&gt; data              :  444  rows  4  cols </span></span>
<span><span class="co">#&gt;   -&gt; data              :  tibble converted into a data.frame </span></span>
<span><span class="co">#&gt;   -&gt; target variable   :  444  values </span></span>
<span><span class="co">#&gt;   -&gt; predict function  :  yhat.workflow  will be used (  default  )</span></span>
<span><span class="co">#&gt;   -&gt; predicted values  :  No value for predict function target column. (  default  )</span></span>
<span><span class="co">#&gt;   -&gt; model_info        :  package tidymodels , ver. 1.2.0 , task classification (  default  ) </span></span>
<span><span class="co">#&gt;   -&gt; model_info        :  type set to  classification </span></span>
<span><span class="co">#&gt;   -&gt; predicted values  :  numerical, min =  0.1095764 , mean =  0.6256817 , max =  0.9960248  </span></span>
<span><span class="co">#&gt;   -&gt; residual function :  difference between y and yhat (  default  )</span></span>
<span><span class="co">#&gt;   -&gt; residuals         :  numerical, min =  -0.8207859 , mean =  0.1243183 , max =  0.8904236  </span></span>
<span><span class="co">#&gt;   A new explainer has been created!</span></span></code></pre></div>
<p>The resulting list can be then used to build lists of explanations,
which can then be plotted.</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">profile_list</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="va">explainer_list</span>, <span class="va">model_profile</span>,</span>
<span>  N <span class="op">=</span> <span class="fl">500</span>,</span>
<span>  variables <span class="op">=</span> <span class="st">"bio05"</span></span>
<span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rspatial.github.io/terra/reference/plot.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">profile_list</span><span class="op">)</span></span></code></pre></div>
<p><img src="a2_tidymodels_additions_files/figure-html/profile-1.png" width="576"></p>
</div>
<div class="section level2">
<h2 id="the-initial-split">The initial split<a class="anchor" aria-label="anchor" href="#the-initial-split"></a>
</h2>
<p>The standard approach in <code>tidymodels</code> is to make an
initial split of the data into a test and a training set. We will use
retain 20% of the data (1/5) for the testing set, and use the rest for
training.</p>
<p>We start by loading a set of presences and absences and their
associated climate, analogous to the one that we generated in the <a href="https://evolecolgroup.github.io/tidysdm/articles/a0_tidysdm_overview.html"><code>tidysdm</code>
overview</a> article:</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/EvolEcolGroup/tidysdm" class="external-link">tidysdm</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://r-spatial.github.io/sf/" class="external-link">sf</a></span><span class="op">)</span></span>
<span><span class="co">#&gt; Linking to GEOS 3.10.2, GDAL 3.4.1, PROJ 8.2.1; sf_use_s2() is TRUE</span></span>
<span><span class="va">lacerta_thin</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rspatial.github.io/terra/reference/serialize.html" class="external-link">readRDS</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/system.file.html" class="external-link">system.file</a></span><span class="op">(</span><span class="st">"extdata/lacerta_climate_sf.RDS"</span>,</span>
<span>  package <span class="op">=</span> <span class="st">"tidysdm"</span></span>
<span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>We then use <code>spatial_initial_split</code> to do the split, using
a <code>spatial_block_cv</code> scheme to partition the data:</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">1005</span><span class="op">)</span></span>
<span><span class="va">lacerta_initial</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/spatial_initial_split.html">spatial_initial_split</a></span><span class="op">(</span><span class="va">lacerta_thin</span>,</span>
<span>  prop <span class="op">=</span> <span class="fl">1</span> <span class="op">/</span> <span class="fl">5</span>, <span class="va">spatial_block_cv</span></span>
<span><span class="op">)</span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/autoplot.html" class="external-link">autoplot</a></span><span class="op">(</span><span class="va">lacerta_initial</span><span class="op">)</span></span></code></pre></div>
<p><img src="a2_tidymodels_additions_files/figure-html/initial_split-1.png" width="576"></p>
<p>And check the balance of presences vs pseudoabsences:</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/check_splits_balance.html">check_splits_balance</a></span><span class="op">(</span><span class="va">lacerta_initial</span>, <span class="va">class</span><span class="op">)</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 1 × 4</span></span></span>
<span><span class="co">#&gt;   presence_test pseudoabs_test presence_train pseudoabs_train</span></span>
<span><span class="co">#&gt;           <span style="color: #949494; font-style: italic;">&lt;int&gt;</span>          <span style="color: #949494; font-style: italic;">&lt;int&gt;</span>          <span style="color: #949494; font-style: italic;">&lt;int&gt;</span>           <span style="color: #949494; font-style: italic;">&lt;int&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">1</span>            88            267             25              72</span></span></code></pre></div>
<p>We can now extract the training set from our
<code>lacerta_initial</code> split, and sample folds to set up cross
validation (note that we set the <code>cellsize</code> and
<code>offset</code> based on the full dataset,
<code>lacerta_thin</code>; this allows us to use the same grid we used
for the <code>initial_split</code>).</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">1005</span><span class="op">)</span></span>
<span><span class="va">lacerta_training</span> <span class="op">&lt;-</span> <span class="fu">training</span><span class="op">(</span><span class="va">lacerta_initial</span><span class="op">)</span></span>
<span><span class="va">lacerta_cv</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://spatialsample.tidymodels.org/reference/spatial_block_cv.html" class="external-link">spatial_block_cv</a></span><span class="op">(</span><span class="va">lacerta_training</span>,</span>
<span>  v <span class="op">=</span> <span class="fl">5</span>,</span>
<span>  cellsize <span class="op">=</span> <span class="fu"><a href="../reference/grid_cellsize.html">grid_cellsize</a></span><span class="op">(</span><span class="va">lacerta_thin</span><span class="op">)</span>,</span>
<span>  offset <span class="op">=</span> <span class="fu"><a href="../reference/grid_offset.html">grid_offset</a></span><span class="op">(</span><span class="va">lacerta_thin</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/autoplot.html" class="external-link">autoplot</a></span><span class="op">(</span><span class="va">lacerta_cv</span><span class="op">)</span></span></code></pre></div>
<p><img src="a2_tidymodels_additions_files/figure-html/training_cv-1.png" width="576"></p>
<p>And check the balance in the dataset:</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/check_splits_balance.html">check_splits_balance</a></span><span class="op">(</span><span class="va">lacerta_cv</span>, <span class="va">class</span><span class="op">)</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 5 × 4</span></span></span>
<span><span class="co">#&gt;   presence_assessment pseudoabs_assessment presence_analysis pseudoabs_analysis</span></span>
<span><span class="co">#&gt;                 <span style="color: #949494; font-style: italic;">&lt;int&gt;</span>                <span style="color: #949494; font-style: italic;">&lt;int&gt;</span>             <span style="color: #949494; font-style: italic;">&lt;int&gt;</span>              <span style="color: #949494; font-style: italic;">&lt;int&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">1</span>                  74                  197                14                 70</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">2</span>                  59                  225                29                 42</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">3</span>                  73                  220                15                 47</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">4</span>                  76                  209                12                 58</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">5</span>                  70                  218                18                 49</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="different-recipes-for-certain-models">Different recipes for certain models<a class="anchor" aria-label="anchor" href="#different-recipes-for-certain-models"></a>
</h2>
<p>Only certain type of models (e.g. glm, svm) struggle with correlated
variables; other algorithms, such as random forests, can handle
correlated variables. So, we will create two recipes, one with all
variables, and one only with the variables that are uncorrelated:</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">lacerta_rec_all</span> <span class="op">&lt;-</span> <span class="fu">recipe</span><span class="op">(</span><span class="va">lacerta_thin</span>, formula <span class="op">=</span> <span class="va">class</span> <span class="op">~</span> <span class="va">.</span><span class="op">)</span></span>
<span><span class="va">lacerta_rec_uncor</span> <span class="op">&lt;-</span> <span class="va">lacerta_rec_all</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu">step_rm</span><span class="op">(</span><span class="fu"><a href="https://tidyselect.r-lib.org/reference/all_of.html" class="external-link">all_of</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span></span>
<span>    <span class="st">"bio01"</span>, <span class="st">"bio02"</span>, <span class="st">"bio03"</span>, <span class="st">"bio04"</span>, <span class="st">"bio07"</span>, <span class="st">"bio08"</span>,</span>
<span>    <span class="st">"bio09"</span>, <span class="st">"bio10"</span>, <span class="st">"bio11"</span>, <span class="st">"bio12"</span>, <span class="st">"bio14"</span>, <span class="st">"bio16"</span>,</span>
<span>    <span class="st">"bio17"</span>, <span class="st">"bio18"</span>, <span class="st">"bio19"</span>, <span class="st">"altitude"</span></span>
<span>  <span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">lacerta_rec_uncor</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; <span style="color: #00BBBB;">──</span> <span style="font-weight: bold;">Recipe</span> <span style="color: #00BBBB;">──────────────────────────────────────────────────────────────────────</span></span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; ── Inputs</span></span>
<span><span class="co">#&gt; Number of variables by role</span></span>
<span><span class="co">#&gt; outcome:    1</span></span>
<span><span class="co">#&gt; predictor: 20</span></span>
<span><span class="co">#&gt; coords:     2</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; ── Operations</span></span>
<span><span class="co">#&gt; <span style="color: #00BBBB;">•</span> Variables removed: <span style="color: #0000BB;">all_of(c("bio01", "bio02", "bio03", "bio04", "bio07",</span></span></span>
<span><span class="co">#&gt;   <span style="color: #0000BB;">"bio08", "bio09", "bio10", "bio11", "bio12", "bio14", "bio16", "bio17",</span></span></span>
<span><span class="co">#&gt;   <span style="color: #0000BB;">"bio18", "bio19", "altitude"))</span></span></span></code></pre></div>
<p>And now use these two recipes in a <code>workflowset</code> (we will
keep it small for computational time), selecting the appropriate recipe
for each model. We will include a model (polynomial support vector
machines, or SVM) which does not have a wrapper in <code>tidysdm</code>
for creating a model specification. However, we can use a standard model
spec from <code>yardstick</code>:</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">lacerta_models</span> <span class="op">&lt;-</span></span>
<span>  <span class="co"># create the workflow_set</span></span>
<span>  <span class="fu">workflow_set</span><span class="op">(</span></span>
<span>    preproc <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>      uncor <span class="op">=</span> <span class="va">lacerta_rec_uncor</span>, <span class="co"># recipe for the glm</span></span>
<span>      all <span class="op">=</span> <span class="va">lacerta_rec_all</span>, <span class="co"># recipe for the random forest</span></span>
<span>      all <span class="op">=</span> <span class="va">lacerta_rec_uncor</span> <span class="co"># recipe for svm</span></span>
<span>    <span class="op">)</span>,</span>
<span>    models <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>      <span class="co"># the standard glm specs</span></span>
<span>      glm <span class="op">=</span> <span class="fu"><a href="../reference/sdm_spec_glm.html">sdm_spec_glm</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>      <span class="co"># rf specs with tuning</span></span>
<span>      rf <span class="op">=</span> <span class="fu"><a href="../reference/sdm_spec_rand_forest.html">sdm_spec_rf</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>      <span class="co"># svm specs with tuning</span></span>
<span>      svm <span class="op">=</span> <span class="fu">parsnip</span><span class="fu">::</span><span class="fu"><a href="https://parsnip.tidymodels.org/reference/svm_poly.html" class="external-link">svm_poly</a></span><span class="op">(</span></span>
<span>        cost <span class="op">=</span> <span class="fu">tune</span><span class="op">(</span><span class="op">)</span>,</span>
<span>        degree <span class="op">=</span> <span class="fu">tune</span><span class="op">(</span><span class="op">)</span></span>
<span>      <span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>        <span class="fu">parsnip</span><span class="fu">::</span><span class="fu"><a href="https://parsnip.tidymodels.org/reference/set_engine.html" class="external-link">set_engine</a></span><span class="op">(</span><span class="st">"kernlab"</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>        <span class="fu">parsnip</span><span class="fu">::</span><span class="fu"><a href="https://parsnip.tidymodels.org/reference/set_args.html" class="external-link">set_mode</a></span><span class="op">(</span><span class="st">"classification"</span><span class="op">)</span></span>
<span>    <span class="op">)</span>,</span>
<span>    <span class="co"># make all combinations of preproc and models,</span></span>
<span>    cross <span class="op">=</span> <span class="cn">FALSE</span></span>
<span>  <span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="co"># tweak controls to store information needed later to create the ensemble</span></span>
<span>  <span class="co"># note that we use the bayes version as we will use a Bayes search (see later)</span></span>
<span>  <span class="fu">option_add</span><span class="op">(</span>control <span class="op">=</span> <span class="fu">stacks</span><span class="fu">::</span><span class="fu"><a href="https://stacks.tidymodels.org/reference/control_stack.html" class="external-link">control_stack_bayes</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>We can now use the block CV folds to tune and assess the models. Note
that there are multiple tuning approaches, besides the standard grid
method. Here we will use <code>tune_bayes</code> from the
<code>tune</code> package (see its help page to see how a Gaussian
Process model is used to choose parameter combinations).</p>
<p>This tuning method (as opposed to use a standard grid) does not allow
for hyper-parameters with unknown limits, but <code>mtry</code> for
random forest is undefined as its upper range depends on the number of
variables in the dataset. So, before tuning, we need to finalise
<code>mtry</code> by informing the set dials with the actual data:</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">rf_param</span> <span class="op">&lt;-</span> <span class="va">lacerta_models</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="co"># extract the rf workflow</span></span>
<span>  <span class="fu">extract_workflow</span><span class="op">(</span><span class="st">"all_rf"</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="co"># extract its parameters dials (used to tune)</span></span>
<span>  <span class="fu">extract_parameter_set_dials</span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="co"># give it the predictors to finalize mtry</span></span>
<span>  <span class="fu">finalize</span><span class="op">(</span>x <span class="op">=</span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_geometry.html" class="external-link">st_drop_geometry</a></span><span class="op">(</span><span class="va">lacerta_thin</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="op">-</span><span class="va">class</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># now update the workflowset with the new parameter info</span></span>
<span><span class="va">lacerta_models</span> <span class="op">&lt;-</span> <span class="va">lacerta_models</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu">option_add</span><span class="op">(</span>param_info <span class="op">=</span> <span class="va">rf_param</span>, id <span class="op">=</span> <span class="st">"all_rf"</span><span class="op">)</span></span></code></pre></div>
<p>And now we can tune the models:</p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">1234567</span><span class="op">)</span></span>
<span><span class="va">lacerta_models</span> <span class="op">&lt;-</span></span>
<span>  <span class="va">lacerta_models</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu">workflow_map</span><span class="op">(</span><span class="st">"tune_bayes"</span>,</span>
<span>    resamples <span class="op">=</span> <span class="va">lacerta_cv</span>, initial <span class="op">=</span> <span class="fl">8</span>,</span>
<span>    metrics <span class="op">=</span> <span class="fu"><a href="../reference/sdm_metric_set.html">sdm_metric_set</a></span><span class="op">(</span><span class="op">)</span>, verbose <span class="op">=</span> <span class="cn">TRUE</span></span>
<span>  <span class="op">)</span></span>
<span><span class="co">#&gt; <span style="color: #0000BB;">i</span>  <span style="color: #000000;">No tuning parameters. `fit_resamples()` will be attempted</span></span></span>
<span><span class="co">#&gt; <span style="color: #0000BB;">i</span> <span style="color: #000000;">1 of 3 resampling: uncor_glm</span></span></span>
<span><span class="co">#&gt; <span style="color: #00BB00;">✔</span> <span style="color: #000000;">1 of 3 resampling: uncor_glm (398ms)</span></span></span>
<span><span class="co">#&gt; <span style="color: #0000BB;">i</span> <span style="color: #000000;">2 of 3 tuning:     all_rf</span></span></span>
<span><span class="co">#&gt; <span style="color: #BBBB00;">!</span> No improvement for 10 iterations; returning current results.</span></span>
<span><span class="co">#&gt; <span style="color: #00BB00;">✔</span> <span style="color: #000000;">2 of 3 tuning:     all_rf (16.8s)</span></span></span>
<span><span class="co">#&gt; <span style="color: #0000BB;">i</span> <span style="color: #000000;">3 of 3 tuning:     all_svm</span></span></span>
<span><span class="co">#&gt; <span style="color: #00BB00;">✔</span> <span style="color: #000000;">3 of 3 tuning:     all_svm (21.3s)</span></span></span></code></pre></div>
<p>We can have a look at the performance of our models with:</p>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/autoplot.html" class="external-link">autoplot</a></span><span class="op">(</span><span class="va">lacerta_models</span><span class="op">)</span></span></code></pre></div>
<p><img src="a2_tidymodels_additions_files/figure-html/unnamed-chunk-9-1.png" width="700"></p>
</div>
<div class="section level2">
<h2 id="stack-ensembles">Stack ensembles<a class="anchor" aria-label="anchor" href="#stack-ensembles"></a>
</h2>
<p>Instead of building a simple ensemble with the best version of each
model type, we can build a stack ensemble, as implemented in the package
<code>stacks</code>. Stacking uses a meta-learning algorithm to learn
how to best combine multiple models, including multiple versions of the
same algorithm with different hyper-parameters.</p>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://stacks.tidymodels.org/" class="external-link">stacks</a></span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">1005</span><span class="op">)</span></span>
<span><span class="va">lacerta_stack</span> <span class="op">&lt;-</span></span>
<span>  <span class="co"># initialize the stack</span></span>
<span>  <span class="fu"><a href="https://stacks.tidymodels.org/reference/stacks.html" class="external-link">stacks</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="co"># add candidate members</span></span>
<span>  <span class="fu"><a href="https://stacks.tidymodels.org/reference/add_candidates.html" class="external-link">add_candidates</a></span><span class="op">(</span><span class="va">lacerta_models</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="co"># determine how to combine their predictions</span></span>
<span>  <span class="fu"><a href="https://stacks.tidymodels.org/reference/blend_predictions.html" class="external-link">blend_predictions</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="co"># fit the candidates with non-zero weights (i.e.non-zero stacking coefficients)</span></span>
<span>  <span class="fu"><a href="https://stacks.tidymodels.org/reference/fit_members.html" class="external-link">fit_members</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/autoplot.html" class="external-link">autoplot</a></span><span class="op">(</span><span class="va">lacerta_stack</span>, type <span class="op">=</span> <span class="st">"weights"</span><span class="op">)</span></span></code></pre></div>
<p><img src="a2_tidymodels_additions_files/figure-html/build_stack-1.png" width="576"></p>
<p>We can see that three versions of the SVM and one of the random
forests were selected; the stacking coefficients give an indication of
the weight each model carries within the ensemble. We can now use the
ensemble to make predictions about the testing data:</p>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">lacerta_testing</span> <span class="op">&lt;-</span> <span class="fu">testing</span><span class="op">(</span><span class="va">lacerta_initial</span><span class="op">)</span></span>
<span></span>
<span><span class="va">lacerta_test_pred</span> <span class="op">&lt;-</span></span>
<span>  <span class="va">lacerta_testing</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/bind_cols.html" class="external-link">bind_cols</a></span><span class="op">(</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/predict.html" class="external-link">predict</a></span><span class="op">(</span><span class="va">lacerta_stack</span>, <span class="va">.</span>, type <span class="op">=</span> <span class="st">"prob"</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>And look at the goodness of fit using some commonly used sdm metrics.
Note that <code>sdm_metric_set</code> is first invoked to generate a
function (with empty <code>()</code>) that is then used on the data.</p>
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/sdm_metric_set.html">sdm_metric_set</a></span><span class="op">(</span><span class="op">)</span><span class="op">(</span>data <span class="op">=</span> <span class="va">lacerta_test_pred</span>, truth <span class="op">=</span> <span class="va">class</span>, <span class="va">.pred_presence</span><span class="op">)</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 3 × 3</span></span></span>
<span><span class="co">#&gt;   .metric    .estimator .estimate</span></span>
<span><span class="co">#&gt;   <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>      <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>          <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">1</span> boyce_cont binary         0.853</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">2</span> roc_auc    binary         0.986</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">3</span> tss_max    binary         0.92</span></span></code></pre></div>
<p>We can now make predictions with this stacked ensemble. We start by
extracting the climate for the variables of interest</p>
<div class="sourceCode" id="cb20"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://evolecolgroup.github.io/pastclim/reference/download_dataset.html" class="external-link">download_dataset</a></span><span class="op">(</span><span class="st">"WorldClim_2.1_10m"</span><span class="op">)</span></span>
<span><span class="va">climate_vars</span> <span class="op">&lt;-</span> <span class="va">lacerta_rec_all</span><span class="op">$</span><span class="va">var_info</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">role</span> <span class="op">==</span> <span class="st">"predictor"</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/pull.html" class="external-link">pull</a></span><span class="op">(</span><span class="va">variable</span><span class="op">)</span></span>
<span></span>
<span><span class="va">climate_present</span> <span class="op">&lt;-</span> <span class="fu">pastclim</span><span class="fu">::</span><span class="fu"><a href="https://evolecolgroup.github.io/pastclim/reference/region_slice.html" class="external-link">region_slice</a></span><span class="op">(</span></span>
<span>  time_ce <span class="op">=</span> <span class="fl">1985</span>,</span>
<span>  bio_variables <span class="op">=</span> <span class="va">climate_vars</span>,</span>
<span>  data <span class="op">=</span> <span class="st">"WorldClim_2.1_10m"</span>,</span>
<span>  crop <span class="op">=</span> <span class="va">iberia_poly</span></span>
<span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb21"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">prediction_present</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/predict_raster.html">predict_raster</a></span><span class="op">(</span><span class="va">lacerta_stack</span>, <span class="va">climate_present</span>,</span>
<span>  type <span class="op">=</span> <span class="st">"prob"</span></span>
<span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://dieghernan.github.io/tidyterra/" class="external-link">tidyterra</a></span><span class="op">)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Attaching package: 'tidyterra'</span></span>
<span><span class="co">#&gt; The following object is masked from 'package:stats':</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;     filter</span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://dieghernan.github.io/tidyterra/reference/geom_spatraster.html" class="external-link">geom_spatraster</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">prediction_present</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>fill <span class="op">=</span> <span class="va">.pred_presence</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://dieghernan.github.io/tidyterra/reference/scale_terrain.html" class="external-link">scale_fill_terrain_c</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="co"># plot presences used in the model</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggsf.html" class="external-link">geom_sf</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">lacerta_thin</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">class</span> <span class="op">==</span> <span class="st">"presence"</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p><img src="a2_tidymodels_additions_files/figure-html/plot_present-1.png" width="576"></p>
</div>
<div class="section level2">
<h2 id="using-multi-level-factors-as-predictors">Using multi-level factors as predictors<a class="anchor" aria-label="anchor" href="#using-multi-level-factors-as-predictors"></a>
</h2>
<p>Most machine learning algorithms do not natively use multilevel
factors as predictors. The solution is to create dummy variables, which
are binary variables that represent the levels of the factor. In
<code>tidymodels</code>, this is done using the <code>step_dummy</code>
function.</p>
<p>Let’s create a factor variable with 3 levels based on altitude.</p>
<div class="sourceCode" id="cb22"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/EvolEcolGroup/tidysdm" class="external-link">tidysdm</a></span><span class="op">)</span></span>
<span><span class="co"># load the dataset</span></span>
<span><span class="va">lacerta_thin</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rspatial.github.io/terra/reference/serialize.html" class="external-link">readRDS</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/system.file.html" class="external-link">system.file</a></span><span class="op">(</span><span class="st">"extdata/lacerta_climate_sf.RDS"</span>,</span>
<span>  package <span class="op">=</span> <span class="st">"tidysdm"</span></span>
<span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co"># create a topography variable with 3 levels based on altitude</span></span>
<span><span class="va">lacerta_thin</span><span class="op">$</span><span class="va">topography</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cut.html" class="external-link">cut</a></span><span class="op">(</span><span class="va">lacerta_thin</span><span class="op">$</span><span class="va">altitude</span>,</span>
<span>                breaks <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="op">-</span><span class="cn">Inf</span>, <span class="fl">200</span>, <span class="fl">800</span>, <span class="cn">Inf</span><span class="op">)</span>,</span>
<span>                labels <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"plains"</span>, <span class="st">"hills"</span>, <span class="st">"mountains"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/table.html" class="external-link">table</a></span><span class="op">(</span><span class="va">lacerta_thin</span><span class="op">$</span><span class="va">topography</span><span class="op">)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;    plains     hills mountains </span></span>
<span><span class="co">#&gt;        82       233       137</span></span></code></pre></div>
<p>We then create the recipe by adding a step to create dummy variables
for the <code>topography</code> variable.</p>
<div class="sourceCode" id="cb23"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># subset to variable of interest</span></span>
<span><span class="va">lacerta_thin</span> <span class="op">&lt;-</span> <span class="va">lacerta_thin</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="va">class</span>, <span class="va">bio05</span>, <span class="va">bio06</span>, <span class="va">bio12</span>, <span class="va">bio15</span>, <span class="va">topography</span><span class="op">)</span></span>
<span></span>
<span><span class="va">lacerta_rec</span> <span class="op">&lt;-</span> <span class="fu">recipe</span><span class="op">(</span><span class="va">lacerta_thin</span>, formula <span class="op">=</span> <span class="va">class</span> <span class="op">~</span> <span class="va">.</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu">step_dummy</span><span class="op">(</span><span class="va">topography</span><span class="op">)</span></span>
<span><span class="va">lacerta_rec</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; <span style="color: #00BBBB;">──</span> <span style="font-weight: bold;">Recipe</span> <span style="color: #00BBBB;">──────────────────────────────────────────────────────────────────────</span></span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; ── Inputs</span></span>
<span><span class="co">#&gt; Number of variables by role</span></span>
<span><span class="co">#&gt; outcome:   1</span></span>
<span><span class="co">#&gt; predictor: 5</span></span>
<span><span class="co">#&gt; coords:    2</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; ── Operations</span></span>
<span><span class="co">#&gt; <span style="color: #00BBBB;">•</span> Dummy variables from: <span style="color: #0000BB;">topography</span></span></span></code></pre></div>
<p>Let’s us see what this does:</p>
<div class="sourceCode" id="cb24"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">lacerta_prep</span> <span class="op">&lt;-</span> <span class="fu">prep</span><span class="op">(</span><span class="va">lacerta_rec</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rspatial.github.io/terra/reference/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">lacerta_prep</span><span class="op">)</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 9 × 4</span></span></span>
<span><span class="co">#&gt;   variable             type      role      source  </span></span>
<span><span class="co">#&gt;   <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>                <span style="color: #949494; font-style: italic;">&lt;list&gt;</span>    <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>     <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>   </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">1</span> bio05                <span style="color: #949494;">&lt;chr [2]&gt;</span> predictor original</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">2</span> bio06                <span style="color: #949494;">&lt;chr [2]&gt;</span> predictor original</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">3</span> bio12                <span style="color: #949494;">&lt;chr [2]&gt;</span> predictor original</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">4</span> bio15                <span style="color: #949494;">&lt;chr [2]&gt;</span> predictor original</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">5</span> X                    <span style="color: #949494;">&lt;chr [2]&gt;</span> coords    original</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">6</span> Y                    <span style="color: #949494;">&lt;chr [2]&gt;</span> coords    original</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">7</span> class                <span style="color: #949494;">&lt;chr [3]&gt;</span> outcome   original</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">8</span> topography_hills     <span style="color: #949494;">&lt;chr [2]&gt;</span> predictor derived </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">9</span> topography_mountains <span style="color: #949494;">&lt;chr [2]&gt;</span> predictor derived</span></span></code></pre></div>
<p>We have added two “derived” variables, <em>topography_hills</em> and
<em>topography_mountains</em>, which are binary variables that allow us
to code topography (with plains being used as the reference level, which
is coded by both hills and mountains being 0 for a given location). We
can look at the first few rows of the data to see the new variables by
baking the recipe:</p>
<div class="sourceCode" id="cb25"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">lacerta_bake</span> <span class="op">&lt;-</span> <span class="fu">bake</span><span class="op">(</span><span class="va">lacerta_prep</span>, new_data <span class="op">=</span> <span class="va">lacerta_thin</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://pillar.r-lib.org/reference/glimpse.html" class="external-link">glimpse</a></span><span class="op">(</span><span class="va">lacerta_bake</span><span class="op">)</span></span>
<span><span class="co">#&gt; Rows: 452</span></span>
<span><span class="co">#&gt; Columns: 9</span></span>
<span><span class="co">#&gt; $ bio05                <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> 30.50350, 25.28050, 23.67800, 29.68875, 26.34075,…</span></span>
<span><span class="co">#&gt; $ bio06                <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> 1.477000, 3.631750, 0.789500, 6.048750, 1.869000,…</span></span>
<span><span class="co">#&gt; $ bio12                <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> 596, 1490, 1395, 729, 1324, 1409, 1260, 1390, 116…</span></span>
<span><span class="co">#&gt; $ bio15                <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> 50.59533, 50.07437, 47.24211, 58.88199, 51.62960,…</span></span>
<span><span class="co">#&gt; $ X                    <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> -5.394226, -8.374844, -7.886102, -8.231414, -7.17…</span></span>
<span><span class="co">#&gt; $ Y                    <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> 39.48495, 41.97207, 41.89992, 39.49710, 41.78401,…</span></span>
<span><span class="co">#&gt; $ class                <span style="color: #949494; font-style: italic;">&lt;fct&gt;</span> presence, presence, presence, presence, presence,…</span></span>
<span><span class="co">#&gt; $ topography_hills     <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> 1, 1, 0, 0, 1, 1, 1, 1, 1, 0, 0, 1, 1, 1, 1, 0, 0…</span></span>
<span><span class="co">#&gt; $ topography_mountains <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 1…</span></span></code></pre></div>
<p>We can now run the sdm as usual:</p>
<div class="sourceCode" id="cb26"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># define the models</span></span>
<span><span class="va">lacerta_models</span> <span class="op">&lt;-</span></span>
<span>  <span class="co"># create the workflow_set</span></span>
<span>  <span class="fu">workflow_set</span><span class="op">(</span></span>
<span>    preproc <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>default <span class="op">=</span> <span class="va">lacerta_rec</span><span class="op">)</span>,</span>
<span>    models <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>      <span class="co"># the standard glm specs</span></span>
<span>      glm <span class="op">=</span> <span class="fu"><a href="../reference/sdm_spec_glm.html">sdm_spec_glm</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>      <span class="co"># rf specs with tuning</span></span>
<span>      rf <span class="op">=</span> <span class="fu"><a href="../reference/sdm_spec_rand_forest.html">sdm_spec_rf</a></span><span class="op">(</span><span class="op">)</span></span>
<span>    <span class="op">)</span>,</span>
<span>    <span class="co"># make all combinations of preproc and models,</span></span>
<span>    cross <span class="op">=</span> <span class="cn">TRUE</span></span>
<span>  <span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="co"># tweak controls to store information needed later to create the ensemble</span></span>
<span>  <span class="fu">option_add</span><span class="op">(</span>control <span class="op">=</span> <span class="fu"><a href="../reference/control_ensemble.html">control_ensemble_grid</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co"># tune</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">100</span><span class="op">)</span></span>
<span><span class="va">lacerta_cv</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://spatialsample.tidymodels.org/reference/spatial_block_cv.html" class="external-link">spatial_block_cv</a></span><span class="op">(</span><span class="va">lacerta_thin</span>, v <span class="op">=</span> <span class="fl">3</span><span class="op">)</span></span>
<span><span class="va">lacerta_models</span> <span class="op">&lt;-</span></span>
<span>  <span class="va">lacerta_models</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu">workflow_map</span><span class="op">(</span><span class="st">"tune_grid"</span>,</span>
<span>    resamples <span class="op">=</span> <span class="va">lacerta_cv</span>, grid <span class="op">=</span> <span class="fl">3</span>,</span>
<span>    metrics <span class="op">=</span> <span class="fu"><a href="../reference/sdm_metric_set.html">sdm_metric_set</a></span><span class="op">(</span><span class="op">)</span>, verbose <span class="op">=</span> <span class="cn">TRUE</span></span>
<span>  <span class="op">)</span></span>
<span><span class="co">#&gt; <span style="color: #0000BB;">i</span>  <span style="color: #000000;">No tuning parameters. `fit_resamples()` will be attempted</span></span></span>
<span><span class="co">#&gt; <span style="color: #0000BB;">i</span> <span style="color: #000000;">1 of 2 resampling: default_glm</span></span></span>
<span><span class="co">#&gt; <span style="color: #00BB00;">✔</span> <span style="color: #000000;">1 of 2 resampling: default_glm (208ms)</span></span></span>
<span><span class="co">#&gt; <span style="color: #0000BB;">i</span> <span style="color: #000000;">2 of 2 tuning:     default_rf</span></span></span>
<span><span class="co">#&gt; <span style="color: #0000BB;">i</span> <span style="color: #000000;">Creating pre-processing data to finalize unknown parameter: mtry</span></span></span>
<span><span class="co">#&gt; <span style="color: #00BB00;">✔</span> <span style="color: #000000;">2 of 2 tuning:     default_rf (1s)</span></span></span>
<span><span class="co"># fit the ensemble</span></span>
<span><span class="va">lacerta_ensemble</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/simple_ensemble.html">simple_ensemble</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="../reference/add_member.html">add_member</a></span><span class="op">(</span><span class="va">lacerta_models</span>, metric <span class="op">=</span> <span class="st">"boyce_cont"</span><span class="op">)</span></span></code></pre></div>
<p>We can now verify that the dummy variables were used by extracting
the model fit from one of the models in the ensemble:</p>
<div class="sourceCode" id="cb27"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">lacerta_ensemble</span><span class="op">$</span><span class="va">workflow</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> <span class="fu">extract_fit_parsnip</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">#&gt; parsnip model object</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Call:  stats::glm(formula = ..y ~ ., family = stats::binomial, data = data)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Coefficients:</span></span>
<span><span class="co">#&gt;          (Intercept)                 bio05                 bio06  </span></span>
<span><span class="co">#&gt;            -6.920024              0.635493             -0.334427  </span></span>
<span><span class="co">#&gt;                bio12                 bio15      topography_hills  </span></span>
<span><span class="co">#&gt;            -0.002505             -0.113106             -1.851098  </span></span>
<span><span class="co">#&gt; topography_mountains  </span></span>
<span><span class="co">#&gt;            -2.531259  </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Degrees of Freedom: 451 Total (i.e. Null);  445 Residual</span></span>
<span><span class="co">#&gt; Null Deviance:       508.4 </span></span>
<span><span class="co">#&gt; Residual Deviance: 189.5     AIC: 203.5</span></span></code></pre></div>
<p>We can see that we have coefficients for <em>topography_hills</em>
and <em>topography_mountains</em>.</p>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by Michela Leonardi, Margherita Colucci, Andrea Vittorio Pozzi, Eleanor M.L. Scerri, Andrea Manica.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.1.</p>
</div>

    </footer>
</div>





  </body>
</html>
